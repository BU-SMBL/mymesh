
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mymesh.register &#8212; MyMesh vdev Manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/mymesh.css?v=1e1bb860" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=3ce10a4d"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=4ea706d9"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/mymesh/register';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="dev" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/mymesh_logo.png" class="logo__image only-light" alt="MyMesh vdev Manual - Home"/>
    <img src="../../_static/mymesh_logo.png" class="logo__image only-dark pst-js-only" alt="MyMesh vdev Manual - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../theory.html">
    Theory Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/BU-SMBL/mymesh" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../theory.html">
    Theory Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/BU-SMBL/mymesh" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../mymesh.html" class="nav-link">mymesh</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">mymesh.register</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for mymesh.register</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Created on Fri Oct 14 13:16:00 2024</span>
<span class="c1"># @author: toj</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tools for registering or aligning point clouds, meshes, and images.</span>

<span class="sd">See also: :ref:`theory_register`</span>

<span class="sd">.. currentmodule:: mymesh.register</span>

<span class="sd">Registration</span>
<span class="sd">============</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: submodules/</span>

<span class="sd">    AxisAlignPoints</span>
<span class="sd">    AxisAlignImage</span>
<span class="sd">    Point2Point</span>
<span class="sd">    Mesh2Mesh</span>
<span class="sd">    Image2Image</span>
<span class="sd">    ICP</span>

<span class="sd">Transformation</span>
<span class="sd">==============</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: submodules/</span>

<span class="sd">    transform_points</span>
<span class="sd">    transform_image</span>
<span class="sd">    rotation2d</span>
<span class="sd">    rotation</span>
<span class="sd">    translation2d</span>
<span class="sd">    translation</span>
<span class="sd">    rigid2d</span>
<span class="sd">    rigid</span>
<span class="sd">    similarity2d</span>
<span class="sd">    similarity</span>
<span class="sd">    affine2d</span>
<span class="sd">    affine</span>
<span class="sd">    T2d</span>
<span class="sd">    R2d</span>
<span class="sd">    S2d</span>
<span class="sd">    Sh2d</span>
<span class="sd">    T3d</span>
<span class="sd">    R3d</span>
<span class="sd">    S3d</span>
<span class="sd">    Sh3d</span>

<span class="sd">Similarity Metrics</span>
<span class="sd">==================</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: submodules/</span>

<span class="sd">    dice</span>
<span class="sd">    jaccard</span>
<span class="sd">    mutual_information</span>
<span class="sd">    hausdorff</span>
<span class="sd">    closest_point_MSE</span>
<span class="sd">    symmetric_closest_point_MSE</span>

<span class="sd">Optimization</span>
<span class="sd">============</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: submodules/</span>

<span class="sd">    optimize</span>

<span class="sd">Visualization</span>
<span class="sd">=============</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: submodules/</span>

<span class="sd">    ImageOverlay</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">copy</span><span class="o">,</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mymesh</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>

<div class="viewcode-block" id="AxisAlignPoints">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.AxisAlignPoints.html#mymesh.register.AxisAlignPoints">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">AxisAlignPoints</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">axis_order</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;MVBB&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Align an point cloud to the x, y, z axes. This works by identifying</span>
<span class="sd">    the minimum volume bounding box (see :func:`~mymesh.utils.MVBB`) and </span>
<span class="sd">    aligning that box to the principal axes, so point clouds representing </span>
<span class="sd">    rounded objects with ambiguous orientation may be oriented</span>
<span class="sd">    seemingly-arbitrarily. The center of the object (defined as the centroid</span>
<span class="sd">    of the MVBB) will be preserved in the alignment unless a different center</span>
<span class="sd">    is specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points : array_like</span>
<span class="sd">        Array of point coordinates (shape=(n,3))</span>
<span class="sd">    axis_order : array_like, optional</span>
<span class="sd">        Orientation of the aligned object in terms of the lengths of each side</span>
<span class="sd">        of the object, by default [0,1,2]. The first axis will correspond to the</span>
<span class="sd">        shortest side of the object and the last index to the longest side. For </span>
<span class="sd">        example, with [0,1,2], the longest side will be aligned with the z (2) </span>
<span class="sd">        axis, and the shortest will be aligned with the x (0) axis. Must be a </span>
<span class="sd">        combination of 0, 1, and 2.</span>
<span class="sd">    center : array_like or NoneType, optional</span>
<span class="sd">        If provided, coordinates `[x,y,z]` of where to place the center</span>
<span class="sd">        of the bounding box of the object after transformation. If `None`, the </span>
<span class="sd">        center of the oriented points will be the center of the original points,</span>
<span class="sd">        by default None.</span>
<span class="sd">    return_transformed : bool, optional</span>
<span class="sd">        Option to return the transformed point cloud, by default True</span>
<span class="sd">    return_transform : bool, optional</span>
<span class="sd">        Option to return the transformation matrix, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transformed : np.ndarray</span>
<span class="sd">        Array of point coordinates transformed to be aligned to the axes</span>
<span class="sd">    transform : np.ndarray, optional</span>
<span class="sd">        Affine transformation matrix (shape=(4,4)) to transform `points` to </span>
<span class="sd">        `transformed` (`transformed=(transform@points.T).T`). Only returned if</span>
<span class="sd">        `return_transform = True`.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :context: close-figs</span>

<span class="sd">        import mymesh</span>
<span class="sd">        import numpy as np</span>

<span class="sd">        # Load the stanford bunny</span>
<span class="sd">        m = mymesh.demo_mesh(&#39;bunny&#39;) </span>

<span class="sd">        # Perform an arbitrary rotation transformation to the mesh</span>
<span class="sd">        points = mymesh.register.transform_points(m.NodeCoords, mymesh.register.rotation([np.pi/6, -np.pi/6, np.pi/6]))</span>

<span class="sd">        transformed_points = mymesh.register.AxisAlignPoints(points)</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">        :include-source: False</span>
<span class="sd">        </span>
<span class="sd">        mp = mymesh.mesh(points)</span>
<span class="sd">        mp.NodeData[&#39;label&#39;] = np.zeros(mp.NNode)</span>
<span class="sd">        m_aligned = mymesh.mesh(transformed_points)</span>
<span class="sd">        m_aligned.NodeData[&#39;label&#39;] = np.ones(m_aligned.NNode)</span>

<span class="sd">        mp.plot(scalars=&#39;label&#39;, show_colorbar=False, view=&#39;-xy&#39;, show_points=True, hide_free_nodes=False, clim=(0,1))</span>

<span class="sd">        m_aligned.plot(scalars=&#39;label&#39;, show_colorbar=False, view=&#39;x-y&#39;, show_points=True, hide_free_nodes=False, clim=(0,1))</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">assert</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis_order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">axis_order</span><span class="p">))),</span> <span class="s1">&#39;axis_order must contain only 0, 1, and 2.&#39;</span>
    
    <span class="n">original_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mvbb&#39;</span><span class="p">:</span>
        <span class="n">mvbb</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">MVBB</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">return_matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Modify rotation to specified axis_order</span>
        <span class="n">mvbb_t</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">mvbb</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">side_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mvbb_t</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mvbb_t</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">current_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">side_lengths</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">current_order</span> <span class="o">==</span> <span class="n">axis_order</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">current_order</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis_order</span><span class="p">)])</span>
            <span class="n">perpendicular_transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">perpendicular_transform</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If the determinant is negative, it would cause a reflection, inverting a column fixes this</span>
                <span class="n">perpendicular_transform</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">perpendicular_transform</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">perpendicular_transform</span><span class="nd">@mat</span>
            <span class="c1"># mvbb_t = transform_points(mvbb, mat)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pca&#39;</span><span class="p">:</span>
        
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">((</span><span class="n">points</span><span class="o">-</span><span class="n">original_center</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">vals</span><span class="p">)[</span><span class="n">axis_order</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">vecs</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">vecs</span>
        
    <span class="c1"># Restore center after rotation</span>
    
    <span class="n">transformed_center</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">original_center</span><span class="p">),</span> <span class="n">mat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">original_center</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;If provided, center must be be a three element list or array.&#39;</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
    <span class="n">center_shift</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">transformed_center</span>
    
    <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">transform</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
    <span class="n">transform</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_shift</span>
    
    <span class="k">if</span> <span class="n">return_transformed</span><span class="p">:</span>
        <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_transform</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transformed</span><span class="p">,</span> <span class="n">transform</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transformed</span>
    <span class="k">elif</span> <span class="n">return_transform</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">transform</span>
    <span class="k">return</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">AxisAlignMesh</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">axis_order</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;MVBB&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Align an mesh to the x, y, z axes based on its coordinates. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M : mymesh.mesh</span>
<span class="sd">        Input mesh</span>
<span class="sd">    axis_order : array_like, optional</span>
<span class="sd">        Orientation of the aligned object in terms of the lengths of each side</span>
<span class="sd">        of the object, by default [0,1,2]. The first axis will correspond to the</span>
<span class="sd">        shortest side of the object and the last index to the longest side. For </span>
<span class="sd">        example, with [0,1,2], the longest side will be aligned with the z (2) </span>
<span class="sd">        axis, and the shortest will be aligned with the x (0) axis. Must be a </span>
<span class="sd">        combination of 0, 1, and 2.</span>
<span class="sd">    center : array_like or NoneType, optional</span>
<span class="sd">        If provided, coordinates `[x,y,z]` of where to place the center</span>
<span class="sd">        of the bounding box of the object after transformation. If `None`, the </span>
<span class="sd">        center of the oriented mesh will be the center of the original mesh,</span>
<span class="sd">        by default None.</span>
<span class="sd">    return_transformed : bool, optional</span>
<span class="sd">        Option to return the transformed mesh, by default True</span>
<span class="sd">    return_transform : bool, optional</span>
<span class="sd">        Option to return the transformation matrix, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transformed : mymesh.mesh</span>
<span class="sd">        Mesh transformed to be aligned with the axes.</span>
<span class="sd">    transform : np.ndarray, optional</span>
<span class="sd">        Affine transformation matrix (shape=(4,4)) to transform `points` to </span>
<span class="sd">        `transformed` (`transformed=(transform@points.T).T`). Only returned if</span>
<span class="sd">        `return_transform = True`.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="k">if</span> <span class="n">return_transformed</span><span class="p">:</span>
        <span class="n">transformed</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">transformed</span><span class="o">.</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">AxisAlignPoints</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_order</span><span class="o">=</span><span class="n">axis_order</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_transform</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transformed</span><span class="p">,</span> <span class="n">transform</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transformed</span>
    <span class="k">elif</span> <span class="n">return_transform</span><span class="p">:</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">AxisAlignPoints</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis_order</span><span class="o">=</span><span class="n">axis_order</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transform</span>
    <span class="k">return</span>

<div class="viewcode-block" id="AxisAlignImage">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.AxisAlignImage.html#mymesh.register.AxisAlignImage">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">AxisAlignImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis_order</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Align an object in an image to the x, y, z axes. This works by identifying</span>
<span class="sd">    the minimum volume bounding box (see :func:`~mymesh.utils.MVBB`) and </span>
<span class="sd">    aligning that box to the principal axes, so objects with rounded objects </span>
<span class="sd">    with ambiguous orientation may be oriented seemingly-arbitrarily. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : array_like</span>
<span class="sd">        3 dimensional image array of the image</span>
<span class="sd">    axis_order : array_like, optional</span>
<span class="sd">        Orientation of the aligned image in terms of the lengths of each side</span>
<span class="sd">        of the object, by default [0,1,2]. The first axis will correspond to the</span>
<span class="sd">        shortest side of the object and the last index to the longest side. For </span>
<span class="sd">        example, with [0,1,2], the longest side will be aligned with the z (2) </span>
<span class="sd">        axis, and the shortest will be aligned with the x (0) axis. Must be a </span>
<span class="sd">        combination of 0, 1, and 2.</span>
<span class="sd">        Threshold value used to binarize the image for identification of the</span>
<span class="sd">        object. If the image is already binarized, this is not necessary, by </span>
<span class="sd">        default None.</span>
<span class="sd">    center : str, array_like, or NoneType, optional</span>
<span class="sd">        Location of the center of the object after axis alignment, by default</span>
<span class="sd">        &#39;image&#39;. Options are:</span>

<span class="sd">        - &#39;image&#39;: Centers the object at the center of the image</span>
<span class="sd">        - &#39;object&#39;: Keeps the center of the object in place</span>
<span class="sd">        - </span>
<span class="sd">            `[x,y,z]`: A three element list or array specifies the location, in</span>
<span class="sd">            voxels, of where to place to place the center of the bounding box </span>
<span class="sd">            of the object after transformation. </span>

<span class="sd">    scale : float, optional</span>
<span class="sd">        Scale factor used to resample the image to either reduce (scale &lt; 1) </span>
<span class="sd">        or increase (scale &gt; 1) the size/resolution of the image used for</span>
<span class="sd">        alignment, by default 1. The returned image will still be of the </span>
<span class="sd">        original resolution.</span>
<span class="sd">    interpolation_order : int, optional</span>
<span class="sd">        Interpolation order used in image scaling and transformation (see </span>
<span class="sd">        `scipy.ndimage.zoom &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.zoom.html#scipy.ndimage.zoom&gt;`_)</span>
<span class="sd">        and scaling (if used). Must be an integer in the range 0-5. Lower order</span>
<span class="sd">        is more efficient at the cost of quality. By default, 1. </span>
<span class="sd">    transform_args : dict, optional</span>
<span class="sd">        Optional input arguments passed to `scipy.ndimage.affine_transform &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.affine_transform.html&gt;`_, by </span>
<span class="sd">        default `dict(mode=&#39;constant&#39;, order=interpolation_order)`.</span>
<span class="sd">    return_transform : bool, optional</span>
<span class="sd">        Option to return the transformation matrix as well as the transformed</span>
<span class="sd">        point cloud, by default False</span>
<span class="sd">    </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transformed : np.ndarray</span>
<span class="sd">        Array of point coordinates transformed to be aligned to the axes</span>
<span class="sd">    transform : np.ndarray, optional</span>
<span class="sd">        Affine transformation matrix (shape=(4,4)) to transform `img` to </span>
<span class="sd">        `transformed`. Only returned if</span>
<span class="sd">        `return_transform = True`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis_order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">axis_order</span><span class="p">))),</span> <span class="s1">&#39;axis_order must contain only 0, 1, and 2.&#39;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    
    <span class="c1"># Process transform_args input</span>
    <span class="k">if</span> <span class="n">transform_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">transform_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transform_args</span><span class="p">:</span>
            <span class="n">transform_args</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;constant&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transform_args</span><span class="p">:</span>
            <span class="n">transform_args</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolation_order</span>
            
    <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">transform_args</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolation_order</span>
        <span class="n">imgS</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imgS</span> <span class="o">=</span> <span class="n">img</span>
    <span class="c1"># Process threshold input</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This option intended for already binarized images (flexible enough to accomodate different types of binarization, e.g. True/False, 1/0, 255/0, ...)</span>
        <span class="c1"># If the image is not binary, this will assume the midpoint of the range of values as the threshold</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">binarized</span> <span class="o">=</span> <span class="n">imgS</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    
    
    
    <span class="c1"># Process center input</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;If provided as coordinates, center must be be a three element list or array.&#39;</span>

    
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binarized</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="c1"># Dividing by scale puts points back to the original coordinate system (`center` uses the original image so is consistent with this coordinate system)</span>

    <span class="n">axis_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axis_order</span><span class="p">)[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># Flip axes to correspond to image axis order (z,y,x)</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">AxisAlignPoints</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">axis_order</span><span class="o">=</span><span class="n">axis_order</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># maxs = np.max(transformed_points,axis=0)</span>
    <span class="c1"># mins = np.min(transformed_points,axis=0)</span>
    <span class="c1"># if np.any(maxs &gt; np.shape(img)) or np.any(mins &lt; 0):</span>
    <span class="c1">#     warnings.warn(&#39;Some of the object is being moved out of frame. Consider padding the image, adjusting center, or changing the axis_order.&#39;)</span>
    
    <span class="k">if</span> <span class="n">return_transformed</span><span class="p">:</span>
        <span class="n">transformed</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">transform_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_transform</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transformed</span><span class="p">,</span> <span class="n">transform</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transformed</span>
    <span class="k">elif</span> <span class="n">return_transform</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">transform</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="Point2Point">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.Point2Point.html#mymesh.register.Point2Point">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Point2Point</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;rigid&#39;</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;icp&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icp&#39;</span><span class="p">,</span> <span class="n">decimation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prealign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Point cloud-to-point cloud alignment. points2 will be aligned to points1.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points1 : array_like</span>
<span class="sd">        Fixed points that points2 will be registered to</span>
<span class="sd">    points2 : array_like</span>
<span class="sd">        Moving points that will be registered to points1</span>
<span class="sd">    T0 : array_like or NoneType, optional</span>
<span class="sd">        Initial transformation to apply to points2, by default, None. This can </span>
<span class="sd">        serve as an &#39;initial guess&#39; of the alignment.</span>
<span class="sd">    bounds : array_like or NoneType, optional</span>
<span class="sd">        Optimization bounds, formatted as [(min,max),...] for each parameter.</span>
<span class="sd">        If None, bounds are selected that should cover most possible </span>
<span class="sd">        transformations, by default None. Not used by all optimizers.</span>
<span class="sd">    transform : str, optional</span>
<span class="sd">        Transformation model, by default &#39;rigid&#39;.</span>

<span class="sd">        - &#39;rigid&#39;: translations and rotations</span>
<span class="sd">        - &#39;similarity: translations, rotations, and uniform scaling</span>
<span class="sd">        - &#39;affine&#39;: translations, rotations, triaxial scaling, shearing</span>

<span class="sd">    metric : str, optional</span>
<span class="sd">        Similarity metric to compare the two point clouds, by default &#39;closest_point_MSE&#39;</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        Optimization method, by default &#39;direct&#39;. See </span>
<span class="sd">        :func:`~mymesh.register.optimize` for details.</span>
<span class="sd">    decimation : float, optional</span>
<span class="sd">        Scalar factor in the range (0,1] used to reduce the size of the point set,</span>
<span class="sd">        by default 1. ``decimation = 1`` uses the full point sets, numbers less </span>
<span class="sd">        than one will reduce the size of both point sets by that factor by </span>
<span class="sd">        randomly selecting a set of points to use. For example ``decimation = 0.5``</span>
<span class="sd">        will use only half of the points of each set. A random seed of 0 is used</span>
<span class="sd">        for repeatable results. Note that if verbose=True, the final score</span>
<span class="sd">        will be reported for the full point set, not the decimated point set</span>
<span class="sd">        used during optimization.</span>
<span class="sd">    prealign : bool, optional</span>
<span class="sd">        Option to pre-align point sets based on axis-alignment. Disregarded if T0 is provided, by default True. </span>
<span class="sd">    transform_args : dict, optional</span>
<span class="sd">        Additional arguments for the chosen transformation model, by default {}.</span>
<span class="sd">        See :func:`~mymesh.register.rigid`, :func:`~mymesh.register.similarity`,</span>
<span class="sd">        or :func:`~mymesh.register.affine`.</span>
<span class="sd">    optimizer_args : dict, optional</span>
<span class="sd">        Additional arguments for the chosen optimizer, by default None. See </span>
<span class="sd">        :func:`~mymesh.register.optimize` for details.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbosity, by default True. If True, iteration progress will be printed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_points : np.ndarray</span>
<span class="sd">        Transformed coordinate array of points2 registered to points1.</span>
<span class="sd">    T : np.ndarray</span>
<span class="sd">        Affine transformation matrix (shape=(4,4)) to transform points2 to new_points.</span>
<span class="sd">        :code:`new_points = transform_points(points2, T)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># if T0 is not None:</span>
    <span class="c1">#     points2T0 = transform_points(points2, T0)</span>
    <span class="c1"># else:</span>
    <span class="k">if</span> <span class="n">prealign</span><span class="p">:</span>
        <span class="n">T0a</span> <span class="o">=</span> <span class="n">AxisAlignPoints</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">T0b</span> <span class="o">=</span> <span class="n">AxisAlignPoints</span><span class="p">(</span><span class="n">points2</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">T0a</span><span class="p">)</span> <span class="o">@</span> <span class="n">T0b</span>
        <span class="c1"># points2T0 = transform_points(points2, T0)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     T0 = np.eye(np.shape(points2)[1] + 1)</span>
            <span class="c1"># points2T0 = points2</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">decimation</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">idx1</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points1</span><span class="p">)</span><span class="o">*</span><span class="n">decimation</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points2</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span><span class="o">*</span><span class="n">decimation</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ref_points</span> <span class="o">=</span> <span class="n">points1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
        <span class="n">moving_points</span> <span class="o">=</span> <span class="n">points2</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;decimation must be a scalar value in the range (0,1], not </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">decimation</span><span class="p">)</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span><span class="p">:</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rigid&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rigid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-10</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">]),</span>
                <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">]),</span>
                <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------&#39;</span><span class="p">)</span>          
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;similarity&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">similarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-10</span>
            <span class="n">xbounds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
            <span class="n">ybounds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
            <span class="n">zbounds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">xbounds</span><span class="p">,</span>
                <span class="n">ybounds</span><span class="p">,</span>
                <span class="n">zbounds</span><span class="p">,</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma |        s |&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------|&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;affine&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">affine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-10</span>
            <span class="n">xbounds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
            <span class="n">ybounds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
            <span class="n">zbounds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">xbounds</span><span class="p">,</span>
                <span class="n">ybounds</span><span class="p">,</span>
                <span class="n">zbounds</span><span class="p">,</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">xbounds</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">xbounds</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">ybounds</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">ybounds</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">zbounds</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">zbounds</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma |       sx |       sy |       sz |    shxy |&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------|----------|----------|----------&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rigid2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rigid2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-10</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">]),</span>
                <span class="nb">sorted</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">eps</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.|| score||       tx |       ty |    theta &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||------||----------|----------|----------&#39;</span><span class="p">)</span>           
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;similarity2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">similarity2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.|| score||       tx |       ty |    theta |        s &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||------||----------|----------|----------|----------&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;affine2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">affine2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |    theta |       s1 |       s2 |     sh01 |     sh10 &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid transform model. Must be one of: &quot;rigid&quot;, &quot;similarity&quot; or &quot;affine&quot;.&#39;</span><span class="p">)</span>
        
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span> <span class="o">==</span> <span class="n">nparam</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;The provided parameters for x0 don&#39;t match the transformation model (</span><span class="si">{</span><span class="n">transform</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">).&quot;</span>

    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;symmetric_closest_point_mse&#39;</span><span class="p">:</span>
        <span class="n">tree1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">ref_points</span><span class="p">)</span> 
        <span class="c1"># Note: can&#39;t precommute tree for the moving points</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="p">:</span> <span class="n">symmetric_closest_point_MSE</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">tree1</span><span class="o">=</span><span class="n">tree1</span><span class="p">)</span>     
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;hausdorff&#39;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">hausdorff</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;closest_point_mse&#39;</span><span class="p">:</span>
        <span class="n">tree1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">ref_points</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="p">:</span> <span class="n">closest_point_MSE</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">tree1</span><span class="o">=</span><span class="n">tree1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Similarity metric f&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">&quot; is not supported for Point2Point registration.&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">ICP</span><span class="p">(</span><span class="n">ref_points</span><span class="p">,</span> <span class="n">moving_points</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="n">T0</span><span class="p">)</span>
        <span class="n">new_points</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">points2</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">moving_points</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">moving_points</span><span class="p">,</span> <span class="n">T0</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">objective</span><span class="o">.</span><span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:5d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">k</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">pointsT</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">moving_points</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">pointsT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;||</span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s1">11.4f</span><span class="si">}</span><span class="s1">|&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;|</span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="n">objective</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="n">optimizer_args</span><span class="p">)</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">@</span> <span class="n">T0</span>
        <span class="c1"># pointsT = (T@np.column_stack([points2, np.ones(len(points2))]).T).T</span>
        <span class="c1"># new_points = pointsT[:,:-1]</span>
        <span class="n">new_points</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">points2</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">new_points</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------|&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|----------&#39;</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;final||</span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s1">11.4f</span><span class="si">}</span><span class="s1">|&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;|</span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">T</span></div>


<div class="viewcode-block" id="Mesh2Mesh">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.Mesh2Mesh.html#mymesh.register.Mesh2Mesh">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Mesh2Mesh</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;rigid&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;icp&#39;</span><span class="p">,</span> 
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icp&#39;</span><span class="p">,</span> <span class="n">decimation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prealign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">transform_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mesh-to-mesh registration. M2 will be aligned to M1.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M1 : mymesh.mesh</span>
<span class="sd">        Fixed mesh that M2 will be aligned to</span>
<span class="sd">    M2 : mymesh.mesh</span>
<span class="sd">        Moving mesh that will be aligned to M1</span>
<span class="sd">    T0 : array_like or NoneType, optional</span>
<span class="sd">        Initial transformation to apply to M2, by default, None. This can </span>
<span class="sd">        serve as an &#39;initial guess&#39; of the alignment.</span>
<span class="sd">    bounds : array_like or NoneType, optional</span>
<span class="sd">        Optimization bounds, formatted as [(min,max),...] for each parameter.</span>
<span class="sd">        If None, bounds are selected that should cover most possible </span>
<span class="sd">        transformations, by default None. Not used by all optimizers.</span>
<span class="sd">    transform : str, optional</span>
<span class="sd">        Transformation model, by default &#39;rigid&#39;.</span>

<span class="sd">        - &#39;rigid&#39;: translations and rotations</span>
<span class="sd">        - &#39;similarity: translations, rotations, and uniform scaling</span>
<span class="sd">        - &#39;affine&#39;: translations, rotations, triaxial scaling, shearing</span>

<span class="sd">    metric : str, optional</span>
<span class="sd">        Similarity metric to compare the two point clouds, by default &#39;closest_point_MSE&#39;</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        Optimization method, by default &#39;direct&#39;. See </span>
<span class="sd">        :func:`~mymesh.register.optimize` for details.</span>
<span class="sd">    decimation : float, optional</span>
<span class="sd">        Scalar factor in the range (0,1] used to reduce the size of the point set,</span>
<span class="sd">        by default 1. ``decimation = 1`` uses the full point sets, numbers less </span>
<span class="sd">        than one will reduce the size of both point sets by that factor by </span>
<span class="sd">        randomly selecting a set of points to use. For example ``decimation = 0.5``</span>
<span class="sd">        will use only half of the points of each set. A random seed of 0 is used</span>
<span class="sd">        for repeatable results. Note that if verbose=True, the final score</span>
<span class="sd">        will be reported for the full point set, not the decimated point set</span>
<span class="sd">        used during optimization.</span>
<span class="sd">    prealign : bool, optional</span>
<span class="sd">        Option to pre-align meshes based on axis-alignment. Disregarded if T0 is provided, by default True. </span>
<span class="sd">    transform_args : dict, optional</span>
<span class="sd">        Additional arguments for the chosen transformation model, by default {}.</span>
<span class="sd">        See :func:`~mymesh.register.rigid`, :func:`~mymesh.register.similarity`,</span>
<span class="sd">        or :func:`~mymesh.register.affine`.</span>
<span class="sd">    optimizer_args : dict, optional</span>
<span class="sd">        Additional arguments for the chosen optimizer, by default None. See </span>
<span class="sd">        :func:`~mymesh.register.optimize` for details.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbosity, by default True. If True, iteration progress will be printed.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Mnew : mymesh.mesh</span>
<span class="sd">        Transformed transformed mesh registered to M1.</span>
<span class="sd">    T : np.ndarray</span>
<span class="sd">        Affine transformation matrix (shape=(4,4)) to transform M2 to Mnew.</span>
<span class="sd">        :code:`Mnew.NodeCoords = transform_points(M.NodeCoords, T)`</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :context: close-figs</span>

<span class="sd">        import mymesh</span>
<span class="sd">        from mymesh import register</span>
<span class="sd">        import numpy as np</span>

<span class="sd">        # Load two versions of the stanford bunny (fine and coarsened)</span>
<span class="sd">        m1 = mymesh.demo_mesh(&#39;bunny&#39;) </span>
<span class="sd">        m2 = mymesh.demo_mesh(&#39;bunny-res2&#39;)</span>

<span class="sd">        # Perform an arbitrary rotation to the copy</span>
<span class="sd">        R = register.rotation([np.pi/6, -np.pi/6, np.pi/6])</span>
<span class="sd">        m2.NodeCoords = register.transform_points(m2.NodeCoords, R)</span>

<span class="sd">        # Align the two meshes using the iterative closest point (ICP) algorithm</span>
<span class="sd">        m_aligned, T = register.Mesh2Mesh(m1, m2, method=&#39;icp&#39;)</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    .. grid:: 2</span>

<span class="sd">        .. grid-item::</span>

<span class="sd">            .. plot::</span>
<span class="sd">                :context: close-figs</span>
<span class="sd">                :include-source: False</span>

<span class="sd">                mcopy = m1.copy()</span>
<span class="sd">                mcopy.NodeData[&#39;label&#39;] = np.zeros(mcopy.NNode)</span>
<span class="sd">                m2.NodeData[&#39;label&#39;] = np.ones(m2.NNode)</span>
<span class="sd">                mcopy.merge(m2)</span>

<span class="sd">                mcopy.plot(scalars=&#39;label&#39;, show_colorbar=False, view=&#39;xy&#39;)</span>

<span class="sd">        .. grid-item::</span>

<span class="sd">            .. plot::</span>
<span class="sd">                :context: close-figs</span>
<span class="sd">                :include-source: False</span>

<span class="sd">                mcopy = m1.copy()</span>
<span class="sd">                mcopy.NodeData[&#39;label&#39;] = np.zeros(mcopy.NNode)</span>
<span class="sd">                m_aligned.NodeData[&#39;label&#39;] = np.ones(m_aligned.NNode)</span>
<span class="sd">                mcopy.merge(m_aligned)</span>

<span class="sd">                mcopy.plot(scalars=&#39;label&#39;, show_colorbar=False, view=&#39;xy&#39;)</span>
<span class="sd">        </span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">points1</span> <span class="o">=</span> <span class="n">M1</span><span class="o">.</span><span class="n">NodeCoords</span>
    <span class="n">points2</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">NodeCoords</span>

    <span class="n">new_points2</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">Point2Point</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">decimation</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span> <span class="n">prealign</span><span class="o">=</span><span class="n">prealign</span><span class="p">,</span> <span class="n">transform_args</span><span class="o">=</span><span class="n">transform_args</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="n">optimizer_args</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">Mnew</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">Mnew</span><span class="o">.</span><span class="n">NodeCoords</span> <span class="o">=</span> <span class="n">new_points2</span>
    <span class="k">return</span> <span class="n">Mnew</span><span class="p">,</span> <span class="n">T</span></div>


<div class="viewcode-block" id="Image2Image">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.Image2Image.html#mymesh.register.Image2Image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Image2Image</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;rigid&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;dice&#39;</span><span class="p">,</span> 
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">optimizer_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decimation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_method</span><span class="o">=</span><span class="s1">&#39;boundary&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Image registration for 2D or 3D images. :code:`img2` will be registered to :code:`img1`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img1 : array_like</span>
<span class="sd">        Image array of the fixed image. Two or three dimensional numpy array of image data</span>
<span class="sd">    img2 : array_like</span>
<span class="sd">        image array of the moving image. Two or three dimensional numpy array of image data</span>
<span class="sd">    T0 : array_like or NoneType, optional</span>
<span class="sd">        Initial transformation to apply to img2, by default, None. This can </span>
<span class="sd">        serve as an &#39;initial guess&#39; of the alignment.</span>
<span class="sd">    bounds : array_like or NoneType, optional</span>
<span class="sd">        Optimization bounds, formatted as [(min,max),...] for each parameter.</span>
<span class="sd">        If None, bounds are selected that should cover most possible </span>
<span class="sd">        transformations, by default None. Not used by all optimizers.</span>
<span class="sd">    center : str, array_like, optional</span>
<span class="sd">        Location of the center of rotation of the image. This will be used as the </span>
<span class="sd">        &quot;center&quot; input to the transformation model (e.g. :func:`rigid`, :func:`affine`).</span>
<span class="sd">        If &quot;center&quot; is given in `transform_args`, that value will be used instead.</span>

<span class="sd">        - &#39;image&#39;: Rotation about the center of the image, :code:`np.shape(img)/2`.</span>
<span class="sd">        - </span>
<span class="sd">            `[x,y,z]` or `[x,y]`: A tow or three element list or array </span>
<span class="sd">            specifies the location, in voxels/pixels, of where to place to </span>
<span class="sd">            place the center of rotation </span>

<span class="sd">    transform : str, optional</span>
<span class="sd">        Transformation model, by default &#39;rigid&#39;. If 2d images are given, the</span>
<span class="sd">        transformation model will automatically be modified to the two dimensional</span>
<span class="sd">        variant (e.g. &#39;rigid&#39; -&gt; &#39;rigid2d&#39;)</span>

<span class="sd">        - &#39;translation&#39;: translations</span>

<span class="sd">        - &#39;rotation&#39;: rotations</span>

<span class="sd">        - &#39;rigid&#39;: translations and rotations</span>

<span class="sd">        - &#39;similarity: translations, rotations, and uniform scaling</span>

<span class="sd">        - &#39;affine&#39;: translations, rotations, triaxial scaling, shearing</span>

<span class="sd">        - &#39;translation2d&#39;: translations in two dimensions</span>

<span class="sd">        - &#39;rotation2d&#39;: rotations in two dimensions</span>

<span class="sd">        - &#39;rigid2&#39;: translations and rotations in two dimensions</span>

<span class="sd">        - &#39;similarity: translations, rotations, and uniform scaling in two dimensions</span>

<span class="sd">        - &#39;affine&#39;: translations, rotations, triaxial scaling, shearing in two dimensions</span>

<span class="sd">    metric : str, optional</span>
<span class="sd">        Similarity metric to compare the two point clouds, by default &#39;hausdorff&#39;</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        Optimization method, by default &#39;direct&#39;. See </span>
<span class="sd">        :func:`~mymesh.register.optimize` for details.</span>
<span class="sd">    scale : float, optional</span>
<span class="sd">        Scale factor used to resample the image to either reduce (scale &lt; 1) </span>
<span class="sd">        or increase (scale &gt; 1) the size/resolution of the image, by default</span>
<span class="sd">        1. The returned image will still be of the original resolution.</span>
<span class="sd">    interpolation_order : int, optional</span>
<span class="sd">        Interpolation order used in image transformation (see </span>
<span class="sd">        `scipy.ndimage.affine_transform &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.affine_transform.html#affine-transform&gt;`_)</span>
<span class="sd">        and scaling (if used). Must be an integer in the range 0-5. Lower order</span>
<span class="sd">        is more efficient at the cost of quality. By default, 1. </span>
<span class="sd">    threshold : NoneType, float, or tuple, optional</span>
<span class="sd">        Threshold value(s) to binarize the images. Images are binarized by `img &gt; threshold`.</span>
<span class="sd">        If given as a float or scalar value, this threshold value is applied to both images.</span>
<span class="sd">        If given as a two-element tuple (or array_like), the first value is applied to `img1`</span>
<span class="sd">        and the second value is paplied to `img2`. If None, the image is assumed to already</span>
<span class="sd">        be binarized (or doesn&#39;t require binarization, depending on which similarity metric</span>
<span class="sd">        is chosen). Images can be binarized arbitrarily, consisting of `True`/`False`, `1`/`0`,</span>
<span class="sd">        `255`/`0`, etc. If the image is not already binarized and no threshold is given, the </span>
<span class="sd">        threshold value will be the midpoint of the range of values for each image (which may</span>
<span class="sd">        not give the intended result). By default, None.</span>
<span class="sd">    transform_args : dict, optional</span>
<span class="sd">        Optional input arguments passed to `scipy.ndimage.affine_transform &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.affine_transform.html&gt;`_, by </span>
<span class="sd">        default `dict(mode=&#39;constant&#39;, order=interpolation_order)`.</span>
<span class="sd">    optimizer_args : dict, optional</span>
<span class="sd">        Additional arguments for the chosen optimizer, by default None. See </span>
<span class="sd">        :func:`~mymesh.register.optimize` for details.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbosity, by default True. If True, iteration progress will be printed.</span>
<span class="sd">    point_method : str, optional</span>
<span class="sd">        Method for converting image to points if using a point-based method,</span>
<span class="sd">        by default &#39;boundary&#39;.</span>

<span class="sd">        - &#39;boundary&#39; : The voxels of the boundaries of the thresholeded image wil be converted to points</span>
<span class="sd">        - &#39;binary&#39; : All thresholded voxels will be converted to points</span>
<span class="sd">        - &#39;skeleton&#39; : The morphological skeleton of the thresholded image will be converted to points</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_img : np.ndarray</span>
<span class="sd">        Transformed image array of img2 registered to img1.</span>
<span class="sd">    x : np.ndarray</span>
<span class="sd">        Transformation parameters for the transformation that registers img2</span>
<span class="sd">        to img1.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">        :nofigs:</span>

<span class="sd">        import mymesh</span>
<span class="sd">        from mymesh import register</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        import matplotlib.pyplot as plt</span>

<span class="sd">        # Load the CT scan of the Stanford Bunny</span>
<span class="sd">        img1 = mymesh.demo_image(&#39;bunny&#39;) </span>

<span class="sd">        thresh = 100</span>

<span class="sd">        # Perform an arbitrary rotation to the copy</span>
<span class="sd">        R = register.rotation([np.pi/6, -np.pi/6, np.pi/6], </span>
<span class="sd">                                center=np.array(img1.shape)/2)</span>
<span class="sd">        img2 = register.transform_image(img1, R)</span>

<span class="sd">        # Align the two images using the iterative closest point (ICP) algorithm</span>
<span class="sd">        img_aligned, T = register.Image2Image(img1, img2, method=&#39;icp&#39;, threshold=thresh, scale=0.5)</span>

<span class="sd">    .. grid:: 2</span>

<span class="sd">        .. grid-item::</span>

<span class="sd">            .. plot::</span>
<span class="sd">                :context: close-figs</span>
<span class="sd">                :include-source: False</span>

<span class="sd">                import matplotlib.pyplot as plt</span>

<span class="sd">                overlay = register.ImageOverlay(img1, img2, threshold=thresh)</span>
<span class="sd">                plt.imshow(overlay[:,250], cmap=&#39;inferno&#39;)</span>
<span class="sd">                plt.axis(&#39;off&#39;)</span>

<span class="sd">        .. grid-item::</span>

<span class="sd">            .. plot::</span>
<span class="sd">                :context: close-figs</span>
<span class="sd">                :include-source: False</span>

<span class="sd">                overlay = register.ImageOverlay(img1, img_aligned, threshold=thresh)</span>
<span class="sd">                plt.imshow(overlay[:,250], cmap=&#39;inferno&#39;)</span>
<span class="sd">                plt.axis(&#39;off&#39;)</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">        </span>
<span class="sd">        An overlay image can be displayed using :func:`ImageOverlay`, e.g.</span>

<span class="sd">        .. code::</span>

<span class="sd">            import matplotlib.pyplot as plt</span>
<span class="sd">            overlay = register.ImageOverlay(img1, img_aligned, threshold=thresh)</span>
<span class="sd">            plt.imshow(overlay[:,250], cmap=&#39;inferno&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Assess dimensionality</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">nD</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nD</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="s1">&#39;2d&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">+=</span> <span class="s1">&#39;2d&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Image must be either two or three dimensional.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;threshold must be defined as a single value or a list/tuple/array of two values (one for each image).&#39;</span>
        <span class="n">threshold1</span><span class="p">,</span> <span class="n">threshold2</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold1</span> <span class="o">=</span> <span class="n">threshold2</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="c1"># Process threshold input</span>
    <span class="k">if</span> <span class="n">threshold1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This option intended for already binarized images (flexible enough to accomodate different types of binarization, e.g. True/False, 1/0, 255/0, ...)</span>
        <span class="c1"># If the image is not binary, this will assume the midpoint of the range of values as the threshold</span>
        <span class="n">threshold1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">threshold2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        
    <span class="c1"># Process T0 input</span>
    <span class="k">if</span> <span class="n">img2</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">):</span>
        <span class="c1"># Convert binary to float for better interpolation</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">T0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img2T0</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Initialize by centering img2 on img1</span>
        <span class="n">center_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">img1</span> <span class="o">&gt;</span> <span class="n">threshold1</span><span class="p">),</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">img2</span> <span class="o">&gt;</span> <span class="n">threshold2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nD</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="n">translation</span><span class="p">(</span><span class="n">center_diff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="n">translation2d</span><span class="p">(</span><span class="n">center_diff</span><span class="p">)</span>
        <span class="n">img2T0</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">))</span>    
    
    <span class="c1"># Process scale input</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img1</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">):</span>
            <span class="c1"># Convert binary to float for better interpolation</span>
            <span class="n">img1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">moving_img</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">img2T0</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>
        <span class="n">fixed_img</span> <span class="o">=</span>  <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">moving_img</span> <span class="o">=</span> <span class="n">img2T0</span>
        <span class="n">fixed_img</span> <span class="o">=</span> <span class="n">img1</span>
    
    <span class="c1"># Process metric input</span>
    <span class="n">point_based</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">grayscale</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mutual_information&#39;</span> <span class="ow">or</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MI&#39;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">mutual_information</span>
        <span class="n">grayscale</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dice&#39;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">img1</span><span class="p">,</span> <span class="n">img2</span> <span class="p">:</span> <span class="o">-</span><span class="n">dice</span><span class="p">(</span><span class="n">img1</span> <span class="o">&gt;</span> <span class="n">threshold1</span><span class="p">,</span> <span class="n">img2</span> <span class="o">&gt;</span> <span class="n">threshold2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;symmetric_closest_point_mse&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binarized1</span> <span class="o">=</span> <span class="n">fixed_img</span> <span class="o">&gt;</span> <span class="n">threshold1</span>
            <span class="n">binarized2</span> <span class="o">=</span> <span class="n">moving_img</span> <span class="o">&gt;</span> <span class="n">threshold2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binarized1</span> <span class="o">=</span> <span class="n">fixed_img</span>
            <span class="n">binarized2</span> <span class="o">=</span> <span class="n">moving_img</span>
        <span class="n">point_based</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">points1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binarized1</span><span class="p">))</span>
        <span class="n">points2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binarized2</span><span class="p">))</span>
        <span class="c1"># tree1 = scipy.spatial.KDTree(points1) </span>
        <span class="c1"># Note: can&#39;t precommute tree for the moving points</span>
        <span class="c1"># obj = lambda p1, p2 : symmetric_closest_point_MSE(p1, p2, tree1=tree1)</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binarized1</span> <span class="o">=</span> <span class="n">fixed_img</span> <span class="o">&gt;</span> <span class="n">threshold1</span>
            <span class="n">binarized2</span> <span class="o">=</span> <span class="n">moving_img</span> <span class="o">&gt;</span> <span class="n">threshold2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binarized1</span> <span class="o">=</span> <span class="n">fixed_img</span>
            <span class="n">binarized2</span> <span class="o">=</span> <span class="n">moving_img</span>
        <span class="n">point_based</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span> <span class="ow">or</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;icp&#39;</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;icp&#39;</span>

    <span class="c1"># Process threshold input</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This option intended for already binarized images (flexible enough to accomodate different types of binarization, e.g. True/False, 1/0, 255/0, ...)</span>
        <span class="c1"># If the image is not binary, this will assume the midpoint of the range of values as the threshold</span>
        <span class="n">threshold1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">threshold2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;threshold must be defined as a single value or a list/tuple/array of two values (one for each image).&#39;</span>
        <span class="n">threshold1</span><span class="p">,</span> <span class="n">threshold2</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold1</span> <span class="o">=</span> <span class="n">threshold2</span> <span class="o">=</span> <span class="n">threshold</span>
        
    <span class="c1"># Process T0 input</span>
    <span class="k">if</span> <span class="n">T0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img2T0</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Initialize by centering img2 on img1</span>
        <span class="n">center_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">img1</span> <span class="o">&gt;</span> <span class="n">threshold1</span><span class="p">),</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">img2</span> <span class="o">&gt;</span> <span class="n">threshold2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nD</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="n">translation</span><span class="p">(</span><span class="n">center_diff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="n">translation2d</span><span class="p">(</span><span class="n">center_diff</span><span class="p">)</span>
        <span class="n">img2T0</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">))</span>    
    
    <span class="c1"># Process scale input</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">moving_img</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">img2T0</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>
        <span class="n">fixed_img</span> <span class="o">=</span>  <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">moving_img</span> <span class="o">=</span> <span class="n">img2T0</span>
        <span class="n">fixed_img</span> <span class="o">=</span> <span class="n">img1</span>
    
    <span class="c1"># Process metric input</span>
    <span class="n">point_based</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">grayscale</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mutual_information&#39;</span> <span class="ow">or</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MI&#39;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">mutual_information</span>
        <span class="n">grayscale</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dice&#39;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">img1</span><span class="p">,</span> <span class="n">img2</span> <span class="p">:</span> <span class="o">-</span><span class="n">dice</span><span class="p">(</span><span class="n">img1</span> <span class="o">&gt;</span> <span class="n">threshold1</span><span class="p">,</span> <span class="n">img2</span> <span class="o">&gt;</span> <span class="n">threshold2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;symmetric_closest_point_mse&#39;</span><span class="p">:</span>
        <span class="n">point_based</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># tree1 = scipy.spatial.KDTree(points1) </span>
        <span class="c1"># Note: can&#39;t precommute tree for the moving points</span>
        <span class="c1"># obj = lambda p1, p2 : symmetric_closest_point_MSE(p1, p2, tree1=tree1)</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;icp&#39;</span><span class="p">:</span>
        <span class="n">point_based</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Similarity metric f&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">&quot; is not supported for Image2Image3d registration.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">point_based</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binarized1</span> <span class="o">=</span> <span class="n">fixed_img</span> <span class="o">&gt;</span> <span class="n">threshold1</span>
            <span class="n">binarized2</span> <span class="o">=</span> <span class="n">moving_img</span> <span class="o">&gt;</span> <span class="n">threshold2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binarized1</span> <span class="o">=</span> <span class="n">fixed_img</span>
            <span class="n">binarized2</span> <span class="o">=</span> <span class="n">moving_img</span>

        <span class="k">if</span> <span class="n">point_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">points1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binarized1</span><span class="p">))</span>
            <span class="n">points2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binarized2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">point_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;boundary&#39;</span><span class="p">:</span>
            <span class="n">boundary1</span> <span class="o">=</span> <span class="n">binarized1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">binarized1</span><span class="p">)</span>
            <span class="n">boundary2</span> <span class="o">=</span> <span class="n">binarized2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">binarized2</span><span class="p">)</span>

            <span class="n">points1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundary1</span><span class="p">))</span>
            <span class="n">points2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundary2</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">point_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;skeleton&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">skimage.morphology</span><span class="w"> </span><span class="kn">import</span> <span class="n">skeletonize</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;scikit-image is required for skeletonization. Install with: `pip install scikit-image`.&#39;</span><span class="p">)</span>
            
            <span class="n">skel1</span> <span class="o">=</span> <span class="n">skeletonize</span><span class="p">(</span><span class="n">binarized1</span><span class="p">)</span>
            <span class="n">skel2</span> <span class="o">=</span> <span class="n">skeletonize</span><span class="p">(</span><span class="n">binarized2</span><span class="p">)</span>

            <span class="n">points1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">skel1</span><span class="p">))</span>
            <span class="n">points2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">skel2</span><span class="p">))</span>


    <span class="c1"># Process transform_args input</span>
    <span class="k">if</span> <span class="n">transform_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">transform_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>



    <span class="c1"># Process center input</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

        <span class="c1"># Process transform input</span>
        <span class="k">if</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;scale_uniform&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">scale_uniform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mf">.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">)</span>
                <span class="p">]</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||        s &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------&#39;</span><span class="p">)</span>   
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rigid&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rigid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="p">]</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------&#39;</span><span class="p">)</span>   
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;translation&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="p">]</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------&#39;</span><span class="p">)</span>   
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rotation&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rotation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="p">]</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||    alpha |     beta |    gamma &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------&#39;</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;similarity&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">similarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma |        s |&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------|&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;affine&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">15</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">affine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma |        s |&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------|&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rigid2d&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rigid2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">]</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |    theta &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------&#39;</span><span class="p">)</span>   
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;translation2d&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">translation2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">]</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------&#39;</span><span class="p">)</span>   
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rotation2d&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rotation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="p">]</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||    theta &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------&#39;</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;similarity2d&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">similarity2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="n">x0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |    theta |        s &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;affine2d&#39;</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="mi">15</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">affine2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
            <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |    theta |       s1 |       s2 |     sh01 |     sh10 &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------&#39;</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transformation model &quot;</span><span class="si">{</span><span class="n">transform</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">&quot; is not supported for Image2Image registration.&#39;</span><span class="p">)</span>       
        
        <span class="k">if</span> <span class="n">point_based</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">Point2Point</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">transform_args</span><span class="o">=</span><span class="n">transform_args</span><span class="p">,</span> <span class="n">decimation</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="n">optimizer_args</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">new_img</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img2</span><span class="p">):</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Images must be the same size for image-based image-to-image registration.&#39;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">objective</span><span class="o">.</span><span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:5d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">k</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                
                <span class="n">imgT</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">moving_img</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">transform_args</span><span class="p">)</span>
                
                <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">,</span> <span class="n">imgT</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;||</span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s1">11.4f</span><span class="si">}</span><span class="s1">|&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;|</span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">f</span>
            <span class="n">objective</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="n">optimizer_args</span><span class="p">)</span>
            
            <span class="n">T1</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Account for scaling so that the transformation matrix refers to the original image size</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T0</span><span class="p">))</span>
                <span class="n">D</span><span class="p">[:</span><span class="n">nD</span><span class="p">,:</span><span class="n">nD</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">scale</span><span class="p">]</span><span class="o">*</span><span class="n">nD</span><span class="p">)</span>
                <span class="n">T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="o">@</span> <span class="n">T1</span> <span class="o">@</span> <span class="n">D</span>
            
            <span class="n">T</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">@</span> <span class="n">T0</span> <span class="c1"># include T0 so that img is transformed first by T0, then by the new transform</span>
            <span class="n">new_img</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">transform_args</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">new_img</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------|&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|----------&#39;</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;final||</span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s1">11.4f</span><span class="si">}</span><span class="s1">|&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;|</span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
    <span class="c1"># Process transform input</span>
    <span class="k">if</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rigid&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rigid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------&#39;</span><span class="p">)</span>   
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;translation&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------&#39;</span><span class="p">)</span>   
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rotation&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rotation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||    alpha |     beta |    gamma &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------&#39;</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;similarity&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">similarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma |        s |&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------|&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;affine&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">affine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |       tz |    alpha |     beta |    gamma |        s |&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------|&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rigid2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rigid2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |    theta &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------&#39;</span><span class="p">)</span>   
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;translation2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">translation2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------&#39;</span><span class="p">)</span>   
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rotation2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">rotation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||    theta &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------&#39;</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;similarity2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">similarity2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |    theta |        s &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;affine2d&#39;</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">affine2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparam</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">10</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter.||      score||       tx |       ty |    theta |       s1 |       s2 |     sh01 |     sh10 &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------||----------|----------|----------|----------|----------|----------|----------&#39;</span><span class="p">)</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transformation model &quot;</span><span class="si">{</span><span class="n">transform</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">&quot; is not supported for Image2Image registration.&#39;</span><span class="p">)</span>       
    
    <span class="k">if</span> <span class="n">point_based</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">T1</span> <span class="o">=</span> <span class="n">Point2Point</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">transform_args</span><span class="o">=</span><span class="n">transform_args</span><span class="p">,</span> <span class="n">decimation</span><span class="o">=</span><span class="n">decimation</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="n">optimizer_args</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># T = T1 @ T0</span>
        <span class="c1"># new_img = transform_image(img2, T, options=transform_args)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Images must be the same size for image-based image-to-image registration.&#39;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">objective</span><span class="o">.</span><span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:5d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">k</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            
            <span class="n">imgT</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">moving_img</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">transform_args</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">,</span> <span class="n">imgT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;||</span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s1">11.4f</span><span class="si">}</span><span class="s1">|&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;|</span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="n">objective</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="n">optimizer_args</span><span class="p">)</span>
        
        <span class="n">T1</span> <span class="o">=</span> <span class="n">transformation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Account for scaling so that the transformation matrix refers to the original image size</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T0</span><span class="p">))</span>
        <span class="n">D</span><span class="p">[:</span><span class="n">nD</span><span class="p">,:</span><span class="n">nD</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">scale</span><span class="p">]</span><span class="o">*</span><span class="n">nD</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="o">@</span> <span class="n">T1</span> <span class="o">@</span> <span class="n">D</span>
    
    <span class="n">T</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">@</span> <span class="n">T0</span> <span class="c1"># include T0 so that img is transformed first by T0, then by the new transform</span>
    <span class="n">new_img</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">transform_args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">new_img</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----||-----------|&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|----------&#39;</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;final||</span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s1">11.4f</span><span class="si">}</span><span class="s1">|&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;|</span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_img</span><span class="p">,</span> <span class="n">T</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">Mesh2Image3d</span><span class="p">():</span>
    <span class="k">return</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Image2Mesh3d</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center_mesh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interpolation_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;rigid&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;icp&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icp&#39;</span><span class="p">,</span> <span class="n">transform_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span>  <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">interpolation_order</span><span class="p">)</span>
    <span class="n">mesh_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">NodeCoords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">center_mesh</span><span class="p">:</span>
        <span class="n">mesh_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">NodeCoords</span><span class="p">)</span>
        <span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">decimation</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">)</span><span class="o">*</span><span class="n">decimation</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mesh_points</span> <span class="o">=</span> <span class="n">mesh_points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;decimation must be a scalar value in the range (0,1], not </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">decimation</span><span class="p">)</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binarized</span> <span class="o">=</span> <span class="n">img</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">binarized</span> <span class="o">=</span> <span class="n">img</span>
    
    <span class="n">img_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binarized</span><span class="p">))</span> <span class="o">*</span> <span class="n">h</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span> <span class="c1"># flipping to make image coordinate system (z,y,x) match mesh coordinate system</span>

    <span class="n">new_points</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">Point2Point</span><span class="p">(</span><span class="n">mesh_points</span><span class="p">,</span> <span class="n">img_points</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">transform_args</span><span class="o">=</span><span class="n">transform_args</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="n">optimizer_args</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">P</span><span class="nd">@T@P</span>  <span class="c1"># Reorder transformations to the image coordinate system</span>
    <span class="n">T2</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span><span class="o">/</span><span class="n">h</span> <span class="c1"># Scale translations back to units of voxels</span>

    <span class="n">new_image</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_image</span><span class="p">,</span> <span class="n">T</span>

<div class="viewcode-block" id="ICP">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.ICP.html#mymesh.register.ICP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ICP</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">maxRestart</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_success</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterative Closest Point (ICP) algorithm for registering two point sets</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points1 : array_like</span>
<span class="sd">        Fixed points that points2 will be registered to</span>
<span class="sd">    points2 : array_like</span>
<span class="sd">        Moving points that will be registered to points1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_points : np.ndarray</span>
<span class="sd">        Transformed coordinate array of points2 registered to points1.</span>
<span class="sd">    T : np.ndarray</span>
<span class="sd">        Affine transformation matrix (shape=(4,4)) to transform points2 to new_points.</span>
<span class="sd">        :code:`new_points = transform_points(points2, T)`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">T0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">points2T0</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">points2</span><span class="p">,</span> <span class="n">T0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">points2T0</span> <span class="o">=</span> <span class="n">points2</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">points2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">center_of_mass1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">center_of_mass2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points2T0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># center both point clouds</span>
    <span class="n">fixed_points</span> <span class="o">=</span> <span class="n">points1</span> <span class="o">-</span> <span class="n">center_of_mass1</span>
    <span class="n">moving_points</span> <span class="o">=</span> <span class="n">points2T0</span> <span class="o">-</span> <span class="p">(</span><span class="n">center_of_mass2</span><span class="p">)</span>

    <span class="n">tree1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">fixed_points</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">moving_points</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">moving_points</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Points must be either 2D or 3D&#39;</span><span class="p">)</span>

    <span class="c1"># Convergence checks when the rotation and translation for the current iteration are close to zero</span>
    <span class="n">convergence</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">R</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>

    <span class="c1"># Rtotal = np.eye(len(R))</span>
    <span class="c1"># ttotal = np.zeros(np.shape(moving_points)[1])</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">convergence</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxIter</span><span class="p">:</span>
        <span class="c1"># Distances for each pt in moving_points to the closest point in fixed_points</span>
        <span class="n">distances21</span><span class="p">,</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">tree1</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">moving_points</span><span class="p">,</span> <span class="n">workers</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> 
        
        <span class="c1"># Cross covariance matrix</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">moving_points</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">fixed_points</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> 

        <span class="c1"># Singular Value Decomposition to determine rotation matrix</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Vt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
        
        <span class="c1"># Update moving points</span>
        <span class="n">moving_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">moving_points</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Translation based on differences in the center of pass of the points in the correspondence</span>
        <span class="n">center_of_mass1_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fixed_points</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">center_of_mass2_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">moving_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">center_of_mass1_</span> <span class="o">-</span> <span class="n">center_of_mass2_</span>
        <span class="n">moving_points</span> <span class="o">+=</span> <span class="n">t</span>
        
        <span class="c1"># Accumulate transformations</span>
        <span class="n">Ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Ti</span><span class="nd">@T</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">T_restart</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">maxIter</span><span class="p">:</span>
        <span class="n">sq_error</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">moving_points</span> <span class="o">-</span> <span class="n">fixed_points</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))]</span>
        <span class="n">Ts</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">maxRestart</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxRestart</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># 3D</span>
                    <span class="n">rand_rot</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">rand_R</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">rand_rot</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 2D</span>
                    <span class="n">rand_rot</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">rand_R</span> <span class="o">=</span> <span class="n">rotation2d</span><span class="p">(</span><span class="n">rand_rot</span><span class="p">)</span>
                <span class="n">new_points</span><span class="p">,</span> <span class="n">T_restart</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">ICP</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">T0</span><span class="o">=</span><span class="n">rand_R</span><span class="nd">@T0</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="n">maxIter</span><span class="p">,</span> <span class="n">maxRestart</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">tree1</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">new_points</span><span class="p">,</span> <span class="n">workers</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> 
                <span class="n">Ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T_restart</span><span class="p">)</span>
                <span class="n">sq_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">new_points</span> <span class="o">-</span> <span class="n">fixed_points</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ICP did not converge to the specified tolerance within </span><span class="si">{</span><span class="n">maxIter</span><span class="si">}</span><span class="s1"> iterations after </span><span class="si">{</span><span class="n">maxRestart</span><span class="si">}</span><span class="s1"> restarts&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">T_restart</span> <span class="o">=</span> <span class="n">Ts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">sq_error</span><span class="p">)]</span> <span class="c1"># Choose the attempt with the lowest squared error, even if it&#39;s not the one that converged </span>
        <span class="k">elif</span> <span class="n">maxRestart</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Skip warning; internal use for handling restarts</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ICP did not converge to the specified tolerance within </span><span class="si">{</span><span class="n">maxIter</span><span class="si">}</span><span class="s1"> iterations.&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Perform final translation to center and include T0</span>
    <span class="k">if</span> <span class="n">T_restart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># T[:Rtotal.shape[0],:Rtotal.shape[1]] = Rtotal</span>
        <span class="c1"># T[:T.shape[0]-1,T.shape[1]-1] = ttotal</span>
    
        <span class="c1"># move center of points to origin, perform rotation, then move to center of fixed points</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">moving_points</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">Tfinal</span> <span class="o">=</span> <span class="n">translation</span><span class="p">(</span><span class="n">center_of_mass1</span><span class="p">)</span><span class="nd">@T@translation</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">center_of_mass2</span><span class="p">)</span> <span class="o">@</span> <span class="n">T0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Tfinal</span> <span class="o">=</span> <span class="n">translation2d</span><span class="p">(</span><span class="n">center_of_mass1</span><span class="p">)</span><span class="nd">@T@translation2d</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">center_of_mass2</span><span class="p">)</span> <span class="o">@</span> <span class="n">T0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Tfinal</span> <span class="o">=</span> <span class="n">T_restart</span>
    
    <span class="n">new_points</span> <span class="o">=</span> <span class="n">transform_points</span><span class="p">(</span><span class="n">points2</span><span class="p">,</span> <span class="n">Tfinal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_success</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">Tfinal</span><span class="p">,</span> <span class="n">success</span>
    <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">Tfinal</span></div>


<span class="c1">### Transformations</span>
<div class="viewcode-block" id="T2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.T2d.html#mymesh.register.T2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">T2d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a translation matrix</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{T} = \begin{bmatrix}</span>
<span class="sd">            1 &amp; 0 &amp; t_0 \\</span>
<span class="sd">            0 &amp; 1 &amp; t_1 \\</span>
<span class="sd">            0 &amp; 0 &amp; 1</span>
<span class="sd">            \end{bmatrix}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t0 : float</span>
<span class="sd">        Translation in the 0 axis (spatial y)</span>
<span class="sd">    t1 : float</span>
<span class="sd">        Translation in the 1 axis (spatial x)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : np.ndarray</span>
<span class="sd">        3x3 translation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">t</span></div>

    
<div class="viewcode-block" id="R2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.R2d.html#mymesh.register.R2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">R2d</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">center</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a rotation matrix for a rotation about a point</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{R} = \begin{bmatrix}</span>
<span class="sd">        cos(\theta) &amp; -\sin(\theta) &amp; 0 \\</span>
<span class="sd">        \sin(\theta) &amp; \cos(\theta) &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; 1</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    </span>
<span class="sd">    For a center other than the origin, :math:`\begin{bmatrix}c_0, c_1 \end{bmatrix}`:</span>

<span class="sd">    :math:`\mathbf{R_c} = \mathbf{T}(\begin{bmatrix}c_0, c_1\end{bmatrix}) \mathbf{R} \mathbf{T}(\begin{bmatrix}-c_0, -c_1 \end{bmatrix})`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta : float</span>
<span class="sd">        Rotation, in radians</span>
<span class="sd">    center : list or np.ndarray</span>
<span class="sd">        Reference point for the rotation</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r : np.ndarray</span>
<span class="sd">        3x3 Rotation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="o">*</span><span class="n">center</span><span class="p">)</span>
    
    <span class="n">T2</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="o">*-</span><span class="n">center</span><span class="p">)</span>
    <span class="n">Rtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span>            <span class="mi">0</span><span class="p">,</span>             <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T1</span><span class="p">,</span><span class="n">Rtheta</span><span class="p">,</span><span class="n">T2</span><span class="p">])</span> 
    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="S2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.S2d.html#mymesh.register.S2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">S2d</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">reference</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a scaling matrix</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{S} = \begin{bmatrix}</span>
<span class="sd">        s_0 &amp; 0 &amp; 0 \\</span>
<span class="sd">        0 &amp; s_1 &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; 1</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s0 : float</span>
<span class="sd">        Scale factor in the 0 axis (spatial y)</span>
<span class="sd">    s1 : float</span>
<span class="sd">        Scale factor in the 1 axis (spatial x)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : np.ndarray</span>
<span class="sd">        3x3 scaling matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

    <span class="n">T1</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="o">*</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="o">*-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T1</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">T2</span><span class="p">])</span> 

    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="Sh2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.Sh2d.html#mymesh.register.Sh2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Sh2d</span><span class="p">(</span><span class="n">sh01</span><span class="p">,</span><span class="n">sh10</span><span class="p">,</span><span class="n">reference</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a shearing matrix</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{Sh} = \begin{bmatrix}</span>
<span class="sd">                1 &amp; sh_{01} &amp; 0 \\</span>
<span class="sd">                sh_{01} &amp; 1 &amp; 0 \\</span>
<span class="sd">                0 &amp; 0 &amp; 1</span>
<span class="sd">            \end{bmatrix}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh01 : float</span>
<span class="sd">        Shear in the x-y direction</span>
<span class="sd">    sh10 : float</span>
<span class="sd">        Shear in the y-x direction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sh : np.ndarray</span>
<span class="sd">        3x3 scaling matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span>      <span class="n">sh10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">sh01</span><span class="p">,</span>      <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="o">*</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="o">*-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T1</span><span class="p">,</span><span class="n">sh</span><span class="p">,</span><span class="n">T2</span><span class="p">])</span> 
    <span class="k">return</span> <span class="n">sh</span></div>


<div class="viewcode-block" id="T3d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.T3d.html#mymesh.register.T3d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">T3d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a translation matrix</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{T} = \begin{bmatrix}</span>
<span class="sd">            1 &amp; 0 &amp; 0 &amp; t_0 \\</span>
<span class="sd">            0 &amp; 1 &amp; 0 &amp; t_1 \\</span>
<span class="sd">            0 &amp; 0 &amp; 1 &amp; t_2 \\</span>
<span class="sd">            0 &amp; 0 &amp; 0 &amp; 1</span>
<span class="sd">            \end{bmatrix}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t0 : float</span>
<span class="sd">        Translation in the x axis </span>
<span class="sd">    t1 : float</span>
<span class="sd">        Translation in the y axis</span>
<span class="sd">    t2 : float</span>
<span class="sd">        Translation in the z axis </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : np.ndarray</span>
<span class="sd">        4x4 translation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t2</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">t</span></div>

    
<div class="viewcode-block" id="R3d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.R3d.html#mymesh.register.R3d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">R3d</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;cartesian&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a rotation matrix for a rotation about a point</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{R_0} = \begin{bmatrix}</span>
<span class="sd">        1 &amp; 0 &amp; 0 &amp; 0 \\</span>
<span class="sd">        0 &amp; \cos(\alpha) &amp; -\sin(\alpha) &amp; 0 \\</span>
<span class="sd">        0 &amp; \sin(\alpha) &amp; \cos(\alpha) &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; 0 &amp; 1</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">        \mathbf{R_1} = \begin{bmatrix}</span>
<span class="sd">        \cos(\beta) &amp; 0 &amp; \sin(\beta) &amp; 0 \\</span>
<span class="sd">        0 &amp; 1 &amp; 0 &amp; 0 \\</span>
<span class="sd">        -\sin(\beta) &amp; 0 &amp; \cos(\beta) &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; 0 &amp; 1</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">        \mathbf{R_2} = \begin{bmatrix}</span>
<span class="sd">        \cos(\gamma) &amp; -\sin(\gamma) &amp; 0 &amp; 0 \\</span>
<span class="sd">        \sin(\gamma) &amp; \cos(\gamma) &amp; 0 &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; 1 &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; 0 &amp; 1</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">        \mathbf{R_{012}} = \mathbf{R_2} \mathbf{R_1} \mathbf{R_0}</span>

<span class="sd">    For a center other than the origin, :math:`\begin{bmatrix}c_0, c_1, c_2 \end{bmatrix}`:</span>

<span class="sd">    :math:`\mathbf{R_c} = \mathbf{T}(\begin{bmatrix}c_0, c_1, c_2 \end{bmatrix}) \mathbf{R_{012}} \mathbf{T}(\begin{bmatrix}-c_0, -c_1, -c_2 \end{bmatrix})`</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Rotation about the x, in radians</span>
<span class="sd">    beta : float</span>
<span class="sd">        Rotation about the y, in radians</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Rotation about the z, in radians</span>
<span class="sd">    center : array_like, optional</span>
<span class="sd">        Reference point for the rotation, by default np.array([0,0,0]).</span>
<span class="sd">    rotation_order : array_like, optional</span>
<span class="sd">        Order to perform rotations about the x (0), y (1), and z (2) axes,  by</span>
<span class="sd">        default [0,1,2]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r : np.ndarray</span>
<span class="sd">        4x4 Rotation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="o">*</span><span class="n">center</span><span class="p">)</span>
    
    <span class="n">T2</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="o">*-</span><span class="n">center</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rotation_mode</span> <span class="o">==</span> <span class="s1">&#39;cartesian&#39;</span><span class="p">:</span>
        <span class="n">Rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span>             <span class="mi">0</span><span class="p">,</span>             <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span>             <span class="mi">0</span><span class="p">,</span>             <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        
        <span class="n">Ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span>            <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span>            <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        
        <span class="n">Rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span>            <span class="mi">0</span><span class="p">,</span>             <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span>            <span class="mi">0</span><span class="p">,</span>             <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">Rz</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">R</span><span class="p">[</span><span class="n">rotation_order</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">R</span><span class="p">[</span><span class="n">rotation_order</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">R</span><span class="p">[</span><span class="n">rotation_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Rotation modes other than &quot;cartesian&quot; not yet implemented.&#39;</span><span class="p">)</span>
    <span class="c1"># elif rotation_mode == &#39;euler&#39;:</span>
    <span class="c1">#     c1 = np.cos(alpha); c2 = np.cos(beta); c3 = np.cos(gamma);</span>
    <span class="c1">#     s1 = np.sin(alpha); s2 = np.sin(beta); s3 = np.sin(gamma);</span>

    <span class="c1">#     R = np.array([</span>
    <span class="c1">#             [c2 , -c3*s2, s2*s3, 0],</span>
    <span class="c1">#             [c1*s2, c1*c2*c3-s1*s3, -c3*s1 - c1*c2*s3, 0],</span>
    <span class="c1">#             [s1*s2, c1*s3+c2*c3*s1, c1*c3-c2*s1*s3, 0],</span>
    <span class="c1">#             [0, 0, 0, 1]</span>
    <span class="c1">#         ])</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T1</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">T2</span><span class="p">])</span> 
    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="S3d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.S3d.html#mymesh.register.S3d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">S3d</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">reference</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a 3d scaling matrix</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{S} = \begin{bmatrix}</span>
<span class="sd">        s_0 &amp; 0 &amp; 0 &amp; 0 \\</span>
<span class="sd">        0 &amp; s_1 &amp; 0 &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; s_2 &amp; 0 \\</span>
<span class="sd">        0 &amp; 0 &amp; 0 &amp; 1</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s0 : float</span>
<span class="sd">        Scale factor in the x axis</span>
<span class="sd">    s1 : float</span>
<span class="sd">        Scale factor in the y axis</span>
<span class="sd">    s2 : float</span>
<span class="sd">        Scale factor in the z axis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : np.ndarray</span>
<span class="sd">        4x4 scaling matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

    <span class="n">T1</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="o">*</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="o">*-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T1</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">T2</span><span class="p">])</span> 

    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="Sh3d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.Sh3d.html#mymesh.register.Sh3d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Sh3d</span><span class="p">(</span><span class="n">sh01</span><span class="p">,</span><span class="n">sh10</span><span class="p">,</span><span class="n">sh02</span><span class="p">,</span><span class="n">sh20</span><span class="p">,</span><span class="n">sh12</span><span class="p">,</span><span class="n">sh21</span><span class="p">,</span><span class="n">reference</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a shearing matrix</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathbf{Sh} = \begin{bmatrix}</span>
<span class="sd">                1 &amp; sh_{01} &amp; sh_{20} &amp; 0 \\</span>
<span class="sd">                sh_{01} &amp; 1 &amp; sh_{21} &amp; 0 \\</span>
<span class="sd">                sh_{02} &amp; sh_{12} &amp; 1 &amp; 0 \\</span>
<span class="sd">                0 &amp; 0 &amp; 0 &amp; 1</span>
<span class="sd">            \end{bmatrix}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sh01 : float</span>
<span class="sd">        Shear in the xy direction</span>
<span class="sd">    sh10 : float</span>
<span class="sd">        Shear in the yx direction</span>
<span class="sd">    sh02 : float</span>
<span class="sd">        Shear in the xz direction</span>
<span class="sd">    sh20 : float</span>
<span class="sd">        Shear in the zx direction</span>
<span class="sd">    sh12 : float</span>
<span class="sd">        Shear in the yz direction</span>
<span class="sd">    sh21 : float</span>
<span class="sd">        Shear in the zy direction</span>
<span class="sd">    reference : array_like</span>
<span class="sd">        Center to chear about, by default np.array([0,0,0])</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sh : np.ndarray</span>
<span class="sd">        4x4 scaling matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span>     <span class="n">sh10</span><span class="p">,</span> <span class="n">sh20</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">sh01</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span> <span class="n">sh21</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">sh02</span><span class="p">,</span> <span class="n">sh12</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="o">*</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="o">*-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">T1</span><span class="p">,</span><span class="n">sh</span><span class="p">,</span><span class="n">T2</span><span class="p">])</span> 
    <span class="k">return</span> <span class="n">sh</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">scale_uniform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid rotation in 3D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        list with a single value for uniform scaling :code:`[s]`</span>
<span class="sd">        </span>
<span class="sd">    center : list or np.ndarary, optional</span>
<span class="sd">        Reference point for the scaling</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        scaling matrix (shape=(4,4))</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">S</span> <span class="o">=</span> <span class="n">S3d</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">S</span>
    
    <span class="k">return</span> <span class="n">A</span>

<div class="viewcode-block" id="rotation">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.rotation.html#mymesh.register.rotation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rotation_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;cartesian&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid rotation in 3D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        3 item list, containing the x, y, and z rotations</span>
<span class="sd">        :code:`[alpha, beta, gamma]`, where angles are specified in radians.</span>
<span class="sd">    center : list or np.ndarary, optional</span>
<span class="sd">        Reference point for the rotation</span>
<span class="sd">    rotation_order : array_like, optional</span>
<span class="sd">        Order to perform rotations about the x (0), y (1), and z (2) axes,  by</span>
<span class="sd">        default [0,1,2]</span>
<span class="sd">    image : bool, optional</span>
<span class="sd">        Create a transformation matrix for an image, assuming the (0,1,2) dimensions correspond to (z,y,x) by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        Affine rotation matrix (shape=(4,4))</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">gamma</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">R3d</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="n">rotation_order</span><span class="o">=</span><span class="n">rotation_order</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="n">rotation_mode</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">r</span>
    
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="rotation2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.rotation2d.html#mymesh.register.rotation2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotation2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid rotation in 2D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array_like</span>
<span class="sd">        1 item list, containing the rotation</span>
<span class="sd">        :code:`[theta]`, where angles are specified in radians.</span>
<span class="sd">    center : list or np.ndarary, optional</span>
<span class="sd">        Reference point for the rotation</span>
<span class="sd">    image : bool, optional</span>
<span class="sd">        Create a transformation matrix for an image, assuming the (0,1,2) dimensions correspond to (z,y,x) by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        Affine rotation matrix (shape=(3,3))</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="p">[</span><span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">R2d</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">r</span>
    
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="translation">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.translation.html#mymesh.register.translation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">translation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid translation in 3D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        3 item list, containing the x, y, and z translations </span>
<span class="sd">        :code:`[t0, t1, t2]`.</span>
<span class="sd">    image : bool, optional</span>
<span class="sd">        Create a transformation matrix for an image, assuming the (0,1,2) dimensions correspond to (z,y,x) by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        Affine translation matrix (shape=(4,4))</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">t</span>
    
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="translation2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.translation2d.html#mymesh.register.translation2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">translation2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid translation in 2D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        2 item list, containing the x, and y translations </span>
<span class="sd">        :code:`[t0, t1]`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        Affine translation matrix (shape=(3,3))</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">t</span>
    
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="rigid2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.rigid2d.html#mymesh.register.rigid2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rigid2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid transformation consisting of translation and rotation in 2D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    I : np.ndarray</span>
<span class="sd">        numpy array containing the image data</span>
<span class="sd">    x : list</span>
<span class="sd">        3 item list, containing the x and y translations and rotation about z</span>
<span class="sd">        :code:`[t0, t1, theta]`, where angles are specified in radians.</span>
<span class="sd">    center : list or np.ndarary, optional</span>
<span class="sd">        Reference point for the rotation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    I2 : np.ndarray</span>
<span class="sd">        numpy array containing the transformed image data</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">R2d</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">t</span><span class="nd">@r</span>
    
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="rigid">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.rigid.html#mymesh.register.rigid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rigid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rotation_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;cartesian&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid transformation consisting of translation and rotation in 3D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        6 item list, containing the x, y, and z translations and rotations</span>
<span class="sd">        :code:`[t0, t1, t2, alpha, beta, gamma]`, where angles are specified in radians</span>
<span class="sd">        and displacements are specified in pixels.</span>
<span class="sd">    center : list or np.ndarary, optional</span>
<span class="sd">        Reference point for the rotation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        Affine transformation matrix (shape=(4,4))</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">R3d</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="n">rotation_order</span><span class="o">=</span><span class="n">rotation_order</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="n">rotation_mode</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">t</span><span class="nd">@r</span>
    
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="similarity2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.similarity2d.html#mymesh.register.similarity2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">similarity2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotation_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;cartesian&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similarity transform in 2D.</span>

<span class="sd">    The similairy transform consists of a rigid transformation combined with </span>
<span class="sd">    uniform scalings</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        4 item list, containing the x and y translations and rotation about z, and uniform scaling :code:`[t0, t1, theta, s]`, where angles are specified in radians.</span>
<span class="sd">    center : list or np.ndarary, optional</span>
<span class="sd">        Reference point for the rotation</span>
<span class="sd">    rotation_order : array_like, optional</span>
<span class="sd">        Order to perform rotations about the x (0), y (1), and z (2) axes,  by</span>
<span class="sd">        default [0,1,2]</span>
<span class="sd">    image : bool, optional</span>
<span class="sd">        Create a transformation matrix for an image, assuming the (0,1) dimensions correspond to (y,x), by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        Affine transformation matrix (shape=(3,3))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">s0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">s0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">R2d</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="n">rotation_order</span><span class="o">=</span><span class="n">rotation_order</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="n">rotation_mode</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">S2d</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">s</span><span class="nd">@t@r</span>
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="similarity">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.similarity.html#mymesh.register.similarity">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">similarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotation_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;cartesian&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similarity transform in 3D.</span>

<span class="sd">    The similairy transform consists of a rigid transformation combined with </span>
<span class="sd">    uniform scalings</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        4 item list, containing the x and y translations and rotation about z, and uniform scaling :code:`[t0, t1, t2, alpha, beta, gamma, s]`, where angles are specified in radians.</span>
<span class="sd">    center : list or np.ndarary, optional</span>
<span class="sd">        Reference point for the rotation</span>
<span class="sd">    rotation_order : array_like, optional</span>
<span class="sd">        Order to perform rotations about the x (0), y (1), and z (2) axes,  by</span>
<span class="sd">        default [0,1,2]</span>
<span class="sd">    image : bool, optional</span>
<span class="sd">        Create a transformation matrix for an image, assuming the (0,1,2) dimensions correspond to (z,y,x), by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        Affine transformation matrix (shape=(3,3))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">s0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">s0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">R3d</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="n">rotation_order</span><span class="o">=</span><span class="n">rotation_order</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="n">rotation_mode</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">S3d</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">s</span><span class="nd">@t@r</span>
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="affine2d">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.affine2d.html#mymesh.register.affine2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">affine2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="n">sh10</span><span class="p">,</span><span class="n">sh01</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">sh01</span><span class="p">,</span><span class="n">sh10</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">T2d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">R2d</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">Sh2d</span><span class="p">(</span><span class="n">sh01</span><span class="p">,</span><span class="n">sh10</span><span class="p">,</span><span class="n">reference</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">S2d</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">s</span><span class="nd">@sh@t@r</span>

    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="affine">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.affine.html#mymesh.register.affine">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">affine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rotation_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;cartesian&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="n">sh21</span><span class="p">,</span><span class="n">sh12</span><span class="p">,</span><span class="n">sh20</span><span class="p">,</span><span class="n">sh02</span><span class="p">,</span><span class="n">sh10</span><span class="p">,</span><span class="n">sh01</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">sh01</span><span class="p">,</span><span class="n">sh10</span><span class="p">,</span><span class="n">sh02</span><span class="p">,</span><span class="n">sh20</span><span class="p">,</span><span class="n">sh12</span><span class="p">,</span><span class="n">sh21</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">T3d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">R3d</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="n">rotation_order</span><span class="o">=</span><span class="n">rotation_order</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="n">rotation_mode</span><span class="p">)</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">Sh3d</span><span class="p">(</span><span class="n">sh01</span><span class="p">,</span><span class="n">sh10</span><span class="p">,</span><span class="n">sh02</span><span class="p">,</span><span class="n">sh20</span><span class="p">,</span><span class="n">sh12</span><span class="p">,</span><span class="n">sh21</span><span class="p">,</span><span class="n">reference</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">S3d</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">s</span><span class="nd">@sh@t@r</span>

    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="transform_points">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.transform_points.html#mymesh.register.transform_points">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply transformation matrix to an array of points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points : array_like</span>
<span class="sd">        Array of point coordinates (shape=(n,3)).</span>
<span class="sd">    T : array_like</span>
<span class="sd">        Transformation matrix (either (2,2), (3,3), or (4,4)).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_points : np.ndarray</span>
<span class="sd">        Transformed point coordinates</span>

<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">points</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">TwoD</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">points</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">TwoD</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Points must be 2D or 3D, with shape=(n,2) or (n,3).&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="c1"># Affine matrix for 3D</span>
        <span class="k">if</span> <span class="n">TwoD</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Transformation matrix for 3D point set must have shape (3,3), (4,4).&#39;</span><span class="p">)</span>
        <span class="n">pointsT</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="nd">@np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">new_points</span> <span class="o">=</span> <span class="n">pointsT</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">TwoD</span><span class="p">:</span>
            <span class="c1"># Affine matrix for 2D</span>
            <span class="n">pointsT</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="nd">@np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">new_points</span> <span class="o">=</span> <span class="n">pointsT</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Non-affine matrix for 3D</span>
            <span class="n">new_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="nd">@np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
        <span class="c1"># Non-affine matrix for 2D</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TwoD</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Transformation matrix for 2D point set must have shape (2,2), (3,3).&#39;</span><span class="p">)</span>
        <span class="n">new_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="nd">@np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Transformation matrix must have shape (2,2), (3,3), or (4,4).&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">new_points</span></div>


<div class="viewcode-block" id="transform_image">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.transform_image.html#mymesh.register.transform_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply transformation matrix to an image. This is essentially an interface</span>
<span class="sd">    to `scipy.ndimage.affine_transform &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.affine_transform.html&gt;`_</span>
<span class="sd">    but takes into account the need to invert the transformation matrix for </span>
<span class="sd">    consistency between the &quot;pull&quot; resampling performed by `affine_transform`</span>
<span class="sd">    and the &quot;push&quot; transformations used to transform points. The `options` input</span>
<span class="sd">    allows for inputting any of the keyword arguments used by `affine_transform`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : array_like</span>
<span class="sd">        Image array</span>
<span class="sd">    T : array_like</span>
<span class="sd">        Transformation matrix (either 3x3 or 4x4).</span>
<span class="sd">    options : dict, optional</span>
<span class="sd">        Options to be used by `scipy.ndimage.affine_transform &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.affine_transform.html&gt;`_. If none are</span>
<span class="sd">        provide, all defaults will be used, by default dict(). Common options </span>
<span class="sd">        that may be used are `mode` to allow wrapping (&#39;grid-wrap&#39;) or mirroring </span>
<span class="sd">        (&#39;mirror&#39;) to change what happens when the contents of the image are</span>
<span class="sd">        moved beyond the bounds of the image, and `order` which changes the </span>
<span class="sd">        interpolation order of the transformation (the default is 3, </span>
<span class="sd">        transformations can be performed more efficiently by reducing to 1).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_image : np.ndarray</span>
<span class="sd">        Transformed image array.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">new_image</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">affine_transform</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_image</span></div>

<span class="c1">### Similarity Metrics</span>
<div class="viewcode-block" id="dice">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.dice.html#mymesh.register.dice">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dice</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dice-Sorensen coefficient for measuring the similarity between two binary images or arrays :cite:p:`Dice1945` :cite:p:`Sorensen1948` </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    u : np.ndarray(dtype=bool)</span>
<span class="sd">        Array of binary data (can be any shape)</span>
<span class="sd">    v : np.ndarray(dtype=bool)</span>
<span class="sd">        Array of binary data (can be any shape)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    D : float</span>
<span class="sd">        Dice-Sorensen coefficient in the range [0, 1]. 1 = identical, 0 = no overlap.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">TP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">FP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">FN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">TP</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">TP</span> <span class="o">+</span> <span class="n">FP</span> <span class="o">+</span> <span class="n">FN</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">D</span></div>


<div class="viewcode-block" id="jaccard">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.jaccard.html#mymesh.register.jaccard">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">jaccard</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Jaccard index for measuring the similarity between two binary images or arrays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    u : np.ndarray(dtype=bool)</span>
<span class="sd">        Array of binary data (can be any shape)</span>
<span class="sd">    v : np.ndarray(dtype=bool)</span>
<span class="sd">        Array of binary data (can be any shape)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    J : float</span>
<span class="sd">        Jaccard index in the range [0, 1]. 1 = identical, 0 = no overlap.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">TP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">FP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">FN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">TP</span><span class="o">/</span><span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">FP</span> <span class="o">+</span> <span class="n">FN</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">J</span></div>


<div class="viewcode-block" id="mutual_information">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.mutual_information.html#mymesh.register.mutual_information">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mutual_information</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    
    <span class="n">data1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="c1"># Data masking to disregard empty pixels that appear due to transformation</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">data2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="n">data2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">hist1</span><span class="p">,</span> <span class="n">edges1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">hist1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist1</span><span class="p">)</span> <span class="c1"># probability</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="n">P1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="n">P1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># Entropy ( &gt;0 prevents log of 0)</span>

    <span class="n">hist2</span><span class="p">,</span> <span class="n">edges2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">hist2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist2</span><span class="p">)</span>
    <span class="n">H2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P2</span><span class="p">[</span><span class="n">P2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">P2</span><span class="p">[</span><span class="n">P2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">hist12</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)))</span>
    <span class="n">P12</span> <span class="o">=</span> <span class="n">hist12</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist12</span><span class="p">)</span>
    <span class="n">H12</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P12</span><span class="p">[</span><span class="n">P12</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">P12</span><span class="p">[</span><span class="n">P12</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">MI</span> <span class="o">=</span> <span class="n">H1</span> <span class="o">+</span> <span class="n">H2</span> <span class="o">-</span> <span class="n">H12</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">MI</span></div>


<div class="viewcode-block" id="hausdorff">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.hausdorff.html#mymesh.register.hausdorff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hausdorff</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Directed hausdorff distance between two sets of points. The Hausdorff distance is the</span>
<span class="sd">    largest closest-point distance between two point sets. This is a non-symmetric measure,</span>
<span class="sd">    i.e. hausdorff(points1, points2) != hausdorff(points2, points1).</span>
<span class="sd">    This is a wrapper to scipy.spatial.distance.directed_hausdorff</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points1 : array_like</span>
<span class="sd">        Coordinates of the first point set</span>
<span class="sd">    points2 : array_like</span>
<span class="sd">        Coordinates of the second point set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    d, float</span>
<span class="sd">        Hausdorff distance</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">directed_hausdorff</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="closest_point_MSE">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.closest_point_MSE.html#mymesh.register.closest_point_MSE">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">closest_point_MSE</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">tree1</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mean squared error of the closest point distances between two point sets.</span>
<span class="sd">    This is a non-symmetric measure, </span>
<span class="sd">    i.e. closest_point_MSE(points1, points2) != closest_point_MSE(points2, points1).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points1 : array_like</span>
<span class="sd">        Coordinates of the first point set</span>
<span class="sd">    points2 : array_like</span>
<span class="sd">        Coordinates of the second point set</span>
<span class="sd">    tree1 : scipy.spatial.KDTree, optional</span>
<span class="sd">        Optional pre-computed KDTree structure of points1, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    MSE : float</span>
<span class="sd">        Mean squared error of closest points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tree1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tree1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">points1</span><span class="p">)</span>
    <span class="n">distances</span><span class="p">,</span> <span class="n">paired_indices</span> <span class="o">=</span> <span class="n">tree1</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span>
    <span class="n">MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">distances</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">MSE</span></div>


<div class="viewcode-block" id="symmetric_closest_point_MSE">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.symmetric_closest_point_MSE.html#mymesh.register.symmetric_closest_point_MSE">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">symmetric_closest_point_MSE</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span> <span class="n">tree1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tree2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mean squared error of the closest point distances between two point sets.</span>
<span class="sd">    Unlike :func:`closest_point_MSE`, this is a symmetric measure, </span>
<span class="sd">    i.e. closest_point_MSE(points1, points2) == closest_point_MSE(points2, points1).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points1 : array_like</span>
<span class="sd">        Coordinates of the first point set</span>
<span class="sd">    points2 : array_like</span>
<span class="sd">        Coordinates of the second point set</span>
<span class="sd">    tree1 : scipy.spatial.KDTree, optional</span>
<span class="sd">        Optional pre-computed KDTree structure of points1, by default None.</span>
<span class="sd">        (`tree1 = scipy.spatial.KDTree(points1)`)</span>
<span class="sd">    tree2 : scipy.spatial.KDTree, optional</span>
<span class="sd">        Optional pre-computed KDTree structure of points2, by default None</span>
<span class="sd">        (`tree2 = scipy.spatial.KDTree(points2)`)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    MSE : float</span>
<span class="sd">        Mean squared error of closest points</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">tree1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tree1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">points1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tree2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tree2</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span>
    
    <span class="n">distances1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree1</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span>
    <span class="n">distances2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree2</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">points1</span><span class="p">)</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distances1</span><span class="p">,</span> <span class="n">distances2</span><span class="p">)</span>
    <span class="n">MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">distances</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">MSE</span></div>


<span class="c1">## Feature Detection</span>
<span class="k">def</span><span class="w"> </span><span class="nf">intrinsic_shape_signatures</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">nearest_distances</span> <span class="o">=</span> <span class="n">d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Ignoring the zero distance to self</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nearest_distances</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query_ball_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># if weighted:</span>
    <span class="c1">#     weights = [np.linalg.norm(points[i] - points[query[i]], axis=1) for i in range(len(points))]</span>

    <span class="c1"># else:</span>
    <span class="n">COV</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">query</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">COV</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">diff</span><span class="o">.</span><span class="n">T</span><span class="nd">@diff</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

    <span class="n">COV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span>
    <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span>
    <span class="n">eigsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">eigvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># sort descending</span>
    <span class="n">eigvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">eigvals</span><span class="p">),</span> <span class="n">eigsort</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">),</span> <span class="n">eigsort</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">gamma10</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">eigvals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gamma21</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">eigvals</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">thresh10</span> <span class="o">=</span> <span class="n">thresh21</span> <span class="o">=</span> <span class="mf">0.975</span>

    <span class="n">salience</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">salience</span><span class="p">[(</span><span class="n">eigvals</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">eigvals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">thresh10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">eigvals</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">eigvals</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">thresh21</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    

    <span class="k">return</span>

<span class="c1">### Optimization</span>
<div class="viewcode-block" id="optimize">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.optimize.html#mymesh.register.optimize">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizer_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimization interface for registration. This function interfaces with</span>
<span class="sd">    optimizers from scipy.optimize and pdfo.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objective : callable</span>
<span class="sd">        Objective function that takes a single input, `x`.</span>

<span class="sd">    method : str</span>
<span class="sd">        Optimization algorithm. For the most part, these are direct interfaces </span>
<span class="sd">        to either scipy.optimize or pdfo, however some predefined options are</span>
<span class="sd">        chosen for certain methods.</span>

<span class="sd">        scipy global optimizers:</span>
<span class="sd">        ------------------------</span>
<span class="sd">        These are global optimization methods that see the global minimum</span>
<span class="sd">        of the objective function within specified bounds. The `bounds`</span>
<span class="sd">        input is required for all of these methods.</span>

<span class="sd">        - `&#39;direct&#39;`: Uses the DIRECT algorithm through :func:`scipy.optimize.direct`.</span>

<span class="sd">        - </span>
<span class="sd">            &#39;`directl&#39;`: Uses the locally-biased version DIRECT algorthim through :func:`scipy.optimize.direct`.</span>
<span class="sd">            This is equivalent to using `method=&#39;direct&#39;` with `optimizer_args=dict(locally_biased=True)`.</span>

<span class="sd">        - </span>
<span class="sd">            `&#39;differential_evolution&#39;`: Uses the differential evolution algorithm through :func:`scipy.optimize.differential_evolution`</span>

<span class="sd">        - </span>
<span class="sd">            `&#39;brute&#39;`: Uses a brute force approach, evaluating the function at every point within a multidimensional grid</span>
<span class="sd">            using :func:`scipy.optimize.brute`. It&#39;s recommeded to use the &#39;Ns&#39; option to specify the number of points </span>
<span class="sd">            to sample along each axis (`optimizer_args=dict(Ns=n)`), the default value of 20 may be too high for many</span>
<span class="sd">            registration applications for large datasets. The total number of function evaluations is `Ns**len(x)`.</span>
<span class="sd">            By default, the optional &#39;finish&#39; input, which performs local optimization following the conclusion of the </span>
<span class="sd">            brute force search, is turned off, but can be reactivated with `optimizer_args=dict(finish=True)`</span>

<span class="sd">        scipy local optimizers:</span>
<span class="sd">        -----------------------</span>
<span class="sd">        All minimizers available through :func:`scipy.optimize.minimize` are available. One exception is that, if pdfo</span>
<span class="sd">        is installed, it will be used instead of scipy if `method=&#39;cobyla&#39;`.  If `method=&#39;scipy&#39;` is given, the default</span>
<span class="sd">        optimizer will be chosen by scipy based on the given problem (depends on the presence of bounds or constraints).</span>

<span class="sd">        pdfo local optimizers:</span>
<span class="sd">        ----------------------</span>
<span class="sd">        pdfo, or &quot;Powell&#39;s derivative free optimizers&quot; are a group of algorithms developed by M. J. D. Powell for </span>
<span class="sd">        gradient/derivative free optimization. pdfo offers a scipy-like interface to Powell&#39;s algorithms.</span>

<span class="sd">        - `&#39;uobyqa&#39;`:  Unconstrained Optimization BY Quadratic Approximation</span>
<span class="sd">        </span>
<span class="sd">        - `&#39;newuoa&#39;`: NEW Unconstrained Optimization Algorithm</span>
<span class="sd">        </span>
<span class="sd">        - `&#39;bobyqa&#39;`: Bounded Optimization BY Quadratic Approximation</span>
<span class="sd">        </span>
<span class="sd">        - `&#39;lincoa&#39;`: LINear Constrained Optimization Algorithm</span>
<span class="sd">        </span>
<span class="sd">        - `&#39;cobyla&#39;`: Constrained Optimization BY Linear Approximation</span>


<span class="sd">    x0 : array_like, optional</span>
<span class="sd">        Initial guess for the optimization, by default None. This is required for local, but not global</span>
<span class="sd">        methods.</span>
<span class="sd">    bounds : array_like, list of tuples, optional</span>
<span class="sd">        List of bounds for each parameter, e.g. `[(-1, 1), (-1, 1), ...]`, by default None</span>
<span class="sd">        Bounds are required for some optimizers, particularly the global methods.</span>
<span class="sd">    optimizer_args : dict, optional</span>
<span class="sd">        Additional input arguments to the chosen method, by default None. </span>
<span class="sd">        See available options in the documentation of scipy or pdfo. </span>

<span class="sd">        Example (`method=&#39;nelder-mead&#39;`):</span>
<span class="sd">            `optimizer_args = dict(maxiter=100, fatol=1e-3)`</span>

<span class="sd">        Note that the optional arguments or methods differ. Some have an `options` input, </span>
<span class="sd">        which must be defined within `optimizer_args`</span>
<span class="sd">        Example (`method=&#39;powell&#39;`):</span>
<span class="sd">            `optimizer_args = dict(options=dict(maxiter=100))`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x : np.ndarray</span>
<span class="sd">        Optimized parameters</span>
<span class="sd">    f : float</span>
<span class="sd">        Value of the objective function at the identified optimal parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pdfo</span>
        <span class="n">pdfo_avail</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pdfo_avail</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># default optimizer settings for selected optimizers</span>
    <span class="k">if</span> <span class="n">optimizer_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
            <span class="n">optimizer_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">locally_biased</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimizer_args</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Scipy global optimizers</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;directl&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bounds are required for the &quot;direct&quot; optimizer.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;directl&#39;</span><span class="p">:</span>
            <span class="n">optimizer_args</span><span class="p">[</span><span class="s1">&#39;locally_biased&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizer_args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;differential_evolution&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bounds are required for the &quot;differential_evolution&quot; optimizer.&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizer_args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;brute&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bounds are required for the &quot;brute&quot; optimizer.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;finish&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimizer_args</span><span class="p">:</span>
            <span class="n">optimizer_args</span><span class="p">[</span><span class="s1">&#39;finish&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">optimizer_args</span><span class="p">[</span><span class="s1">&#39;full_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># this is required for output processing</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brute</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizer_args</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># create a result dict to work with the syntax of the other optimizers</span>
        
    <span class="c1"># Scipy local optimizers</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nelder-mead&#39;</span><span class="p">,</span> <span class="s1">&#39;powell&#39;</span><span class="p">,</span> <span class="s1">&#39;cg&#39;</span><span class="p">,</span> <span class="s1">&#39;bfgs&#39;</span><span class="p">,</span> <span class="s1">&#39;newton-cg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;l-bfgs-b&#39;</span><span class="p">,</span> <span class="s1">&#39;tnc&#39;</span><span class="p">,</span> <span class="s1">&#39;cobyqa&#39;</span><span class="p">,</span> <span class="s1">&#39;slsqp&#39;</span><span class="p">,</span> <span class="s1">&#39;trust-constr&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;dogleg&#39;</span><span class="p">,</span> <span class="s1">&#39;trust-ncg&#39;</span><span class="p">,</span> <span class="s1">&#39;trust-exact&#39;</span><span class="p">,</span> <span class="s1">&#39;trust-krylov&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pdfo_avail</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;cobyla&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;x0 is required for the </span><span class="si">{</span><span class="n">method</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1"> optimizer&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;bounds&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimizer_args</span><span class="p">:</span>
            <span class="n">optimizer_args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;scipy&#39;</span><span class="p">:</span>
            <span class="c1"># Use default selection</span>
            <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizer_args</span><span class="p">)</span>
    
    <span class="c1"># Powell derivative-free optimizers (via pdfo)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;uobyqa&#39;</span><span class="p">,</span> <span class="s1">&#39;newuoa&#39;</span><span class="p">,</span> <span class="s1">&#39;bobyqa&#39;</span><span class="p">,</span> <span class="s1">&#39;lincoa&#39;</span><span class="p">,</span> <span class="s1">&#39;cobyla&#39;</span><span class="p">,</span> <span class="s1">&#39;pdfo&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdfo_avail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;For optimization with </span><span class="si">{method:s}</span><span class="s1">, pdfo is required: pip install pdfo&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;x0 is required for the </span><span class="si">{</span><span class="n">method</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1"> optimizer&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;uobyqa&#39;</span><span class="p">,</span> <span class="s1">&#39;newuoa&#39;</span><span class="p">]:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;bounds&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimizer_args</span><span class="p">:</span>
            <span class="n">optimizer_args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>
        
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pdfo&#39;</span><span class="p">:</span>
            <span class="c1"># Use default selection</span>
            <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="n">res</span> <span class="o">=</span> <span class="n">pdfo</span><span class="o">.</span><span class="n">pdfo</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizer_args</span><span class="p">)</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Method &quot;</span><span class="si">{</span><span class="n">method</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">&quot; is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimization was not successful. </span><span class="se">\n</span><span class="s1">Optimizer exited with message &quot;</span><span class="si">{</span><span class="n">message</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span></div>

        
<div class="viewcode-block" id="ImageOverlay">
<a class="viewcode-back" href="../../generated/submodules/mymesh.register.ImageOverlay.html#mymesh.register.ImageOverlay">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ImageOverlay</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate an overlay image. The overlay image will have the same shape as </span>
<span class="sd">    :code:`img1` and :code:`img2` and will have the following values:</span>

<span class="sd">    - 0 : ~(img1 &gt; threshold) &amp; ~(img2 &gt; threshold)</span>
<span class="sd">    </span>
<span class="sd">    - 1 : (img1 &gt; threshold) &amp; ~(img2 &gt; threshold)</span>

<span class="sd">    - 2 : ~(img1 &gt; threshold) &amp; (img2 &gt; threshold)</span>

<span class="sd">    - 3 : (img1 &gt; threshold) &amp; (img2 &gt; threshold)</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img1 : array_like</span>
<span class="sd">        Image array of the fixed image. Two or three dimensional numpy array of image data</span>
<span class="sd">    img2 : array_like</span>
<span class="sd">        image array of the moving image. Two or three dimensional numpy array of image data</span>
<span class="sd">    threshold : NoneType, float, or tuple, optional</span>
<span class="sd">            Threshold value(s) to binarize the images. Images are binarized by `img &gt; threshold`.</span>
<span class="sd">            If given as a float or scalar value, this threshold value is applied to both images.</span>
<span class="sd">            If given as a two-element tuple (or array_like), the first value is applied to `img1`</span>
<span class="sd">            and the second value is paplied to `img2`. If None, the image is assumed to already</span>
<span class="sd">            be binarized (or doesn&#39;t require binarization, depending on which similarity metric</span>
<span class="sd">            is chosen). Images can be binarized arbitrarily, consisting of `True`/`False`, `1`/`0`,</span>
<span class="sd">            `255`/`0`, etc. If the image is not already binarized and no threshold is given, the </span>
<span class="sd">            threshold value will be the midpoint of the range of values for each image (which may</span>
<span class="sd">            not give the intended result). By default, None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    overlay : np.ndarray</span>
<span class="sd">        Image array of the overlay</span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img2</span><span class="p">),</span> <span class="s1">&#39;Images must be the same size.&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;threshold must be defined as a single value or a list/tuple/array of two values (one for each image).&#39;</span>
        <span class="n">threshold1</span><span class="p">,</span> <span class="n">threshold2</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold1</span> <span class="o">=</span> <span class="n">threshold2</span> <span class="o">=</span> <span class="n">threshold</span>
    
    <span class="k">if</span> <span class="n">threshold1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bw1</span> <span class="o">=</span> <span class="n">img1</span> <span class="o">&gt;</span> <span class="n">threshold1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bw1</span> <span class="o">=</span> <span class="n">img1</span>
        
    <span class="k">if</span> <span class="n">threshold2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bw2</span> <span class="o">=</span> <span class="n">img2</span> <span class="o">&gt;</span> <span class="n">threshold2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bw2</span> <span class="o">=</span> <span class="n">img2</span>
    
    <span class="n">overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bw1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">overlay</span><span class="p">[</span><span class="n">bw1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">overlay</span><span class="p">[</span><span class="n">bw2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">overlay</span><span class="p">[</span><span class="n">bw1</span> <span class="o">&amp;</span> <span class="n">bw2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">overlay</span></div>

   
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2023, Timothy O. Josephson.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>