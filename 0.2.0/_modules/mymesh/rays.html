
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mymesh.rays &#8212; MyMesh vdev Manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css?v=572af1d6" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/mymesh.css?v=1e1bb860" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=3ce10a4d"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=4ea706d9"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/mymesh/rays';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://bu-smbl.github.io/mymesh/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="dev" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/mymesh_logo.png" class="logo__image only-light" alt="MyMesh vdev Manual - Home"/>
    <img src="../../_static/mymesh_logo.png" class="logo__image only-dark pst-js-only" alt="MyMesh vdev Manual - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../theory.html">
    Theory Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../theory.html">
    Theory Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../mymesh.html" class="nav-link">mymesh</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">mymesh.rays</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for mymesh.rays</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Created on Tue Feb  1 15:23:07 2022</span>
<span class="c1"># @author: toj</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Ray casting and intersection tests</span>


<span class="sd">.. currentmodule:: mymesh.rays</span>

<span class="sd">Intersection Tests</span>
<span class="sd">==================</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: submodules/</span>

<span class="sd">    RayTriangleIntersection</span>
<span class="sd">    RayTrianglesIntersection</span>
<span class="sd">    RaysTrianglesIntersection</span>
<span class="sd">    RayBoxIntersection</span>
<span class="sd">    RayBoxesIntersection</span>
<span class="sd">    PlaneBoxIntersection</span>
<span class="sd">    PlaneTriangleIntersection</span>
<span class="sd">    PlaneTrianglesIntersection</span>
<span class="sd">    TriangleTriangleIntersection</span>
<span class="sd">    TriangleTriangleIntersectionPt</span>
<span class="sd">    TrianglesTrianglesIntersection</span>
<span class="sd">    TrianglesTrianglesIntersectionPts</span>
<span class="sd">    TriangleBoxIntersection</span>
<span class="sd">    BoxTrianglesIntersection</span>
<span class="sd">    BoxBoxIntersection</span>
<span class="sd">    SegmentSegmentIntersection</span>
<span class="sd">    SegmentsSegmentsIntersection</span>
<span class="sd">    SegmentBox2DIntersection</span>
<span class="sd">    SegmentBoxIntersection</span>
<span class="sd">    RaySegmentIntersection</span>
<span class="sd">    RaySegmentsIntersection</span>
<span class="sd">    RayBoundaryIntersection</span>
<span class="sd">    RaySurfIntersection</span>
<span class="sd">    RaysSurfIntersection</span>
<span class="sd">    RayOctreeIntersection</span>
<span class="sd">    BoundaryBoundaryIntersection</span>
<span class="sd">    SurfSelfIntersection</span>
<span class="sd">    SurfSurfIntersection</span>
<span class="sd">    PlaneSurfIntersection</span>

<span class="sd">Inside/Outside Tests</span>
<span class="sd">====================</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: submodules/</span>

<span class="sd">    PointInBoundary</span>
<span class="sd">    PointInSurf</span>
<span class="sd">    PointsInSurf</span>
<span class="sd">    PointInBox2D</span>
<span class="sd">    PointInBox</span>
<span class="sd">    PointsInVoxel</span>
<span class="sd">    PointInTri</span>
<span class="sd">    PointsInTris</span>
<span class="sd">    PointInTet</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#%%</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">converter</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">delaunay</span><span class="p">,</span> <span class="n">try_njit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="o">,</span><span class="w"> </span><span class="nn">random</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>

<span class="c1">## Intersection Tests:</span>
<div class="viewcode-block" id="RayTriangleIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RayTriangleIntersection.html#mymesh.rays.RayTriangleIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RayTriangleIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">TriCoords</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Möller-Trumbore intersection algorithm to detect whether a ray intersects with a triangle.</span>
<span class="sd">    Möller, T., &amp; Trumbore, B. (2005). Fast, minimum storage ray/triangle intersection. In ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005. https://doi.org/10.1145/1198555.1198746</span>
<span class="sd">    :cite:p:`Moller2005`</span>

<span class="sd">    For multiple triangles, see :func:`RayTrianglesIntersection` and for multiple rays, see</span>
<span class="sd">    :func:`RaysTrianglesIntersection`. </span>
<span class="sd">    </span>
<span class="sd">    When choosing between  :func:`RayTriangleIntersection`,  :func:`RayTrianglesIntersection`, and  :func:`RaysTrianglesIntersection`, one should generally only choose the one that has as much vectorization as is needed, and not more. For example, RayTriangleIntersection will generally be slightly more efficient than  :func:`RayTrianglesIntersection` if only one triangle is being considered, but  :func:`RayTrianglesIntersection` will be significantly faster than using :func:`RayTriangleIntersection` many times within a loop.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for the starting point of the ray.</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector of ray direction. This should, in general, be a unit vector.</span>
<span class="sd">    TriCoords : array_like</span>
<span class="sd">        Coordinates of the three vertices of the triangle in the format</span>
<span class="sd">        ``np.array([[a, b, c], [d, e, f], [g, h, i]])``</span>
<span class="sd">    bidirectional : bool, optional</span>
<span class="sd">        Determines whether to check for intersections only the direction the ray is pointing,</span>
<span class="sd">        or in both directions (±ray), by default False.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-6</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersectionPt : np.ndarray or []</span>
<span class="sd">        If there is an intersection, the 3D coordinates of the intersection point</span>
<span class="sd">        are returned, otherwise [] is returned.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. jupyter-execute::</span>

<span class="sd">        from mymesh import rays</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        </span>
<span class="sd">        pt = [0,0,0]</span>
<span class="sd">        ray = np.array([1.,1.,0.])</span>
<span class="sd">        ray /= np.linalg.norm(ray)</span>
<span class="sd">        TriCoords = np.array([</span>
<span class="sd">            [1,0,-1],</span>
<span class="sd">            [0,1,-1],</span>
<span class="sd">            [1,1,1]</span>
<span class="sd">        ])</span>
<span class="sd">        intersection = rays.RayTriangleIntersection(pt, ray, TriCoords)</span>
<span class="sd">        print(intersection)</span>

<span class="sd">    Flipping the direction causes the ray to no longer intersect with the triangle</span>

<span class="sd">    .. jupyter-execute::</span>

<span class="sd">        ray = -ray</span>
<span class="sd">        </span>
<span class="sd">        intersection = rays.RayTriangleIntersection(pt, ray, TriCoords)</span>
<span class="sd">        print(intersection)</span>

<span class="sd">    Using the :code:`bidirectional=True` option detects an intersection with </span>
<span class="sd">    the ray even though it&#39;s pointing in the opposite direction.</span>
<span class="sd">    </span>
<span class="sd">    .. jupyter-execute::</span>

<span class="sd">        intersection = rays.RayTriangleIntersection(pt, ray, TriCoords, bidirectional=True)</span>
<span class="sd">        print(intersection)</span>

<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">edge1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">edge2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">TriCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">edge2</span><span class="p">)</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">edge1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">det</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">det</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">invdet</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">det</span>
    <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">TriCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">edge1</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">edge2</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">intersectionPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span><span class="o">*</span><span class="n">t</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">return</span> <span class="n">intersectionPt</span></div>


<div class="viewcode-block" id="RayTrianglesIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RayTrianglesIntersection.html#mymesh.rays.RayTrianglesIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RayTrianglesIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">Tris</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized Möller-Trumbore intersection algorithm to detect whether a ray intersects with a set of triangles.</span>
<span class="sd">    Möller, T., &amp; Trumbore, B. (2005). Fast, minimum storage ray/triangle intersection. In ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005. https://doi.org/10.1145/1198555.1198746</span>
<span class="sd">    :cite:p:`Moller2005`</span>

<span class="sd">    This is a vectorized form of RayTriangleIntersection for multiple triangles. For multiple rays,</span>
<span class="sd">    see RaysTrianglesIntersection(). </span>
<span class="sd">    </span>
<span class="sd">    When choosing between  :func:`RayTriangleIntersection`,  :func:`RayTrianglesIntersection`, and  :func:`RaysTrianglesIntersection`, one should generally only choose the one that has as much vectorization as is needed, and not more. For example, RayTriangleIntersection will generally be slightly more efficient than  :func:`RayTrianglesIntersection` if only one triangle is being considered, but  :func:`RayTrianglesIntersection` will be significantly faster than using :func:`RayTriangleIntersection` many times within a loop.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for the starting point of the ray.</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector of ray direction. This should, in general, be a unit vector.</span>
<span class="sd">    Tris : array_like</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        ``np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...)``</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    bidirectional : bool, optional</span>
<span class="sd">        Determines whether to check for intersections only the direction the ray is pointing,</span>
<span class="sd">        or in both directions (±ray), by default False.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-14</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersections : np.ndarray</span>
<span class="sd">        Indices of triangles that are intersected by ray.</span>
<span class="sd">    intersectionPts : np.ndarray</span>
<span class="sd">        Coordinates of intersection points for each intersection.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">edge1</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">edge2</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">edge2</span><span class="p">)</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge1</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">invdet</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">det</span>
        <span class="n">tvec</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">-</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tvec</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
        
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span><span class="n">edge1</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ray</span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
        
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge2</span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
        
        <span class="n">checks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">((</span><span class="n">det</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">det</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">))</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">u</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">bidirectional</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">checks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">+</span> <span class="n">ray</span><span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">intersectionPts</span></div>


<div class="viewcode-block" id="RaysTrianglesIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RaysTrianglesIntersection.html#mymesh.rays.RaysTrianglesIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RaysTrianglesIntersection</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="n">Tris</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized Möller-Trumbore intersection algorithm to detect intersections between a pairwise set of rays and a set of triangles.</span>
<span class="sd">    Möller, T., &amp; Trumbore, B. (2005). Fast, minimum storage ray/triangle intersection. In ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005. https://doi.org/10.1145/1198555.1198746</span>
<span class="sd">    :cite:p:`Moller2005`</span>

<span class="sd">    Note:</span>
<span class="sd">        With this version of the intersection test, there must be one ray for each triangle. itertools.combinations can be useful for constructing such a set of pairwise combinations, or see :func:`RaysSurfIntersection` which handles this and can utilize octree acceleration. </span>

<span class="sd">    This is a vectorized form of :func:`RayTriangleIntersection` for multiple triangles. For a single ray with multiple triangles, see :func:`RaysTrianglesIntersection`. </span>
<span class="sd">    </span>
<span class="sd">    When choosing between  :func:`RayTriangleIntersection`, :func:`RayTrianglesIntersection`, and  :func:`RaysTrianglesIntersection`, one should generally only choose the one that has as much vectorization as is needed, and not more. For example, RayTriangleIntersection will generally be slightly more efficient than  :func:`RayTrianglesIntersection` if only one triangle is being considered, but  :func:`RayTrianglesIntersection` will be significantly faster than using :func:`RayTriangleIntersection` many times within a loop.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pts : array_like</span>
<span class="sd">        2D array-like of 3D coordinates for the starting point of the rays.</span>
<span class="sd">        Should have shape (n, 3) for n rays.</span>
<span class="sd">    rays : array_like</span>
<span class="sd">        2D array-like of 3D vectors of ray directions. These should, in general, be unit vectors.</span>
<span class="sd">        Should have shape (n, 3) for n rays.</span>
<span class="sd">    Tris : array_like</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        ``np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...)``.</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    bidirectional : bool, optional</span>
<span class="sd">        Determines whether to check for intersections only in the direction the </span>
<span class="sd">        ray is pointing, or in both directions (±ray), by default False.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-14</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">edge1</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">edge2</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span> <span class="n">edge2</span><span class="p">)</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge1</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">invdet</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">det</span>
        <span class="n">tvec</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">-</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tvec</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
        
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span><span class="n">edge1</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rays</span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
        
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge2</span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">invdet</span>
        
        <span class="n">checks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">((</span><span class="n">det</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">det</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">))</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">u</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">bidirectional</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">checks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span> <span class="o">+</span> <span class="n">rays</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span><span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">intersectionPts</span></div>


<div class="viewcode-block" id="RayBoxIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RayBoxIntersection.html#mymesh.rays.RayBoxIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RayBoxIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">zlim</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection algorithm for detecting intersections between a ray and an axis-aligned box.</span>
<span class="sd">    Williams, A., Barrus, S., Morley, R. K., &amp; Shirley, P. (2005). An efficient and robust ray-box intersection algorithm. ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005, 10(1), 55-60. https://www.doi.org/10.1145/1198555.1198748</span>
<span class="sd">    :cite:p:`Williams2005`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for the starting point of the ray.</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector of ray direction. This should, in general, be a unit vector.</span>
<span class="sd">    xlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower x-direction bounds for an axis-aligned box.</span>
<span class="sd">    ylim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower y-direction bounds for an axis-aligned box.</span>
<span class="sd">    zlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower z-direction bounds for an axis-aligned box.</span>
<span class="sd">    bidirectional : bool, optional</span>
<span class="sd">        Determines whether to check for intersections only in the direction the </span>
<span class="sd">        ray is pointing, or in both directions (±ray), by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection between the ray and the box, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bidirectional</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bidirectional</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tymax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tymax</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmin</span><span class="p">):</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">tymin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tymax</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">tymax</span>
    
    
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bidirectional</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tzmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tzmax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tzmax</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tzmin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="RayBoxesIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RayBoxesIntersection.html#mymesh.rays.RayBoxesIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RayBoxesIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="n">zlims</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized intersection algorithm for detecting intersections between a ray and a set of axis-aligned boxes.</span>
<span class="sd">    Williams, A., Barrus, S., Morley, R. K., &amp; Shirley, P. (2005). An efficient and robust ray-box intersection algorithm. ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005, 10(1), 55-60. https://www.doi.org/10.1145/1198555.1198748</span>
<span class="sd">    :cite:p:`Williams2005`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for the starting point of the ray.</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector of ray direction. This should, in general, be a unit vector.</span>
<span class="sd">    xlims : array_like</span>
<span class="sd">        2D array_like with the upper and lower x-direction bounds for each axis-aligned box. Should have shape (n,2).</span>
<span class="sd">    ylims : array_like</span>
<span class="sd">        2D array_like with the upper and lower y-direction bounds for each axis-aligned box. Should have shape (n,2).</span>
<span class="sd">    zlims : array_like</span>
<span class="sd">        2D array_like with the upper and lower z-direction bounds for each axis-aligned box. Should have shape (n,2).</span>
<span class="sd">    bidirectional : bool, optional</span>
<span class="sd">        Determines whether to check for intersections only in the direction the </span>
<span class="sd">        ray is pointing, or in both directions (±ray), by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersections : np.ndarray()</span>
<span class="sd">        Array of booleans, True if there is an intersection between the ray and the box, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">xlims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
    <span class="n">ylims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ylims</span><span class="p">)</span>
    <span class="n">zlims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">zlims</span><span class="p">)</span>
    <span class="n">intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xlims</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlims</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlims</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlims</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="c1"># tmin[np.isnan(tmin)] = 0</span>
            <span class="c1"># tmax[np.isnan(tmax)] = 0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">intersections</span><span class="p">[(</span><span class="n">tmin</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tmax</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylims</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylims</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">tymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylims</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">tymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="c1"># tymin[np.isnan(tymin)] = 0</span>
            <span class="c1"># tymax[np.isnan(tymax)] = 0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">intersections</span><span class="p">[(</span><span class="n">tymin</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tymax</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">intersections</span><span class="p">[(</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tymax</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># tmin = np.maximum(tymin, tmin)</span>
    <span class="n">tmin</span><span class="p">[</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">tymin</span><span class="p">[</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmin</span><span class="p">]</span>
    <span class="n">tmax</span><span class="p">[</span><span class="n">tymax</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">tymax</span><span class="p">[</span><span class="n">tymax</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">]</span> 
    
    <span class="c1"># tzmin/tzmax only calculated for intersections not already found to be false</span>
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlims</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlims</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlims</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlims</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">tzmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zlims</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">tzmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zlims</span><span class="p">[</span><span class="n">intersections</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="c1"># tzmin[np.isnan(tzmin)] = 0</span>
            <span class="c1"># tzmax[np.isnan(tzmax)] = 0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">zpositive</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">tzmin</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tzmax</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">intersections</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span> <span class="o">=</span> <span class="n">zpositive</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zpositive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tzmin</span><span class="p">))</span>
    
    <span class="n">intersections</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">tmin</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tzmax</span><span class="p">[</span><span class="n">zpositive</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">tzmin</span><span class="p">[</span><span class="n">zpositive</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">[</span><span class="n">intersections</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">intersections</span></div>


<div class="viewcode-block" id="PlaneBoxIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PlaneBoxIntersection.html#mymesh.rays.PlaneBoxIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PlaneBoxIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">Normal</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">zlim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection algorithm for detecting intersections between a plane and an axis-aligned box.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for a point on the plane</span>
<span class="sd">    Normal : array_like</span>
<span class="sd">        3D vector representing the normal vector to the plane</span>
<span class="sd">    xlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower x-direction bounds for an axis-aligned box.</span>
<span class="sd">    ylim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower y-direction bounds for an axis-aligned box.</span>
<span class="sd">    zlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower z-direction bounds for an axis-aligned box.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">BoxCoords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">]</span>
    <span class="c1"># Signed Distances from the vertices of the box to the plane</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Normal</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Normal</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">BoxCoords</span><span class="p">]</span>
    <span class="n">signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># No Intersection, all points on same side of plane</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Intersection, points on different sides of the plane</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">intersection</span></div>

    
<div class="viewcode-block" id="PlaneTriangleIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PlaneTriangleIntersection.html#mymesh.rays.PlaneTriangleIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PlaneTriangleIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">Normal</span><span class="p">,</span> <span class="n">TriCoords</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection test for detecting intersections between a plane and a triangle.</span>

<span class="sd">    An intersection will be detected if points are on different sides of the plane, or if any points lie exactly on the plane.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3 element array, point on plane </span>
<span class="sd">    Normal : array_like</span>
<span class="sd">        3 element array, normal vector to plane </span>
<span class="sd">    TriCoords : array_like</span>
<span class="sd">        Coordinates of the three vertices of the triangle in the format</span>
<span class="sd">        ``np.array([[a, b, c], [d, e, f], [g, h, i]])``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Signed Distances from the vertices of the box to the plane</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Normal</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Normal</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">TriCoords</span><span class="p">]</span>
    <span class="n">signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># No Intersection, all points on same side of plane</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Intersection, points on different sides of the plane</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">intersection</span></div>

    
<div class="viewcode-block" id="PlaneTrianglesIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PlaneTrianglesIntersection.html#mymesh.rays.PlaneTrianglesIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PlaneTrianglesIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">Normal</span><span class="p">,</span> <span class="n">Tris</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized intersection test for detecting intersections between a plane and a set of triangles.</span>

<span class="sd">    An intersection will be detected if points are on different sides of the plane, or if any points lie exactly on the plane. That are a distance +/- eps from the plane will be considered as on the plane.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3 element array, point on plane </span>
<span class="sd">    Normal : array_like</span>
<span class="sd">        3 element array, normal vector to plane </span>
<span class="sd">    Tris : array_like</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...).</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-14</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersections : np.ndarray</span>
<span class="sd">        Array of bools for each triangle, True of there is an intersection, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>   

    <span class="n">Tris</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Tris</span><span class="p">)</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">Normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Normal</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Normal</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Normal</span><span class="o">*</span><span class="n">Tris</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Normal</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">intersections</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">sd</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">sd</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">intersections</span></div>

    
<div class="viewcode-block" id="TriangleTriangleIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.TriangleTriangleIntersection.html#mymesh.rays.TriangleTriangleIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TriangleTriangleIntersection</span><span class="p">(</span><span class="n">Tri1</span><span class="p">,</span><span class="n">Tri2</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span><span class="n">edgeedge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection test for two triangles. </span>

<span class="sd">    Möller, T. (1997). Fast triangle-triangle intersection test. Journal of Graphics Tools, 2(2), 25-30. https://doi.org/10.1080/10867651.1997.10487472</span>
<span class="sd">    :cite:p:`Moller1997`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tri1 : array_like</span>
<span class="sd">        Coordinates of the three vertices of the first triangle in the format</span>
<span class="sd">        ``np.array([[a, b, c], [d, e, f], [g, h, i]])``</span>
<span class="sd">    Tri2 : array_like</span>
<span class="sd">        Coordinates of the three vertices of the second triangle in the format</span>
<span class="sd">        ``np.array([[a, b, c], [d, e, f], [g, h, i]])``</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-14</span>
<span class="sd">    edgeedge : bool, optional</span>
<span class="sd">        If ``edgeedge`` is true, two triangles that meet exactly at the edges will be counted as an intersection, by default False. This inclues two adjacent triangles that share an edge, but also cases where two points of Tri1 lie exactly on the edges of Tri2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Tri1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">Tri1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Tri1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Tri2</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">Tri2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Tri2</span><span class="p">)</span>

    <span class="c1"># Plane2 (N2.X+d2):</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]))</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N2</span><span class="p">,</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    
    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="n">sd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N2</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">d2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">signs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># All vertices of Tri1 are on the same side of Plane2</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sd1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">):</span>
        <span class="c1"># Coplanar</span>
        <span class="c1"># Perform Edge Intersection</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">edges1idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">edges2idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">edges1</span> <span class="o">=</span> <span class="n">Tri1</span><span class="p">[</span><span class="n">edges1idx</span><span class="p">]</span>
        <span class="n">edges2</span> <span class="o">=</span> <span class="n">Tri2</span><span class="p">[</span><span class="n">edges2idx</span><span class="p">]</span>

        <span class="n">intersections</span> <span class="o">=</span> <span class="n">SegmentsSegmentsIntersection</span><span class="p">(</span><span class="n">edges1</span><span class="p">,</span><span class="n">edges2</span><span class="p">,</span><span class="n">return_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">intersections</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Peform point-in-tri test</span>
            <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri1</span><span class="p">,</span> <span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri2</span><span class="p">,</span> <span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Plane1 (N1.X+d1): </span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]))</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    
    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="c1"># sd2 = np.round([np.dot(N1,v)+d1 for v in Tri2],16)</span>
    <span class="n">sd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">d1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri2</span><span class="p">])</span>
    <span class="n">signs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># All vertices of Tri2 are on the same side of Plane1</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Intersection line of Tri1 &amp; Tri2: L = O+tD</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="n">N2</span><span class="p">)</span>
    
    <span class="n">Dmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
    <span class="c1"># Projections of Tri1 to L</span>
    <span class="n">Pv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="n">Dmax</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Projections of Tri2 to L</span>
    <span class="n">Pv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="n">Dmax</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri2</span><span class="p">])</span>

    <span class="c1"># sumzero = np.sum(signs2==0)</span>
    <span class="k">if</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

   
    <span class="n">t11</span><span class="p">,</span><span class="n">t12</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">]),</span><span class="nb">max</span><span class="p">([</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">])</span>
    <span class="n">t21</span><span class="p">,</span><span class="n">t22</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">t21</span><span class="p">,</span><span class="n">t22</span><span class="p">]),</span><span class="nb">max</span><span class="p">([</span><span class="n">t21</span><span class="p">,</span><span class="n">t22</span><span class="p">])</span>
    
    <span class="c1"># if (t12 &lt;= t21 or t22 &lt;= t11) or (t11 == t21 and t12 == t22):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t12</span><span class="o">-</span><span class="n">t21</span> <span class="o">&lt;=</span> <span class="n">eps</span> <span class="ow">or</span> <span class="n">t22</span><span class="o">-</span><span class="n">t11</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="ow">not</span> <span class="n">edgeedge</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t11</span><span class="o">-</span><span class="n">t21</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t12</span><span class="o">-</span><span class="n">t22</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TriangleTriangleIntersectionPt">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.TriangleTriangleIntersectionPt.html#mymesh.rays.TriangleTriangleIntersectionPt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TriangleTriangleIntersectionPt</span><span class="p">(</span><span class="n">Tri1</span><span class="p">,</span><span class="n">Tri2</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">edgeedge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection test for two triangles that returns the point(s) of intersection. </span>

<span class="sd">    Möller, T. (1997). Fast triangle-triangle intersection test. Journal of Graphics Tools, 2(2), 25-30. https://doi.org/10.1080/10867651.1997.10487472</span>
<span class="sd">    :cite:p:`Moller1997`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tri1 : array_like</span>
<span class="sd">        Coordinates of the three vertices of the first triangle in the format</span>
<span class="sd">        ``np.array([[a, b, c], [d, e, f], [g, h, i]])``</span>
<span class="sd">    Tri2 : array_like</span>
<span class="sd">        Coordinates of the three vertices of the second triangle in the format</span>
<span class="sd">        ``np.array([[a, b, c], [d, e, f], [g, h, i]])``</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-14</span>
<span class="sd">    edgeedge : bool, optional</span>
<span class="sd">        If ``edgeedge`` is true, two triangles that meet exactly at the edges will be counted as an intersection, by default False. This inclues two adjacent triangles that share an edge, but also cases where two points of Tri1 lie exactly on the edges of Tri2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    points : array_like</span>
<span class="sd">        Array of points where the two triangles intersect.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="c1"># Plane2 (N2.X+d2):</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N2</span><span class="p">,</span><span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="n">sd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N2</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">d2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">signs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># All vertices of Tri1 are on the same side of Plane2</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sd1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">):</span>
        <span class="c1"># Coplanar</span>
        <span class="c1"># Perform Edge Intersection</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">edges1idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">edges2idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">edges1</span> <span class="o">=</span> <span class="n">Tri1</span><span class="p">[</span><span class="n">edges1idx</span><span class="p">]</span>
        <span class="n">edges2</span> <span class="o">=</span> <span class="n">Tri2</span><span class="p">[</span><span class="n">edges2idx</span><span class="p">]</span>

        <span class="n">intersections</span><span class="p">,</span><span class="n">pts</span> <span class="o">=</span> <span class="n">SegmentsSegmentsIntersection</span><span class="p">(</span><span class="n">edges1</span><span class="p">,</span><span class="n">edges2</span><span class="p">,</span><span class="n">return_intersection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">intersections</span><span class="p">):</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span>
            <span class="c1"># Check if there are any verticies within the triangles</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri1</span><span class="p">,</span> <span class="n">Tri2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">points</span><span class="p">,</span><span class="n">Tri2</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri2</span><span class="p">,</span> <span class="n">Tri1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">points</span><span class="p">,</span><span class="n">Tri1</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">return</span> <span class="n">points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Peform point-in-tri test</span>
            <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri1</span><span class="p">,</span> <span class="n">Tri2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">return</span> <span class="n">Tri2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri2</span><span class="p">,</span> <span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="n">Tri1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
    
    <span class="c1"># Plane1 (N1.X+d1): </span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="n">Tri1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="n">sd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">d1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri2</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">signs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">signs2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># All vertices of Tri2 are on the same side of Plane1</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Intersection line of Tri1 &amp; Tri2: L = O+tD</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="n">N2</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)):</span>
        <span class="n">Ox</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Oy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">d1</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">d2</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">Oz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">d2</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">d1</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)):</span>
        <span class="n">Ox</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">d1</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">d2</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">Oy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Oz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">d2</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">d1</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1">#elif abs(D[2]) == max(np.abs(D)):</span>
        <span class="n">Ox</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">d1</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">d2</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Oy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">d2</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">d1</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Oz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">O</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ox</span><span class="p">,</span><span class="n">Oy</span><span class="p">,</span><span class="n">Oz</span><span class="p">]</span>

    <span class="c1"># Dmax = max(D)</span>
    <span class="c1"># Projections of Tri1 to L</span>
    <span class="c1"># Pv1 = [v[D.index(Dmax)] for v in Tri1]</span>
    <span class="n">Pv1</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">,(</span><span class="n">v</span><span class="o">-</span><span class="n">O</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri1</span><span class="p">]</span>
    

    <span class="k">if</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t12</span> <span class="o">=</span> <span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Projections of Tri2 to L</span>
    <span class="c1"># Pv2 = [v[D.index(Dmax)] for v in Tri2]</span>
    <span class="n">Pv2</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">,(</span><span class="n">v</span><span class="o">-</span><span class="n">O</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Tri2</span><span class="p">]</span>
    <span class="c1"># sumzero = np.sum(signs2==0)</span>
    <span class="k">if</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">signs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t21</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t22</span> <span class="o">=</span> <span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

   
    <span class="n">t11</span><span class="p">,</span><span class="n">t12</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">]),</span><span class="nb">max</span><span class="p">([</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">])</span>
    <span class="n">t21</span><span class="p">,</span><span class="n">t22</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">t21</span><span class="p">,</span><span class="n">t22</span><span class="p">]),</span><span class="nb">max</span><span class="p">([</span><span class="n">t21</span><span class="p">,</span><span class="n">t22</span><span class="p">])</span>
    
    <span class="c1"># if (t12 &lt;= t21 or t22 &lt;= t11) or (t11 == t21 and t12 == t22):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t12</span><span class="o">-</span><span class="n">t21</span> <span class="o">&lt;=</span> <span class="n">eps</span> <span class="ow">or</span> <span class="n">t22</span><span class="o">-</span><span class="n">t11</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="ow">not</span> <span class="n">edgeedge</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t11</span><span class="o">-</span><span class="n">t21</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t12</span><span class="o">-</span><span class="n">t22</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">t1</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">,</span><span class="n">t21</span><span class="p">,</span><span class="n">t22</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">O</span> <span class="o">+</span> <span class="n">t1</span><span class="o">*</span><span class="n">D</span><span class="p">,</span> <span class="n">O</span> <span class="o">+</span> <span class="n">t2</span><span class="o">*</span><span class="n">D</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">edge</span></div>

    
<div class="viewcode-block" id="TrianglesTrianglesIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.TrianglesTrianglesIntersection.html#mymesh.rays.TrianglesTrianglesIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TrianglesTrianglesIntersection</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">,</span><span class="n">Tri2s</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span><span class="n">edgeedge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized intersection test for two sets of triangles. </span>

<span class="sd">    Möller, T. (1997). Fast triangle-triangle intersection test. Journal of Graphics Tools, 2(2), 25-30. https://doi.org/10.1080/10867651.1997.10487472</span>
<span class="sd">    :cite:p:`Moller1997`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tri1s : array_like</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        ``np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...)``.</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    Tri2s : array_like</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        ``np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...)``.</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-14</span>
<span class="sd">    edgeedge : bool, optional</span>
<span class="sd">        If ``edgeedge`` is true, two triangles that meet exactly at the edges will be counted as an intersection, by default False. This inclues two adjacent triangles that share an edge, but also cases where two points of Tri1 lie exactly on the edges of Tri2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersections : np.ndarray</span>
<span class="sd">        Array of bools for each pair of triangles. True if there is an intersection, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># TODO: Currently considering coplanar as a non-intersection, need to implement a separate coplanar test</span>
    
    <span class="c1"># Plane2 (N2.X+d2):</span>
    <span class="n">N2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">d2s</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N2s</span><span class="o">*</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="n">sd1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N2s</span><span class="o">*</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">d2s</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">signs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd1s</span><span class="p">)</span>
    
    <span class="c1"># Plane1 (N1.X+d1): </span>
    <span class="n">N1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">d1s</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N1s</span><span class="o">*</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="n">sd2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N1s</span><span class="o">*</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">d1s</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">signs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd2s</span><span class="p">)</span>
    
    <span class="c1"># Intersection line of Tri1 &amp; Tri2: L = O+tD</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">N1s</span><span class="p">,</span><span class="n">N2s</span><span class="p">)</span>
    <span class="n">Dmaxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Projections of Tri1 to L</span>
    <span class="n">Pv1s</span> <span class="o">=</span> <span class="n">Tri1s</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)[(</span><span class="n">Ds</span><span class="o">==</span><span class="n">Dmaxs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">Ds</span><span class="o">==</span><span class="n">Dmaxs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Ds</span><span class="o">==</span><span class="n">Dmaxs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">])]</span>
    <span class="c1"># Projections of Tri2 to L</span>
    <span class="n">Pv2s</span> <span class="o">=</span> <span class="n">Tri2s</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)[(</span><span class="n">Ds</span><span class="o">==</span><span class="n">Dmaxs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">Ds</span><span class="o">==</span><span class="n">Dmaxs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Ds</span><span class="o">==</span><span class="n">Dmaxs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">])]</span>

    <span class="n">t11s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">));</span> <span class="n">t12s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">))</span>
    <span class="n">t21s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">));</span> <span class="n">t22s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">))</span>
    
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="c1"># if signs[:,0] == signs[:,2]:</span>

        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> 
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 

        <span class="n">A</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>

        <span class="n">Aa</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">|</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">Bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">|</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Aa</span>
        <span class="n">Cc</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span> <span class="o">|</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Aa</span><span class="o">|</span><span class="n">Bb</span><span class="p">)</span>
        
        <span class="n">t11s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t12s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">t11s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t12s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="n">t11s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t12s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    
    
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> 
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 

        <span class="n">A</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>

        <span class="n">Aa</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">|</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">Bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">|</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Aa</span>
        <span class="n">Cc</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span> <span class="o">|</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Aa</span><span class="o">|</span><span class="n">Bb</span><span class="p">)</span>

        <span class="n">t21s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t22s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">t21s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t22s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="n">t21s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t22s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    
        <span class="n">t11s</span><span class="p">,</span><span class="n">t12s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">t11s</span><span class="p">,</span><span class="n">t12s</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="n">t11s</span><span class="p">,</span><span class="n">t12s</span><span class="p">)</span>
        <span class="n">t21s</span><span class="p">,</span><span class="n">t22s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">t21s</span><span class="p">,</span><span class="n">t22s</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="n">t21s</span><span class="p">,</span><span class="n">t22s</span><span class="p">)</span>
        
        <span class="c1"># Initialize Intersections Array</span>
        <span class="n">Intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">))</span>
        
        <span class="c1"># Perform Checks</span>
        <span class="n">edgeedgebool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">edgeedge</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">signs1</span><span class="p">))</span>
        <span class="n">coplanar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sd1s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs1</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs1</span><span class="o">==-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs2</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs2</span><span class="o">==-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
                 <span class="p">(</span><span class="n">t12s</span><span class="o">-</span><span class="n">t21s</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t22s</span><span class="o">-</span><span class="n">t11s</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="o">|</span> 
                 <span class="p">(</span><span class="o">~</span><span class="n">edgeedgebool</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t11s</span><span class="o">-</span><span class="n">t21s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t12s</span><span class="o">-</span><span class="n">t22s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">)))</span>

        <span class="n">Intersections</span><span class="p">[</span><span class="n">checks</span> <span class="o">|</span> <span class="n">coplanar</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">CoTri1s</span> <span class="o">=</span> <span class="n">Tri1s</span><span class="p">[</span><span class="n">coplanar</span><span class="p">]</span>
        <span class="n">CoTri2s</span> <span class="o">=</span> <span class="n">Tri2s</span><span class="p">[</span><span class="n">coplanar</span><span class="p">]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">edges1idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">edges2idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">edges1</span> <span class="o">=</span> <span class="n">CoTri1s</span><span class="p">[:,</span><span class="n">edges1idx</span><span class="p">]</span>
        <span class="n">edges2</span> <span class="o">=</span> <span class="n">CoTri2s</span><span class="p">[:,</span><span class="n">edges2idx</span><span class="p">]</span>

        <span class="n">coplanar_where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coplanar</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 

        <span class="n">edges1r</span> <span class="o">=</span> <span class="n">edges1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">edges2r</span> <span class="o">=</span> <span class="n">edges2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">intersectionsr</span> <span class="o">=</span> <span class="n">SegmentsSegmentsIntersection</span><span class="p">(</span><span class="n">edges1r</span><span class="p">,</span><span class="n">edges2r</span><span class="p">,</span><span class="n">return_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">intersectionsr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">Intersections</span><span class="p">[</span><span class="n">coplanar_where</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">intersections</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">PtInTriChecks</span> <span class="o">=</span> <span class="n">coplanar_where</span><span class="p">[</span><span class="o">~</span><span class="n">Intersections</span><span class="p">[</span><span class="n">coplanar_where</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">PtInTriChecks</span><span class="p">:</span>
            <span class="c1"># Peform point-in-tri test</span>
            <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Tri2s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">Intersections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTri</span><span class="p">(</span><span class="n">Tri2s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Tri1s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">Intersections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">###</span>
        <span class="c1"># coplanar_intersections = np.repeat(False,len(coplanar))</span>
        <span class="c1"># for i in range(len(edges1)):</span>
        <span class="c1">#     intersections = SegmentsSegmentsIntersection(edges1,edges2,return_intersection=False)</span>
        <span class="c1">#     if any(intersections):</span>
        <span class="c1">#         coplanar_intersections[coplanar_where[i]] = True                </span>
        <span class="c1">#     else:</span>
        <span class="c1">#         # Peform point-in-tri test</span>
        <span class="c1">#         alpha,beta,gamma = utils.BaryTri(Tri1s[coplanar_where[i]], Tri2s[coplanar_where[i]][0])</span>
        <span class="c1">#         if all([alpha&gt;=0,beta&gt;=0,gamma&gt;=0]):</span>
        <span class="c1">#             coplanar_intersections[coplanar_where[i]]  = True</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             alpha,beta,gamma = utils.BaryTri(Tri2s[coplanar_where[i]], Tri1s[coplanar_where[i]][0])</span>
        <span class="c1">#             if all([alpha&gt;=0,beta&gt;=0,gamma&gt;=0]):</span>
        <span class="c1">#                 coplanar_intersections[coplanar_where[i]]  = True</span>
        
    <span class="k">return</span> <span class="n">Intersections</span></div>

    
<div class="viewcode-block" id="TrianglesTrianglesIntersectionPts">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.TrianglesTrianglesIntersectionPts.html#mymesh.rays.TrianglesTrianglesIntersectionPts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TrianglesTrianglesIntersectionPts</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">,</span><span class="n">Tri2s</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span><span class="n">edgeedge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized intersection test for two sets of triangles that returns the intersection point(s) between each pair of triangles. </span>

<span class="sd">    Möller, T. (1997). Fast triangle-triangle intersection test. Journal of Graphics Tools, 2(2), 25-30. https://doi.org/10.1080/10867651.1997.10487472</span>
<span class="sd">    :cite:p:`Moller1997`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tri1s : array_like</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        ``np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...)``.</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    Tri2s : array_like</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        ``np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...)``.</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-14</span>
<span class="sd">    edgeedge : bool, optional</span>
<span class="sd">        If ``edgeedge`` is true, two triangles that meet exactly at the edges will be counted as an intersection, by default False. This inclues two adjacent triangles that share an edge, but also cases where two points of Tri1 lie exactly on the edges of Tri2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersections : np.ndarray</span>
<span class="sd">        Array of bools for each pair of triangles. True if there is an intersection, otherwise False.</span>
<span class="sd">    IntersectionPts : list</span>
<span class="sd">        List of intersection point(s) for each pair of triangle.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># TODO: Currently considering coplanar as a non-intersection, need to implement a separate coplanar test</span>
    
    <span class="c1"># Plane2 (N2.X+d2):</span>
    <span class="n">N2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">d2s</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N2s</span><span class="o">*</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="n">sd1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N2s</span><span class="o">*</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">d2s</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">signs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd1s</span><span class="p">)</span>
    <span class="n">signs1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sd1s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Plane1 (N1.X+d1): </span>
    <span class="n">N1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">d1s</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N1s</span><span class="o">*</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Signed distances from vertices in Tri1 to Plane2:</span>
    <span class="n">sd2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N1s</span><span class="o">*</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">d1s</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">signs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd2s</span><span class="p">)</span>
    <span class="n">signs2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sd2s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Intersection line of Tri1 &amp; Tri2: L = O+tD</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">N1s</span><span class="p">,</span><span class="n">N2s</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span><span class="n">norm</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span><span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">norm</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">],</span><span class="n">out</span><span class="o">=</span><span class="n">Ds</span><span class="p">)</span>
    <span class="c1"># Dmaxs = np.max(Ds,axis=1)</span>
    <span class="n">absDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Ds</span><span class="p">)</span>

    <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">o1</span> <span class="o">=</span> <span class="n">absDs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">absDs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">o2</span> <span class="o">=</span> <span class="n">absDs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">absDs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">o3</span> <span class="o">=</span> <span class="n">absDs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">absDs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">O</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">o1</span><span class="p">)),</span>
                <span class="o">-</span><span class="p">(</span><span class="n">d1s</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">d2s</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>
                <span class="o">-</span><span class="p">(</span><span class="n">d2s</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">d1s</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">O</span><span class="p">[</span><span class="n">o2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="o">-</span><span class="p">(</span><span class="n">d1s</span><span class="p">[</span><span class="n">o2</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">d2s</span><span class="p">[</span><span class="n">o2</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">o2</span><span class="p">)),</span>
                <span class="o">-</span><span class="p">(</span><span class="n">d2s</span><span class="p">[</span><span class="n">o2</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">d1s</span><span class="p">[</span><span class="n">o2</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">O</span><span class="p">[</span><span class="n">o3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="o">-</span><span class="p">(</span><span class="n">d1s</span><span class="p">[</span><span class="n">o3</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">d2s</span><span class="p">[</span><span class="n">o3</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>
                <span class="o">-</span><span class="p">(</span><span class="n">d2s</span><span class="p">[</span><span class="n">o3</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">d1s</span><span class="p">[</span><span class="n">o3</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">N1s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N2s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">N2s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N1s</span><span class="p">[</span><span class="n">o3</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">o3</span><span class="p">))</span>
                <span class="p">])</span><span class="o">.</span><span class="n">T</span>
    
        <span class="c1"># Projections of Tri1 to L</span>
        <span class="n">Pv1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ds</span><span class="o">*</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">O</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Projections of Tri2 to L</span>
        <span class="n">Pv2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ds</span><span class="o">*</span><span class="p">(</span><span class="n">Tri2s</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">O</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

        <span class="n">t11s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">));</span> <span class="n">t12s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">))</span>
        <span class="n">t21s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">));</span> <span class="n">t22s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">))</span>
    
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> 
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 

        <span class="n">A</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>

        <span class="n">Aa</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">|</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">Bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">|</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Aa</span>
        <span class="n">Cc</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span> <span class="o">|</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Aa</span><span class="o">|</span><span class="n">Bb</span><span class="p">)</span>
        
        <span class="n">t11s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t12s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">t11s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t12s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="n">t11s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t12s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd1s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    
    
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> 
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">signs2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> 

        <span class="n">A</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">((</span><span class="n">signs2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">c</span><span class="p">)</span>

        <span class="n">Aa</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">|</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">Bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">|</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Aa</span>
        <span class="n">Cc</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span> <span class="o">|</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Aa</span><span class="o">|</span><span class="n">Bb</span><span class="p">)</span>

        <span class="n">t21s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t22s</span><span class="p">[</span><span class="n">Aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Aa</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">t21s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t22s</span><span class="p">[</span><span class="n">Bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Bb</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="n">t21s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t22s</span><span class="p">[</span><span class="n">Cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Pv2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sd2s</span><span class="p">[</span><span class="n">Cc</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    
        <span class="n">t11s</span><span class="p">,</span><span class="n">t12s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">t11s</span><span class="p">,</span><span class="n">t12s</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="n">t11s</span><span class="p">,</span><span class="n">t12s</span><span class="p">)</span>
        <span class="n">t21s</span><span class="p">,</span><span class="n">t22s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">t21s</span><span class="p">,</span><span class="n">t22s</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="n">t21s</span><span class="p">,</span><span class="n">t22s</span><span class="p">)</span>
        
        <span class="c1"># Initialize Intersections Array</span>
        <span class="n">Intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">))</span>
        
        <span class="c1"># Perform Checks</span>
        <span class="n">coplanar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sd1s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs1</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs1</span><span class="o">==-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs2</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">signs2</span><span class="o">==-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
                 <span class="p">(</span><span class="n">t12s</span><span class="o">-</span><span class="n">t21s</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t22s</span><span class="o">-</span><span class="n">t11s</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">))</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edgeedge</span><span class="p">:</span>
            <span class="n">edgeedgebool</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t11s</span><span class="o">-</span><span class="n">t21s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t12s</span><span class="o">-</span><span class="n">t22s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">)</span>
            <span class="n">Intersections</span><span class="p">[</span><span class="n">checks</span> <span class="o">|</span> <span class="n">edgeedgebool</span> <span class="o">|</span> <span class="n">coplanar</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Intersections</span><span class="p">[</span><span class="n">checks</span> <span class="o">|</span> <span class="n">coplanar</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">IntersectionPts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Intersections</span><span class="p">),</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="c1"># IntersectionPts = [[] for i in range(len(Intersections))]</span>
        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">t11s</span><span class="p">,</span><span class="n">t12s</span><span class="p">,</span><span class="n">t21s</span><span class="p">,</span><span class="n">t22s</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">IntersectionPts</span><span class="p">[</span><span class="n">Intersections</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">O</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span> <span class="o">+</span> <span class="n">t1</span><span class="p">[</span><span class="n">Intersections</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">Ds</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span>
        <span class="n">IntersectionPts</span><span class="p">[</span><span class="n">Intersections</span><span class="p">,</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">O</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span> <span class="o">+</span> <span class="n">t2</span><span class="p">[</span><span class="n">Intersections</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">Ds</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span>
        <span class="c1"># Coplanar checks</span>
        <span class="n">CoTri1s</span> <span class="o">=</span> <span class="n">Tri1s</span><span class="p">[</span><span class="n">coplanar</span><span class="p">];</span> <span class="n">CoTri2s</span> <span class="o">=</span> <span class="n">Tri2s</span><span class="p">[</span><span class="n">coplanar</span><span class="p">]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">edges1idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">edges2idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">edges1</span> <span class="o">=</span> <span class="n">CoTri1s</span><span class="p">[:,</span><span class="n">edges1idx</span><span class="p">]</span>
        <span class="n">edges2</span> <span class="o">=</span> <span class="n">CoTri2s</span><span class="p">[:,</span><span class="n">edges2idx</span><span class="p">]</span>

        <span class="n">coplanar_where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coplanar</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">###</span>
        <span class="n">edges1r</span> <span class="o">=</span> <span class="n">edges1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">edges2r</span> <span class="o">=</span> <span class="n">edges2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">edges2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">intersectionsr</span><span class="p">,</span><span class="n">ptsr</span> <span class="o">=</span> <span class="n">SegmentsSegmentsIntersection</span><span class="p">(</span><span class="n">edges1r</span><span class="p">,</span><span class="n">edges2r</span><span class="p">,</span><span class="n">return_intersection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">intersectionsr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">ptsr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edges1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ptsr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1">###</span>
        <span class="n">edge1_ix</span> <span class="o">=</span> <span class="p">[[],[],[]];</span> <span class="n">edge1_ixpts</span> <span class="o">=</span> <span class="p">[[],[],[]];</span> <span class="n">edge1_ixcount</span> <span class="o">=</span> <span class="p">[[],[],[]]</span>
        <span class="n">edge1_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersections</span><span class="p">[:,</span><span class="mi">0</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">edge1_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersections</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">edge1_ix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersections</span><span class="p">[:,</span><span class="mi">2</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">edge1_ixpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span><span class="c1">#[edge1_ix[0]]</span>
        <span class="n">edge1_ixpts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span><span class="c1">#[edge1_ix[1]]</span>
        <span class="n">edge1_ixpts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span><span class="c1">#[edge1_ix[2]]</span>
        <span class="n">edge1_ixcount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge1_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">edge1_ixcount</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge1_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">edge1_ixcount</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge1_ix</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">edge2_ix</span> <span class="o">=</span> <span class="p">[[],[],[]];</span> <span class="n">edge2_ixpts</span> <span class="o">=</span> <span class="p">[[],[],[]];</span> <span class="n">edge2_ixcount</span> <span class="o">=</span> <span class="p">[[],[],[]]</span>
        <span class="n">edge2_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersections</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]]</span>
        <span class="n">edge2_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersections</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">]]</span>
        <span class="n">edge2_ix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersections</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]]</span>
        <span class="n">edge2_ixpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]]</span><span class="c1">#[edge2_ix[0]]</span>
        <span class="n">edge2_ixpts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">]]</span><span class="c1">#[edge2_ix[1]]</span>
        <span class="n">edge2_ixpts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]]</span><span class="c1">#[edge2_ix[2]]</span>
        <span class="n">edge2_ixcount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge2_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">edge2_ixcount</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge2_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">edge2_ixcount</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge2_ix</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># For edges that only interesect at one point, they way have a point inside the other triangle that needs to be accounted for</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge1_ixcount</span><span class="p">)):</span>
            <span class="n">where1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edge1_ixcount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">es1</span> <span class="o">=</span> <span class="n">edges1</span><span class="p">[</span><span class="n">where1</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span>    <span class="c1"># list of the first edges</span>
            <span class="n">p11s</span> <span class="o">=</span> <span class="n">es1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># First point in the edges</span>
            <span class="n">p12s</span> <span class="o">=</span> <span class="n">es1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># Second point in the edges</span>
            <span class="n">tris1</span> <span class="o">=</span> <span class="n">Tri2s</span><span class="p">[</span><span class="n">coplanar_where</span><span class="p">[</span><span class="n">where1</span><span class="p">]]</span>    <span class="c1"># Corresponding triangle</span>
            <span class="n">In11</span> <span class="o">=</span> <span class="n">PointsInTris</span><span class="p">(</span><span class="n">p11s</span><span class="p">,</span><span class="n">tris1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p11s</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">])</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">In12</span> <span class="o">=</span> <span class="n">PointsInTris</span><span class="p">(</span><span class="n">p12s</span><span class="p">,</span><span class="n">tris1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p12s</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">])</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">nanidx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">[</span><span class="n">nanidx1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">In11</span><span class="p">]],</span><span class="n">nanidx1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">In11</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p11s</span><span class="p">[</span><span class="n">In11</span><span class="p">]</span>
            <span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">[</span><span class="n">nanidx1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">In12</span><span class="o">&amp;~</span><span class="n">In11</span><span class="p">]],</span><span class="n">nanidx1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">In12</span><span class="o">&amp;~</span><span class="n">In11</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p12s</span><span class="p">[</span><span class="n">In12</span><span class="o">&amp;~</span><span class="n">In11</span><span class="p">]</span>
            <span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">[</span><span class="n">nanidx1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">In12</span><span class="o">&amp;~</span><span class="n">In11</span><span class="p">]],</span><span class="n">nanidx1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">~</span><span class="n">In12</span><span class="o">&amp;~</span><span class="n">In11</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">[</span><span class="o">~</span><span class="n">In12</span><span class="o">&amp;~</span><span class="n">In11</span><span class="p">]][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">edge1_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where1</span><span class="p">[</span><span class="o">~</span><span class="n">In12</span><span class="o">&amp;~</span><span class="n">In11</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="c1">#</span>
            <span class="n">where2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edge2_ixcount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">es2</span> <span class="o">=</span> <span class="n">edges2</span><span class="p">[</span><span class="n">where2</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span>    <span class="c1"># list of the first edges</span>
            <span class="n">p21s</span> <span class="o">=</span> <span class="n">es2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># First point in the edges</span>
            <span class="n">p22s</span> <span class="o">=</span> <span class="n">es2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># Second point in the edges</span>
            <span class="n">tris2</span> <span class="o">=</span> <span class="n">Tri1s</span><span class="p">[</span><span class="n">coplanar_where</span><span class="p">[</span><span class="n">where2</span><span class="p">]]</span>    <span class="c1"># Corresponding triangle</span>
            <span class="n">In21</span> <span class="o">=</span> <span class="n">PointsInTris</span><span class="p">(</span><span class="n">p21s</span><span class="p">,</span><span class="n">tris2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p21s</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">])</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">In22</span> <span class="o">=</span> <span class="n">PointsInTris</span><span class="p">(</span><span class="n">p22s</span><span class="p">,</span><span class="n">tris2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p22s</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">])</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">nanidx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">[</span><span class="n">nanidx2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">In21</span><span class="p">]],</span><span class="n">nanidx2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">In21</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p21s</span><span class="p">[</span><span class="n">In21</span><span class="p">]</span>
            <span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">[</span><span class="n">nanidx2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">In22</span><span class="o">&amp;~</span><span class="n">In21</span><span class="p">]],</span><span class="n">nanidx2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">In22</span><span class="o">&amp;~</span><span class="n">In21</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p22s</span><span class="p">[</span><span class="n">In22</span><span class="o">&amp;~</span><span class="n">In21</span><span class="p">]</span>
            <span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">[</span><span class="n">nanidx2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">In22</span><span class="o">&amp;~</span><span class="n">In21</span><span class="p">]],</span><span class="n">nanidx2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">~</span><span class="n">In22</span><span class="o">&amp;~</span><span class="n">In21</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">[</span><span class="o">~</span><span class="n">In22</span><span class="o">&amp;~</span><span class="n">In21</span><span class="p">]][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">edge2_ixpts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">where2</span><span class="p">[</span><span class="o">~</span><span class="n">In22</span><span class="o">&amp;~</span><span class="n">In21</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>


        <span class="c1"># Collect the points so that the intersection edges </span>
        <span class="n">Edge1Stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">edge1_ixpts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edge1_ixpts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edge1_ixpts</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Edge2Stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">edge2_ixpts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edge2_ixpts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">edge2_ixpts</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">DoubleStack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Edge1Stack</span><span class="p">,</span><span class="n">Edge2Stack</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">NewDoubleStack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">DoubleStack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">NewDoubleStack</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">DoubleStack</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DoubleStack</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">DoubleStack</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>

        <span class="n">Intersections</span><span class="p">[</span><span class="n">coplanar_where</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">intersections</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">IntersectionPts</span><span class="p">[</span><span class="n">coplanar_where</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewDoubleStack</span>

        <span class="c1"># Check triangles with no edge intersections to see if one is completely within the other</span>
        <span class="n">PtInTriChecks</span> <span class="o">=</span> <span class="n">coplanar_where</span><span class="p">[</span><span class="o">~</span><span class="n">Intersections</span><span class="p">[</span><span class="n">coplanar_where</span><span class="p">]]</span>
        <span class="n">TwoInOne</span> <span class="o">=</span> <span class="n">PointsInTris</span><span class="p">(</span><span class="n">Tri2s</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Tri1s</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">],</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span><span class="n">inclusive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">OneInTwo</span> <span class="o">=</span> <span class="n">PointsInTris</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Tri2s</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">],</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span><span class="n">inclusive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">Intersections</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">]</span> <span class="o">=</span> <span class="n">OneInTwo</span> <span class="o">|</span> <span class="n">TwoInOne</span>
        <span class="n">IntersectionPts</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">[</span><span class="n">TwoInOne</span><span class="p">],:</span><span class="mi">6</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Tri2s</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">[</span><span class="n">TwoInOne</span><span class="p">]][:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">IntersectionPts</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">[</span><span class="n">OneInTwo</span><span class="p">],:</span><span class="mi">6</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Tri1s</span><span class="p">[</span><span class="n">PtInTriChecks</span><span class="p">[</span><span class="n">OneInTwo</span><span class="p">]][:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>


    <span class="k">return</span> <span class="n">Intersections</span><span class="p">,</span> <span class="n">IntersectionPts</span></div>


<div class="viewcode-block" id="TriangleBoxIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.TriangleBoxIntersection.html#mymesh.rays.TriangleBoxIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TriangleBoxIntersection</span><span class="p">(</span><span class="n">TriCoords</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">zlim</span><span class="p">,</span> <span class="n">TriNormal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BoxCenter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection test for detecting intersections between a triangle and a box.</span>

<span class="sd">    Akenine-Möller, T. (2005). Fast 3D triangle-box overlap testing. ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005. https://doi.org/10.1145/1198555.1198747</span>
<span class="sd">    :cite:p:`Akenine-Moller2005`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    TriCoords : array_like</span>
<span class="sd">        Coordinates of the three vertices of the triangle in the format</span>
<span class="sd">        ``np.array([[a, b, c], [d, e, f], [g, h, i]])``</span>
<span class="sd">    xlim : array_like</span>
<span class="sd">        2 element array of the lower and upper bounds of the box in the x direction ``[xmin, xmax]``</span>
<span class="sd">    ylim : array_like</span>
<span class="sd">        2 element array of the lower and upper bounds of the box in the y direction ``[ymin, ymax]``</span>
<span class="sd">    zlim : array_like</span>
<span class="sd">        2 element array of the lower and upper bounds of the box in the z direction ``[zmin, zmax]``</span>
<span class="sd">    TriNormal : array_like, optional</span>
<span class="sd">        Triangle normal vector, by default None. Will be computed if not provided.</span>
<span class="sd">    BoxCenter : array_like, optional</span>
<span class="sd">        Coordinates of the center of the box, by default None. Will be computed if not provided.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Akenine-Moller (2001) Fast 3D Triangle-Box Overlap Test</span>
    <span class="k">if</span> <span class="n">BoxCenter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">BoxCenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">xlim</span><span class="p">,</span><span class="n">ylim</span><span class="p">,</span><span class="n">zlim</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">TriCoords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">hx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">hy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">hz</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1"># Move triangle so that the box is centered around the origin </span>
    <span class="p">[</span><span class="n">v0</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">TriCoords</span><span class="p">,</span><span class="n">BoxCenter</span><span class="p">)</span>
    
    <span class="c1"># Test the box against the minimal Axis Aligned Bounding Box (AABB) of the tri</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">hx</span> <span class="ow">or</span> <span class="nb">min</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">hx</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">hy</span> <span class="ow">or</span> <span class="nb">min</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">hy</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">hz</span> <span class="ow">or</span> <span class="nb">min</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">hz</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Test the normal of the triangle</span>
    <span class="k">if</span> <span class="n">TriNormal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">TriNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">TriNormal</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">TriNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TriNormal</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TriNormal</span><span class="p">,</span><span class="n">v0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">TriNormal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">TriNormal</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">TriNormal</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Test Axes</span>
    <span class="c1"># a00</span>
    <span class="n">a00</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">f0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">f0</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a00</span><span class="p">)</span>
    <span class="c1"># p1 = np.dot(v1,a00)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span><span class="n">a00</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a00</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a00</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a01</span>
    <span class="n">a01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a01</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">a01</span><span class="p">)</span>
    <span class="c1"># p2 = np.dot(v2,a01)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a01</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a01</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a02</span>
    <span class="n">a02</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a02</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">a02</span><span class="p">)</span>
    <span class="c1"># p2 = np.dot(v2,a02)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a02</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a02</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a10</span>
    <span class="n">a10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a10</span><span class="p">)</span>
    <span class="c1"># p1 = np.dot(v1,a10)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span><span class="n">a10</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a10</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a10</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a11</span>
    <span class="n">a11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a11</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">a11</span><span class="p">)</span>
    <span class="c1"># p2 = np.dot(v2,a11)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a11</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a11</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a12</span>
    <span class="n">a12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">f2</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a12</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">a12</span><span class="p">)</span>
    <span class="c1"># p2 = np.dot(v2,a10)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a12</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a12</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a20</span>
    <span class="n">a20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">f0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">f0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a20</span><span class="p">)</span>
    <span class="c1"># p1 = np.dot(v1,a20)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span><span class="n">a20</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a20</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a20</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a21</span>
    <span class="n">a21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a21</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">a21</span><span class="p">)</span>
    <span class="c1"># p2 = np.dot(v2,a21)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a21</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a21</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># a22</span>
    <span class="n">a22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">f2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">a22</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">a22</span><span class="p">)</span>
    <span class="c1"># p2 = np.dot(v2,a22)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a22</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a22</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BoxTrianglesIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.BoxTrianglesIntersection.html#mymesh.rays.BoxTrianglesIntersection">[docs]</a>
<span class="nd">@try_njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">BoxTrianglesIntersection</span><span class="p">(</span><span class="n">Tris</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">zlim</span><span class="p">,</span> <span class="n">TriNormals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BoxCenter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection test for detecting intersections between a triangle and a box. A vectorized version of :func:`TriangleBoxIntersection` for one box and multiple triangles</span>

<span class="sd">    Akenine-Möller, T. (2005). Fast 3D triangle-box overlap testing. ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005. https://doi.org/10.1145/1198555.1198747</span>
<span class="sd">    :cite:p:`Akenine-Moller2005`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tris : np.ndarray</span>
<span class="sd">        Coordinates of triangle vertices for each triangle in the format</span>
<span class="sd">        np.array([[[a, b, c], [d, e, f], [g, h, i]], [[...],[...],[...]], ...).</span>
<span class="sd">        Should have shape (n,3,3) for n triangles.</span>
<span class="sd">    xlim : np.ndarray</span>
<span class="sd">        2 element array of the lower and upper bounds of the box in the x direction ``[xmin, xmax]``</span>
<span class="sd">    ylim : np.ndarray</span>
<span class="sd">        2 element array of the lower and upper bounds of the box in the y direction ``[ymin, ymax]``</span>
<span class="sd">    zlim : np.ndarray</span>
<span class="sd">        2 element array of the lower and upper bounds of the box in the z direction ``[zmin, zmax]``</span>
<span class="sd">    TriNormal : np.ndarray, optional</span>
<span class="sd">        Triangle normal vector, by default None. Will be computed if not provided.</span>
<span class="sd">    BoxCenter : np.ndarray, optional</span>
<span class="sd">        Coordinates of the center of the box, by default None. Will be computed if not provided.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">BoxCenter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">BoxCenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span> <span class="k">for</span> <span class="n">lim</span> <span class="ow">in</span> <span class="p">(</span><span class="n">xlim</span><span class="p">,</span><span class="n">ylim</span><span class="p">,</span><span class="n">zlim</span><span class="p">)])</span>
    
    <span class="c1"># if type(Tris) is list: Tris = np.array(Tris)</span>
        
    <span class="n">f0</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Tris</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Tris</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">hx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">hy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">hz</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="c1"># Move triangles so that the box is centered around the origin </span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">Tris</span> <span class="o">-</span> <span class="n">BoxCenter</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[:,</span><span class="mi">1</span><span class="p">];</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">TriNormals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">TriNormals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">)</span>
    
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">TriNormals</span><span class="o">*</span><span class="n">v0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">TriNormals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">TriNormals</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">TriNormals</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="c1"># Test Axes</span>
    <span class="c1"># a00</span>
    <span class="n">a00</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f0</span><span class="p">)),</span> <span class="o">-</span><span class="n">f0</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">f0</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a00</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v2</span><span class="o">*</span><span class="n">a00</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a00</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a00</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ps1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
    
    <span class="c1"># a01</span>
    <span class="n">a01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f1</span><span class="p">)),</span> <span class="o">-</span><span class="n">f1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">f1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a01</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">a01</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a01</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a01</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ps2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
    
    <span class="c1"># a02</span>
    <span class="n">a02</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f2</span><span class="p">)),</span> <span class="o">-</span><span class="n">f2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">f2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a02</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">a02</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a02</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a02</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ps3</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
    
    <span class="c1"># a10</span>
    <span class="n">a10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">f0</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f0</span><span class="p">)),</span> <span class="o">-</span><span class="n">f0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a10</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v2</span><span class="o">*</span><span class="n">a10</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r4</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a10</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a10</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ps4</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
    
    <span class="c1"># a11</span>
    <span class="n">a11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">f1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f1</span><span class="p">)),</span> <span class="o">-</span><span class="n">f1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a11</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">a11</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r5</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a11</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a11</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ps5</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
    
    <span class="c1"># a12</span>
    <span class="n">a12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">f2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f2</span><span class="p">)),</span> <span class="o">-</span><span class="n">f2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a12</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">a12</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r6</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a12</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hz</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a12</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ps6</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
    <span class="c1"># a20</span>
    <span class="n">a20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="o">-</span><span class="n">f0</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">f0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f0</span><span class="p">))))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a20</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v2</span><span class="o">*</span><span class="n">a20</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r7</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a20</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a20</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ps7</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
    
    <span class="c1"># a21</span>
    <span class="n">a21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="o">-</span><span class="n">f1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">f1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f1</span><span class="p">))))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a21</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">a21</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r8</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a21</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a21</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ps8</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
    
    <span class="c1"># a22</span>
    <span class="n">a22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="o">-</span><span class="n">f2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">f2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f2</span><span class="p">))))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="o">*</span><span class="n">a22</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">a22</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r9</span> <span class="o">=</span> <span class="n">hx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a22</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">hy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a22</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ps9</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
    
    
    <span class="n">Intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Tris</span><span class="p">))</span>
    
    <span class="n">checks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># Test the box against the minimal Axis Aligned Bounding Box (AABB) of the tri</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">v0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">v1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">v2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">hx</span><span class="p">)</span> <span class="o">|</span> 
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">v0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">v1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">v2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span>  <span class="n">hx</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">v0</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">v1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span><span class="n">v2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">hy</span><span class="p">)</span> <span class="o">|</span> 
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">v0</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">v1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span><span class="n">v2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span>  <span class="n">hy</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">v0</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">v1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]),</span><span class="n">v2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">hz</span><span class="p">)</span> <span class="o">|</span> 
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">v0</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">v1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]),</span><span class="n">v2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span>  <span class="n">hz</span><span class="p">)</span> <span class="o">|</span>
        <span class="c1"># Test normal of the triangle</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r0</span><span class="p">)</span> <span class="o">|</span>
        <span class="c1"># Test Axes</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r1</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r2</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r3</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r4</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r5</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps6</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps6</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r6</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps7</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps7</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r7</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r8</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">*</span><span class="n">ps9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">*</span><span class="n">ps9</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r9</span><span class="p">)</span>
        <span class="p">)</span>
    
    
    <span class="n">Intersections</span><span class="p">[</span><span class="n">checks</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">Intersections</span></div>


<div class="viewcode-block" id="BoxBoxIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.BoxBoxIntersection.html#mymesh.rays.BoxBoxIntersection">[docs]</a>
<span class="nd">@try_njit</span>    
<span class="k">def</span><span class="w"> </span><span class="nf">BoxBoxIntersection</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection of two boxes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    box1 : tuple, array_like</span>
<span class="sd">        Bounds of the first box, formatted as ((xmin, xmax), (ymin, ymax), (zmin, zmax))</span>
<span class="sd">    box2 : tuple, array_like</span>
<span class="sd">        Bounds of the second box, formatted as ((xmin, xmax), (ymin, ymax), (zmin, zmax))</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersection : bool</span>
<span class="sd">        True if the two boxes intersect.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">x1lim</span><span class="p">,</span> <span class="n">y1lim</span><span class="p">,</span> <span class="n">z1lim</span> <span class="o">=</span> <span class="n">box1</span>
    <span class="n">x2lim</span><span class="p">,</span> <span class="n">y2lim</span><span class="p">,</span> <span class="n">z2lim</span> <span class="o">=</span> <span class="n">box2</span>

    <span class="n">xIx</span> <span class="o">=</span> <span class="p">((</span><span class="n">x1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">x1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">x2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">x2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">yIx</span> <span class="o">=</span> <span class="p">((</span><span class="n">y1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">y1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">y2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">y2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">zIx</span> <span class="o">=</span> <span class="p">((</span><span class="n">z1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">z1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">z2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">z1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">z2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">z1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">z2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">z2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">z1lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> \
        <span class="p">((</span><span class="n">z2lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">z1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">z2lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z1lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">Intersection</span> <span class="o">=</span> <span class="n">xIx</span> <span class="ow">and</span> <span class="n">yIx</span> <span class="ow">and</span> <span class="n">zIx</span>

    <span class="k">return</span> <span class="n">Intersection</span></div>


<div class="viewcode-block" id="SegmentSegmentIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.SegmentSegmentIntersection.html#mymesh.rays.SegmentSegmentIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">SegmentSegmentIntersection</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">return_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">endpt_inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect intersections between two line segments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s1 : array_like</span>
<span class="sd">        Coordinates of the two points of the first line segment (shape=(2,3))</span>
<span class="sd">    s2 : array_like</span>
<span class="sd">        Coordinates of the two points of the second line segment (shape=(2,3))</span>
<span class="sd">    return_intersection : bool, optional</span>
<span class="sd">        If True, return the coordinates of the intersection point. If no </span>
<span class="sd">        intersection, np.empty((0,3)) is returned. By default False</span>
<span class="sd">    endpt_inclusive : bool, optional</span>
<span class="sd">        If True, one end point lying exactly on the other segment will be </span>
<span class="sd">        considered an intersection, by default True</span>
<span class="sd">    eps : int, optional</span>
<span class="sd">        Small tolerance parameter, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersection : bool</span>
<span class="sd">        Specifies whether the two line segments intersect</span>
<span class="sd">    pt : np.ndarray, optional</span>
<span class="sd">        Point where the two lines intersect, returned if return_intersection=True.</span>
<span class="sd">        If the two lines don&#39;t intersect, np.empty((0,3)) is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># https://mathworld.wolfram.com/Line-LineIntersection.html</span>
    <span class="c1"># Goldman (1990)</span>
    <span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
    <span class="p">[</span><span class="n">p3</span><span class="p">,</span><span class="n">p4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p4</span><span class="o">-</span><span class="n">p3</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p3</span><span class="o">-</span><span class="n">p1</span>
    <span class="n">axb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="c1"># coplanar test</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">axb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># scalar triple product</span>
        <span class="k">if</span> <span class="n">return_intersection</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pt</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">axbnorm2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">axb</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">axb</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
    
    <span class="k">if</span> <span class="n">endpt_inclusive</span><span class="p">:</span>
        <span class="n">Intersection</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Intersection</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_intersection</span><span class="p">:</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">s</span>
        <span class="k">return</span> <span class="n">Intersection</span><span class="p">,</span> <span class="n">pt</span>

    <span class="k">return</span> <span class="n">Intersection</span></div>


<div class="viewcode-block" id="SegmentsSegmentsIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.SegmentsSegmentsIntersection.html#mymesh.rays.SegmentsSegmentsIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">SegmentsSegmentsIntersection</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">return_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">endpt_inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect intersections between pairs of line segments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s1 : array_like</span>
<span class="sd">        Coordinates of the first set of n line segments (shape=(n,2,3))</span>
<span class="sd">    s2 : array_like</span>
<span class="sd">        Coordinates of the second set of n line segments (shape=(n,2,3))</span>
<span class="sd">    return_intersection : bool, optional</span>
<span class="sd">        If True, return the coordinates of the intersection point. If no </span>
<span class="sd">        intersection, np.empty((0,3)) is returned. By default False</span>
<span class="sd">    endpt_inclusive : bool, optional</span>
<span class="sd">        If True, one end point lying exactly on the other segment will be </span>
<span class="sd">        considered an intersection, by default True</span>
<span class="sd">    eps : int, optional</span>
<span class="sd">        Small tolerance parameter, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersection : bool</span>
<span class="sd">        Specifies whether the two line segments intersect</span>
<span class="sd">    pt : np.ndarray, optional</span>
<span class="sd">        Point where the two lines intersect, returned if return_intersection=True.</span>
<span class="sd">        If the two lines don&#39;t intersect, the coordinates of the returned point </span>
<span class="sd">        is [np.nan, np.nan, np.nan].</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># https://mathworld.wolfram.com/Line-LineIntersection.html</span>
    <span class="c1"># Goldman (1990)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">s1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">s1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p4</span><span class="o">-</span><span class="n">p3</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p3</span><span class="o">-</span><span class="n">p1</span>

    <span class="n">axb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cxb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cxa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axbnorm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axb</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#+ 1e-32</span>

    <span class="n">coplanar_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">axb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># scalar triple product</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cxb</span><span class="o">*</span><span class="n">axb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cxa</span><span class="o">*</span><span class="n">axb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
    <span class="c1"># Collinear: Currently not getting intersection points for perfectly collinear lines</span>
    <span class="k">if</span> <span class="n">endpt_inclusive</span><span class="p">:</span>
        <span class="n">Intersections</span> <span class="o">=</span> <span class="n">coplanar_check</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">## DON&#39;T GET RID OF THE LAST CHECK</span>
        <span class="c1"># Intersections = (0 &lt;= s) &amp; (s &lt;= 1) &amp; (0 &lt;= t) &amp; (t &lt;= 1) &amp; (axbnorm2 &gt; eps**2)</span>
        <span class="c1">###</span>

        <span class="c1"># Collinear = (axbnorm2 &lt;= eps**2)</span>
        <span class="c1"># np.linalg.norm(axb/(np.linalg.norm(a,axis=1)*np.linalg.norm(b,axis=1))[:,None],axis=1)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Intersections</span> <span class="o">=</span> <span class="n">coplanar_check</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_intersection</span><span class="p">:</span>
        <span class="c1">### Without collinear:</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Intersections</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">pts</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="n">Intersections</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="c1">###</span>

        <span class="c1">### With collinear: (TBD)</span>
        <span class="c1"># pts = np.nan*np.ones((len(Intersections),2,3))</span>
        <span class="c1">###</span>
        <span class="k">return</span> <span class="n">Intersections</span><span class="p">,</span> <span class="n">pts</span>
    <span class="k">return</span> <span class="n">Intersections</span></div>


<div class="viewcode-block" id="SegmentBox2DIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.SegmentBox2DIntersection.html#mymesh.rays.SegmentBox2DIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">SegmentBox2DIntersection</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection algorithm for detecting intersections between a ray and an axis-aligned box.</span>
<span class="sd">    Williams, A., Barrus, S., Morley, R. K., &amp; Shirley, P. (2005). An efficient and robust ray-box intersection algorithm. ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005, 10(1), 55-60. https://www.doi.org/10.1145/1198555.1198748</span>
<span class="sd">    :cite:p:`Williams2005`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for the starting point of the ray.</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector of ray direction. This should, in general, be a unit vector.</span>
<span class="sd">    xlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower x-direction bounds for an axis-aligned box.</span>
<span class="sd">    ylim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower y-direction bounds for an axis-aligned box.</span>
<span class="sd">    zlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower z-direction bounds for an axis-aligned box.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection between the ray and the box, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="n">pt</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ray</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">tmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">tymin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tymax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tymax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tymax</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SegmentBoxIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.SegmentBoxIntersection.html#mymesh.rays.SegmentBoxIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">SegmentBoxIntersection</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">zlim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intersection algorithm for detecting intersections between a ray and an axis-aligned box.</span>
<span class="sd">    Williams, A., Barrus, S., Morley, R. K., &amp; Shirley, P. (2005). An efficient and robust ray-box intersection algorithm. ACM SIGGRAPH 2005 Courses, SIGGRAPH 2005, 10(1), 55-60. https://www.doi.org/10.1145/1198555.1198748</span>
<span class="sd">    :cite:p:`Williams2005`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for the starting point of the ray.</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector of ray direction. This should, in general, be a unit vector.</span>
<span class="sd">    xlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower x-direction bounds for an axis-aligned box.</span>
<span class="sd">    ylim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower y-direction bounds for an axis-aligned box.</span>
<span class="sd">    zlim : array_like</span>
<span class="sd">        Two element list, array, or tuple with the upper and lower z-direction bounds for an axis-aligned box.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection : bool</span>
<span class="sd">        True if there is an intersection between the ray and the box, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">pt</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ray</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">divx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">tmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">divy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">tymin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tymax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tymax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tymax</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">&gt;</span> <span class="n">tmin</span><span class="p">):</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">tymin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tymax</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">tymax</span>
    
    
    <span class="k">if</span> <span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
    <span class="k">elif</span> <span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">divz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">divz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tzmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">tzmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">tzmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tzmax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">tzmin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tzmax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tzmax</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tzmin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="RaySegmentIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RaySegmentIntersection.html#mymesh.rays.RaySegmentIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RaySegmentIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span><span class="n">return_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">endpt_inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect intersections between a ray and a line segment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for the starting point of the ray.</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector giving the orientation of the ray.</span>
<span class="sd">    segment : array_like</span>
<span class="sd">        Coordinates of the two points of the line segment (shape=(2,3))</span>
<span class="sd">    return_intersection : bool, optional</span>
<span class="sd">        If True, return the coordinates of the intersection point. If no </span>
<span class="sd">        intersection, np.empty((0,3)) is returned. By default False</span>
<span class="sd">    endpt_inclusive : bool, optional</span>
<span class="sd">        If True, one end point lying exactly on the other segment will be </span>
<span class="sd">        considered an intersection, by default True</span>
<span class="sd">    eps : int, optional</span>
<span class="sd">        Small tolerance parameter used when excluding endpoint intersections, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersection : bool</span>
<span class="sd">        Specifies whether the two line segments intersect</span>
<span class="sd">    pt : np.ndarray, optional</span>
<span class="sd">        Point where the two lines intersect, returned if return_intersection=True.</span>
<span class="sd">        If the two lines don&#39;t intersect, np.empty((0,3)) is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">p3</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p4</span><span class="o">-</span><span class="n">p3</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p3</span><span class="o">-</span><span class="n">p1</span>
    <span class="n">axb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="c1"># coplanar test</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">axb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># scalar triple product</span>
        <span class="k">if</span> <span class="n">return_intersection</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pt</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">axbnorm2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">axb</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">axb</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
    
    <span class="k">if</span> <span class="n">endpt_inclusive</span><span class="p">:</span>
        <span class="n">Intersection</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Intersection</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_intersection</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Intersection</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Intersection</span><span class="p">,</span> <span class="n">pt</span>

    <span class="k">return</span> <span class="n">Intersection</span></div>


<div class="viewcode-block" id="RaySegmentsIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RaySegmentsIntersection.html#mymesh.rays.RaySegmentsIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RaySegmentsIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">return_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">endpt_inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect intersections between pairs of line segments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s1 : array_like</span>
<span class="sd">        Coordinates of the first set of n line segments (shape=(n,2,3))</span>
<span class="sd">    s2 : array_like</span>
<span class="sd">        Coordinates of the second set of n line segments (shape=(n,2,3))</span>
<span class="sd">    return_intersection : bool, optional</span>
<span class="sd">        If True, return the coordinates of the intersection point. If no </span>
<span class="sd">        intersection, np.empty((0,3)) is returned. By default False</span>
<span class="sd">    endpt_inclusive : bool, optional</span>
<span class="sd">        If True, one end point lying exactly on the other segment will be </span>
<span class="sd">        considered an intersection, by default True</span>
<span class="sd">    eps : int, optional</span>
<span class="sd">        Small tolerance parameter, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersection : bool</span>
<span class="sd">        Specifies whether the two line segments intersect</span>
<span class="sd">    pt : np.ndarray, optional</span>
<span class="sd">        Point where the two lines intersect, returned if return_intersection=True.</span>
<span class="sd">        If the two lines don&#39;t intersect, the coordinates of the returned point </span>
<span class="sd">        is [np.nan, np.nan, np.nan].</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># https://mathworld.wolfram.com/Line-LineIntersection.html</span>
    <span class="c1"># Goldman (1990)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
    
    <span class="n">p1</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">p3</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p4</span><span class="o">-</span><span class="n">p3</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p3</span><span class="o">-</span><span class="n">p1</span>

    <span class="n">axb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">axbnorm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axb</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#+ 1e-32</span>

    <span class="n">coplanar_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">axb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># scalar triple product</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">axb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">axb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">axbnorm2</span>
    <span class="c1"># Collinear: Currently not getting intersection points for perfectly collinear lines</span>
    <span class="k">if</span> <span class="n">endpt_inclusive</span><span class="p">:</span>
        <span class="n">Intersections</span> <span class="o">=</span> <span class="n">coplanar_check</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Intersections</span> <span class="o">=</span> <span class="n">coplanar_check</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">axbnorm2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_intersection</span><span class="p">:</span>
        <span class="c1">### Without collinear:</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Intersections</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">pts</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">Intersections</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="n">Intersections</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Intersections</span><span class="p">,</span> <span class="n">pts</span>
    <span class="k">return</span> <span class="n">Intersections</span></div>

    
<div class="viewcode-block" id="RayBoundaryIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RayBoundaryIntersection.html#mymesh.rays.RayBoundaryIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RayBoundaryIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">BoundaryConn</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify intersections between a ray and a boundary mesh of line elements. </span>
<span class="sd">    This is generally intended for 2D boundary meshes, though it will work </span>
<span class="sd">    in 3D as well. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D point coordinate (shape = (3,))</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector (shape = (3,))</span>
<span class="sd">    NodeCoords : array_like</span>
<span class="sd">        nx3 list of node coordinates</span>
<span class="sd">    BoundaryConn : array_like</span>
<span class="sd">        List of line element connectivities. This should have shape = (n,2)</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter, by default 1e-14</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersections : np.ndarray</span>
<span class="sd">        Indices of line segment elements that are intersected by ray.</span>
<span class="sd">    distances : np.ndarray</span>
<span class="sd">        Distances between the point and the intersection points.</span>
<span class="sd">    intersectionPts : np.ndarray</span>
<span class="sd">        Coordinates of intersection points for each intersection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">)[</span><span class="n">BoundaryConn</span><span class="p">]</span>
    <span class="n">intersections</span><span class="p">,</span> <span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">RaySegmentsIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">return_intersection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ray</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">intersectionPts</span><span class="o">-</span><span class="n">pt</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">intersectionPts</span></div>


<div class="viewcode-block" id="RaySurfIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RaySurfIntersection.html#mymesh.rays.RaySurfIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RaySurfIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">Octree</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify intersections between a ray and a triangular surface mesh. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D point coordinate (shape = (3,))</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector (shape = (3,))</span>
<span class="sd">    NodeCoords : array_like</span>
<span class="sd">        nx3 list of node coordinates</span>
<span class="sd">    SurfConn : array_like</span>
<span class="sd">        List of surface element connectivities. This should be a strictly</span>
<span class="sd">        triangular mesh. See :func:`~mymesh.converter.surf2tris` for conversion.</span>
<span class="sd">    bidirectional : bool, optional</span>
<span class="sd">        Determines whether to check for intersections only in the direction the </span>
<span class="sd">        ray is pointing, or in both directions (±ray), by default False.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter, by default 1e-14</span>
<span class="sd">    Octree : str, tree.OctreeNode, or NoneType, optional</span>
<span class="sd">        Specify whether to use an octree structure for acceleration of </span>
<span class="sd">        intersection tests. An octree previously contructed using </span>
<span class="sd">        :func:`~mymesh.tree.Surface2Octree` can be used, or one can be</span>
<span class="sd">        generated by default None.</span>

<span class="sd">        - &#39;generate&#39; : Create an octree</span>
<span class="sd">        - &#39;None&#39; or None : Don&#39;t use an octree</span>
<span class="sd">        - tree.OctreeNode : Use this octree</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersections : np.ndarray</span>
<span class="sd">        Indices of triangles that are intersected by ray.</span>
<span class="sd">    distances : np.ndarray</span>
<span class="sd">        Distances between the point and the intersection point.</span>
<span class="sd">    intersectionPts : np.ndarray</span>
<span class="sd">        Coordinates of intersection points for each intersection.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">SurfConn</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">TriConn</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">surf2tris</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">,</span><span class="n">return_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TriConn</span> <span class="o">=</span> <span class="n">SurfConn</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># mixed element surface</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">TriConn</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">surf2tris</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">,</span><span class="n">return_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ArrayCoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">OctreeInputProcessor</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">TriConn</span><span class="p">,</span> <span class="n">Octree</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Won&#39;t use any octree structure to accelerate intersection tests</span>
        <span class="n">intersections</span><span class="p">,</span><span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">RayTrianglesIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">ArrayCoords</span><span class="p">[</span><span class="n">TriConn</span><span class="p">],</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ray</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">intersectionPts</span><span class="o">-</span><span class="n">pt</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Proceeding with octree-accelerated intersection test</span>
        <span class="n">intersection_leaves</span> <span class="o">=</span> <span class="n">RayOctreeIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">)</span> 
        <span class="n">TriIds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">tri</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">intersection_leaves</span> <span class="k">for</span> <span class="n">tri</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
        
        <span class="n">Tris</span> <span class="o">=</span> <span class="n">ArrayCoords</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TriConn</span><span class="p">)[</span><span class="n">TriIds</span><span class="p">]]</span>
        <span class="n">intersections</span><span class="p">,</span><span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">RayTrianglesIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">Tris</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TriIds</span><span class="p">)[</span><span class="n">intersections</span><span class="p">]</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ray</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">intersectionPts</span><span class="o">-</span><span class="n">pt</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">intersections</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">inv</span><span class="p">[</span><span class="n">intersections</span><span class="p">],</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># get element indices from the original surface    </span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">intersectionPts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">intersectionPts</span></div>


<div class="viewcode-block" id="RaysSurfIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RaysSurfIntersection.html#mymesh.rays.RaysSurfIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RaysSurfIntersection</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">Octree</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify intersections between rays and a triangular surface mesh. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pts : array_like</span>
<span class="sd">        3D point coordinates (shape = (m,3))</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vectors (shape = (m,3))</span>
<span class="sd">    NodeCoords : array_like</span>
<span class="sd">        nx3 list of node coordinates</span>
<span class="sd">    SurfConn : array_like</span>
<span class="sd">        List of surface element connectivities. This should be a strictly</span>
<span class="sd">        triangular mesh. See :func:`~mymesh.converter.surf2tris` for conversion.</span>
<span class="sd">    bidirectional : bool</span>
<span class="sd">        Determines whether to check for intersections only in the direction the </span>
<span class="sd">        ray is pointing, or in both directions (±ray), by default False.</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter, by default 1e-14</span>
<span class="sd">    Octree : str, tree.OctreeNode, or NoneType, optional</span>
<span class="sd">        Specify whether to use an octree structure for acceleration of </span>
<span class="sd">        intersection tests. An octree previously constructed using </span>
<span class="sd">        :func:`~mymesh.tree.Surface2Octree` can be used, or one can be</span>
<span class="sd">        generated by default None.</span>

<span class="sd">        - &#39;generate&#39; : Create an octree</span>
<span class="sd">        - &#39;None&#39; or None : Don&#39;t use an octree</span>
<span class="sd">        - tree.OctreeNode : Use this octree</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersections : np.ndarray</span>
<span class="sd">        Indices of triangles that are intersected by ray.</span>
<span class="sd">    distances : np.ndarray</span>
<span class="sd">        Distances between the point and the intersection point.</span>
<span class="sd">    intersectionPts : np.ndarray</span>
<span class="sd">        Coordinates of intersection points for each intersection.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">SurfConn</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nontri</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">TriConn</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">surf2tris</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">,</span><span class="n">return_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nontri</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">TriConn</span> <span class="o">=</span> <span class="n">SurfConn</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># mixed element surface</span>
        <span class="n">nontri</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">TriConn</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">surf2tris</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">,</span><span class="n">return_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ArrayCoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="n">rays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Octree</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="c1"># Won&#39;t use any octree structure to accelerate intersection tests</span>
        <span class="n">inpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">inrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">RayIds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">Tris</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ArrayCoords</span><span class="p">[</span><span class="n">TriConn</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">TriIds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span>
        
        <span class="n">outintersections</span><span class="p">,</span><span class="n">outintersectionPts</span> <span class="o">=</span> <span class="n">RaysTrianglesIntersection</span><span class="p">(</span><span class="n">inpts</span><span class="p">,</span> <span class="n">inrays</span><span class="p">,</span> <span class="n">Tris</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">outdistances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inrays</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">outintersectionPts</span><span class="o">-</span><span class="n">inpts</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;generate&#39;</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">Octree</span><span class="p">)</span> <span class="o">==</span> <span class="n">tree</span><span class="o">.</span><span class="n">OctreeNode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;generate&#39;</span><span class="p">:</span>
            <span class="c1"># Create an octree structure based on the provided structure</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Surface2Octree</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">TriConn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Using an already generated octree structure</span>
            <span class="c1"># If this is the case, it should conform to the same structure and labeling as one generated with tree.Surface2Octree</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">Octree</span>
        <span class="c1"># Proceeding with octree-accelerated intersection test</span>
        <span class="c1"># Assemble pairwise list of rays and tris</span>
        <span class="n">TriIds</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">))]</span>
        <span class="n">RayIds</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="p">)):</span>
            <span class="n">intersection_leaves</span> <span class="o">=</span> <span class="n">RayOctreeIntersection</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rays</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">root</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">)</span> 
            <span class="n">iTris</span> <span class="o">=</span> <span class="p">[</span><span class="n">tri</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">intersection_leaves</span> <span class="k">for</span> <span class="n">tri</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
            <span class="n">TriIds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">iTris</span>
            <span class="n">RayIds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">iTris</span><span class="p">))</span>
        <span class="n">TriIds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">TriIds</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span> <span class="c1"># flattening</span>
        <span class="n">RayIds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">RayIds</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span> <span class="c1"># flattening</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TriIds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No intersections with the octree</span>
            <span class="n">intersections</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="p">))]</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="p">))]</span>
            <span class="n">intersectionPts</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="p">))]</span>

            <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">intersectionPts</span>

        <span class="n">Tris</span> <span class="o">=</span> <span class="n">ArrayCoords</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TriConn</span><span class="p">)[</span><span class="n">TriIds</span><span class="p">]]</span>
        <span class="n">inpts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">RayIds</span><span class="p">]</span>
        <span class="n">inrays</span> <span class="o">=</span> <span class="n">rays</span><span class="p">[</span><span class="n">RayIds</span><span class="p">]</span>
        <span class="n">outintersections</span><span class="p">,</span><span class="n">outintersectionPts</span> <span class="o">=</span> <span class="n">RaysTrianglesIntersection</span><span class="p">(</span><span class="n">inpts</span><span class="p">,</span> <span class="n">inrays</span><span class="p">,</span> <span class="n">Tris</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">outdistances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inrays</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">outintersectionPts</span><span class="o">-</span><span class="n">inpts</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid octree argument given&#39;</span><span class="p">)</span>
        
    <span class="n">spintersections</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">spdistances</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">)))</span>
    <span class="n">spintersectionPtsX</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">)))</span>
    <span class="n">spintersectionPtsY</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">)))</span>
    <span class="n">spintersectionPtsZ</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">TriConn</span><span class="p">)))</span>

    <span class="n">spintersections</span><span class="p">[</span><span class="n">RayIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">],</span><span class="n">TriIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]]</span> <span class="o">=</span> <span class="n">TriIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># +1 so that TriId = 0 doesn&#39;t get lost in sparse</span>
    <span class="n">spdistances</span><span class="p">[</span><span class="n">RayIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">],</span><span class="n">TriIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]]</span> <span class="o">=</span> <span class="n">outdistances</span>
    <span class="n">spintersectionPtsX</span><span class="p">[</span><span class="n">RayIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">],</span><span class="n">TriIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]]</span> <span class="o">=</span> <span class="n">outintersectionPts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spintersectionPtsY</span><span class="p">[</span><span class="n">RayIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">],</span><span class="n">TriIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]]</span> <span class="o">=</span> <span class="n">outintersectionPts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">spintersectionPtsZ</span><span class="p">[</span><span class="n">RayIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">],</span><span class="n">TriIds</span><span class="p">[</span><span class="n">outintersections</span><span class="p">]]</span> <span class="o">=</span> <span class="n">outintersectionPts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">nonzero</span> <span class="o">=</span> <span class="n">spintersections</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
    <span class="n">intersections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]]</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spintersections</span><span class="o">.</span><span class="n">tocsr</span><span class="p">())]</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spdistances</span><span class="o">.</span><span class="n">tocsr</span><span class="p">())]</span>        
    <span class="n">intersectionPts</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]],</span>
                                  <span class="n">y</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]],</span>
                                  <span class="n">z</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nonzero</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]]])</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">spintersectionPtsX</span><span class="o">.</span><span class="n">tocsr</span><span class="p">(),</span>
                                  <span class="n">spintersectionPtsY</span><span class="o">.</span><span class="n">tocsr</span><span class="p">(),</span>
                                  <span class="n">spintersectionPtsZ</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()))]</span>
    
    <span class="k">if</span> <span class="n">nontri</span><span class="p">:</span>
        <span class="c1"># For non-tri input meshes, can end up with redundant intersections because of quad-to tet decomposition</span>
        <span class="c1"># TODO: This may not be the most efficient way to deal with them</span>
        <span class="c1"># NOTE: Handling in this way assumes that the elements are planar and </span>
        <span class="c1"># the redundant intersections are the same point - in theory non planar</span>
        <span class="c1"># elements could have multiple unique intersections with the same element</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intersections</span><span class="p">)):</span>
            <span class="n">intersections</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">inv</span><span class="p">[</span><span class="n">intersections</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># get element indices from the original surface    </span>
            <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">intersectionPts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersectionPts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">intersectionPts</span></div>


<div class="viewcode-block" id="RayOctreeIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.RayOctreeIntersection.html#mymesh.rays.RayOctreeIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RayOctreeIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">Octree</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test for identifying intersections between a ray and an octree.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D point coordinate (shape = (3,))</span>
<span class="sd">    ray : array_like</span>
<span class="sd">        3D vector (shape = (3,))</span>
<span class="sd">    Octree : tree.OctreeNode</span>
<span class="sd">        Root node of the octree data structure</span>
<span class="sd">    bidirectional : bool, optional</span>
<span class="sd">        Determines whether to check for intersections only in the direction the </span>
<span class="sd">        ray is pointing, or in both directions (±ray), by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    intersection_leaves : list</span>
<span class="sd">        List of octree leaf nodes that the ray intersects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">Octree</span>
    <span class="p">[</span><span class="n">xlim</span><span class="p">,</span><span class="n">ylim</span><span class="p">,</span><span class="n">zlim</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">getLimits</span><span class="p">()</span>
    <span class="n">intersection_leaves</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">RayBoxIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">zlim</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">intersection_leaves</span>
    <span class="k">elif</span> <span class="n">root</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;leaf&#39;</span><span class="p">:</span>
        <span class="n">intersection_leaves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intersection_leaves</span>

    <span class="n">children</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">getLimits</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">children</span><span class="p">])</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="n">ylims</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">zlims</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,:]</span>

        <span class="n">intersections</span> <span class="o">=</span> <span class="n">RayBoxesIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="n">zlims</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">)</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span>
        <span class="n">intersection_leaves</span> <span class="o">+=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;leaf&#39;</span><span class="p">]</span>

        <span class="n">children</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">child</span> <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">intersection_leaves</span></div>


<div class="viewcode-block" id="BoundaryBoundaryIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.BoundaryBoundaryIntersection.html#mymesh.rays.BoundaryBoundaryIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">BoundaryBoundaryIntersection</span><span class="p">(</span><span class="n">NodeCoords1</span><span class="p">,</span> <span class="n">BoundaryConn1</span><span class="p">,</span> <span class="n">NodeCoords2</span><span class="p">,</span> <span class="n">BoundaryConn2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_pts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify intersections between two surface meshes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NodeCoords1 : array_like</span>
<span class="sd">        Node coordinates of the first boundary mesh</span>
<span class="sd">    BoundaryConn1 : list, array_like</span>
<span class="sd">        Node connectivity of the first boundary mesh</span>
<span class="sd">    NodeCoords2 : array_like</span>
<span class="sd">        Node coordinates of the second bounday mesh</span>
<span class="sd">    BoundaryConn2 : list, array_like</span>
<span class="sd">        Node connectivity of the second boundary mesh</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter, by default 0, by default 1e-14</span>
<span class="sd">    return_pts : bool, optional</span>
<span class="sd">        If true, will return intersection points, by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Intersections1 : np.ndarray</span>
<span class="sd">        Element ids from the first mesh that intersect with the second</span>
<span class="sd">    Intersections2 : np.ndarray</span>
<span class="sd">        Element ids from the second mesh that intersect with the first</span>
<span class="sd">    IntersectionPoints : np.ndarray, optional</span>
<span class="sd">        Coordinates of intersections (returned if return_pts=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">segments1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">NodeCoords1</span><span class="p">)[</span><span class="n">BoundaryConn1</span><span class="p">]</span>
    <span class="n">segments2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">NodeCoords2</span><span class="p">)[</span><span class="n">BoundaryConn2</span><span class="p">]</span>
    <span class="n">s1idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">segments1</span><span class="p">)),</span><span class="nb">len</span><span class="p">(</span><span class="n">segments2</span><span class="p">))</span>
    <span class="n">s2idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">segments2</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments1</span><span class="p">))</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">segments1</span><span class="p">[</span><span class="n">s1idx</span><span class="p">]</span> <span class="c1"># Pairwise segments from 1 [seg1, seg1, ..., seg2, seg2, ...]</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">segments2</span><span class="p">[</span><span class="n">s2idx</span><span class="p">]</span> <span class="c1"># Pairwise segments from 2 [seg1, seg2, ..., seg1, seg2, ...]</span>

    <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
        <span class="n">Intersections</span><span class="p">,</span> <span class="n">pts</span> <span class="o">=</span> <span class="n">SegmentsSegmentsIntersection</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">return_intersection</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">Intersections</span> <span class="o">=</span> <span class="n">SegmentsSegmentsIntersection</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">return_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">IntersectionIdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Intersections</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Intersections1</span> <span class="o">=</span> <span class="n">s1idx</span><span class="p">[</span><span class="n">IntersectionIdx</span><span class="p">]</span>
    <span class="n">Intersections2</span> <span class="o">=</span> <span class="n">s2idx</span><span class="p">[</span><span class="n">IntersectionIdx</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
        <span class="n">IntersectionPoints</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">IntersectionIdx</span><span class="p">]</span> 
        <span class="k">return</span> <span class="n">Intersections1</span><span class="p">,</span> <span class="n">Intersections2</span><span class="p">,</span> <span class="n">IntersectionPoints</span>
    
    <span class="k">return</span> <span class="n">Intersections1</span><span class="p">,</span> <span class="n">Intersections2</span></div>


<div class="viewcode-block" id="SurfSelfIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.SurfSelfIntersection.html#mymesh.rays.SurfSelfIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">SurfSelfIntersection</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">Octree</span><span class="o">=</span><span class="s1">&#39;generate&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">return_pts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify self intersections in a mesh</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NodeCoords : array_like</span>
<span class="sd">        Node coordinates</span>
<span class="sd">    SurfConn : array_like</span>
<span class="sd">        Node connectivity of a triangular surface mesh</span>
<span class="sd">    Octree : str, tree.OctreeNode, optional</span>
<span class="sd">        Octree node (generated by tree.Surf2Octree), &#39;generate&#39;,</span>
<span class="sd">        or None, by default &#39;generate&#39;. </span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter, by default 1e-14</span>
<span class="sd">    return_pts : bool, optional</span>
<span class="sd">        If true, return the coordinates of intersections, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    IntersectionPairs : np.ndarray</span>
<span class="sd">        Array of indices indicating pairs of elements that interesect each other</span>
<span class="sd">    IntersectionPoints : np.ndarray, optional</span>
<span class="sd">        Coordinates of intersections, returned if return_pts=True.</span>
<span class="sd">        Intersection points are given for each intersection pair in a 3d (n,m,3)</span>
<span class="sd">        array where n = len(IntersectionPairs) and the second axis is padded</span>
<span class="sd">        with np.nan to ensure a rectangular array. </span>

<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">Octree</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="c1"># Won&#39;t use any octree structure to accelerate intersection tests</span>
        <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;generate&#39;</span><span class="p">:</span>
        <span class="c1"># Create an octree structure based on the provided structure</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Surface2Octree</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">Octree</span><span class="p">)</span> <span class="o">==</span> <span class="n">tree</span><span class="o">.</span><span class="n">OctreeNode</span><span class="p">:</span>
        <span class="c1"># Using an already generated octree structure</span>
        <span class="c1"># If this is the case, it should conform to the same structure and labeling as one generated with tree.Surface2Octree</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">Octree</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid Octree argument given: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Octree</span><span class="p">))</span>
    
    <span class="n">Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SurfConn</span><span class="p">)]</span>   
    <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SurfConn</span><span class="p">)),</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combinations</span><span class="p">)</span>
        <span class="n">Tri1s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx1</span><span class="p">)];</span> <span class="n">Tri2s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getAllLeaf</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaves</span><span class="p">:</span>
            <span class="n">combinations</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">leaf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combinations</span><span class="p">)</span>
        <span class="n">Tri1s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx1</span><span class="p">)];</span> <span class="n">Tri2s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
        <span class="n">intersections</span><span class="p">,</span><span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">TrianglesTrianglesIntersectionPts</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">,</span><span class="n">Tri2s</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">IntersectionPairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">combinations</span><span class="p">)[</span><span class="n">intersections</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">IntersectionPoints</span> <span class="o">=</span> <span class="n">intersectionPts</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">IntersectionPairs</span><span class="p">,</span> <span class="n">IntersectionPoints</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">TrianglesTrianglesIntersection</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">,</span><span class="n">Tri2s</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">IntersectionPairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">combinations</span><span class="p">)[</span><span class="n">intersections</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            
    <span class="k">return</span> <span class="n">IntersectionPairs</span></div>

    
<div class="viewcode-block" id="SurfSurfIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.SurfSurfIntersection.html#mymesh.rays.SurfSurfIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">SurfSurfIntersection</span><span class="p">(</span><span class="n">NodeCoords1</span><span class="p">,</span> <span class="n">SurfConn1</span><span class="p">,</span> <span class="n">NodeCoords2</span><span class="p">,</span> <span class="n">SurfConn2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">return_pts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify intersections between two surface meshes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NodeCoords1 : array_like</span>
<span class="sd">        Node coordinates of the first mesh</span>
<span class="sd">    SurfConn1 : list, array_like</span>
<span class="sd">        Node connectivity of the first mesh</span>
<span class="sd">    NodeCoords2 : array_like</span>
<span class="sd">        Node coordinates of the second mesh</span>
<span class="sd">    SurfConn2 : list, array_like</span>
<span class="sd">        Node connectivity of the second mesh</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter, by default 1e-14, by default 1e-14</span>
<span class="sd">    return_pts : bool, optional</span>
<span class="sd">        If true, will return intersection points, by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Surf1Intersections : list</span>
<span class="sd">        Element ids from the first mesh that intersect with the second</span>
<span class="sd">    Surf2Intersections : list</span>
<span class="sd">        Element ids from the second mesh that intersect with the first</span>
<span class="sd">    IntersectionPoints : list, optional</span>
<span class="sd">        Coordinates of intersections (returned if return_pts=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Merge the meshes to get create a single octree representing both</span>
    <span class="n">MergeCoords</span><span class="p">,</span><span class="n">MergeConn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">MergeMesh</span><span class="p">(</span><span class="n">NodeCoords1</span><span class="p">,</span> <span class="n">SurfConn1</span><span class="p">,</span> <span class="n">NodeCoords2</span><span class="p">,</span> <span class="n">SurfConn2</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Surface2Octree</span><span class="p">(</span><span class="n">MergeCoords</span><span class="p">,</span><span class="n">MergeConn</span><span class="p">)</span>
    
    <span class="n">Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">MergeCoords</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">MergeConn</span><span class="p">)]</span>   
    <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MergeConn</span><span class="p">)),</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combinations</span><span class="p">)</span>
        <span class="n">Tri1s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx1</span><span class="p">)];</span> <span class="n">Tri2s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getAllLeaf</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaves</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">leaf</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SurfConn1</span><span class="p">)</span> <span class="c1"># 0 if from Surf1, 1 if from Surf2</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># If there&#39;s only one tri in the octree leaf or if all the triangles are from the same surface, no intersections</span>
                <span class="k">continue</span>
            <span class="n">combinations</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">labels</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">labels</span><span class="p">]))</span>
        
        <span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combinations</span><span class="p">)</span>
        <span class="n">Tri1s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx1</span><span class="p">)];</span> <span class="n">Tri2s</span> <span class="o">=</span> <span class="n">Points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
        <span class="n">intersections</span><span class="p">,</span><span class="n">intersectionPts</span> <span class="o">=</span> <span class="n">TrianglesTrianglesIntersectionPts</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">,</span><span class="n">Tri2s</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span><span class="n">edgeedge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">IntersectionPairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">combinations</span><span class="p">)[</span><span class="n">intersections</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">IPoints</span> <span class="o">=</span> <span class="n">intersectionPts</span><span class="p">[</span><span class="n">intersections</span><span class="p">]</span>
        <span class="n">IPoints</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">IPoints</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="n">IntersectionPoints</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ExtractRagged</span><span class="p">(</span><span class="n">IPoints</span><span class="p">,</span> <span class="n">delval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">Surf1Intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IntersectionPairs</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Surf2Intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IntersectionPairs</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">SurfConn1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Surf1Intersections</span><span class="p">,</span> <span class="n">Surf2Intersections</span><span class="p">,</span> <span class="n">IntersectionPoints</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">TrianglesTrianglesIntersection</span><span class="p">(</span><span class="n">Tri1s</span><span class="p">,</span><span class="n">Tri2s</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span><span class="n">edgeedge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">IntersectionPairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">combinations</span><span class="p">)[</span><span class="n">intersections</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">Surf1Intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IntersectionPairs</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Surf2Intersections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IntersectionPairs</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">SurfConn1</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">Surf1Intersections</span><span class="p">,</span> <span class="n">Surf2Intersections</span></div>


<div class="viewcode-block" id="PlaneSurfIntersection">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PlaneSurfIntersection.html#mymesh.rays.PlaneSurfIntersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PlaneSurfIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">Normal</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">):</span>

    <span class="n">NodeCoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">)</span>
    <span class="n">SurfConn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">SurfConn</span><span class="p">)</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">Normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Normal</span><span class="p">)</span>

    <span class="n">Intersections</span> <span class="o">=</span> <span class="n">PlaneTrianglesIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">Normal</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">[</span><span class="n">SurfConn</span><span class="p">],</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Intersections</span></div>


<span class="c1">## Inside/Outside Tests</span>
<div class="viewcode-block" id="PointInBoundary">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointInBoundary.html#mymesh.rays.PointInBoundary">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PointInBoundary</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">BoundaryConn</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ray</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to determine whether a point is inside a boundary mesh. By default, </span>
<span class="sd">    this test assumes a 2D mesh parallel to the xy plane. For a boundary mesh in</span>
<span class="sd">    another plane, the `ray` argument should be modified. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for point shape=(3,).</span>
<span class="sd">    NodeCoords : array_like</span>
<span class="sd">        List of node coordinates of the surface</span>
<span class="sd">    BoundaryConn : array_like</span>
<span class="sd">        Node connectivity of elements. This function is only valid for triangular surface meshes.</span>
<span class="sd">    ElemNormals : array_like</span>
<span class="sd">        Element normal vectors </span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-8</span>
<span class="sd">    inclusive : bool, optional</span>
<span class="sd">        If True, include points on the boundary (within tolerance `eps`) as </span>
<span class="sd">        inside the boundary.</span>
<span class="sd">    ray : array_like, optional</span>
<span class="sd">        Ray that will be cast to determine whether the point is inside or outside </span>
<span class="sd">        the boundary, by default a random unit vector parallel to the xy plane will be </span>
<span class="sd">        used. For a closed boundary, the choice of ray shouldn&#39;t matter as long</span>
<span class="sd">        as the ray is in the same plane as the boundary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inside : bool</span>
<span class="sd">        True if the point is inside the surface, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="k">if</span> <span class="n">ray</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">ray</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
    <span class="n">intersections</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">RayBoundaryIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">ray</span><span class="p">,</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">BoundaryConn</span><span class="p">)</span>
    <span class="n">posDistances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">distances</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">])</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">)</span>
    
    <span class="c1"># Checking unique to not double count instances where ray intersects an edge</span>
    <span class="k">if</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">uposDistances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">posDistances</span><span class="o">/</span><span class="n">eps</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">uposDistances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">posDistances</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uposDistances</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zero</span><span class="p">:</span>
        <span class="c1"># No intersection</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">inside</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">zero</span> <span class="ow">or</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inclusive</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="n">inside</span></div>


<div class="viewcode-block" id="PointInSurf">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointInSurf.html#mymesh.rays.PointInSurf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PointInSurf</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">ElemNormals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Octree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">ray</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to determine whether a point is inside a surface mesh.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates for point shape=(3,).</span>
<span class="sd">    NodeCoords : array_like</span>
<span class="sd">        List of node coordinates of the surface</span>
<span class="sd">    SurfConn : array_like</span>
<span class="sd">        Node connectivity of elements. This function is only valid for triangular surface meshes.</span>
<span class="sd">    ElemNormals : array_like</span>
<span class="sd">        Element normal vectors </span>
<span class="sd">    Octree : None, str, or tree.octreeNode, optional</span>
<span class="sd">        Determines whether to use/generate an octree data structure for acceleration of the intersection testing, by default None. </span>
<span class="sd">        &#39;generate&#39; - Will generate an octree structure of the surface</span>
<span class="sd">        None - Will not use an octree structure</span>
<span class="sd">        tree.octreeNode - Octree data structure precomputed using :func:`mymesh.tree.Surface2Octree`</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-8</span>
<span class="sd">    ray : array_like, optional</span>
<span class="sd">        Ray that will be cast to determine whether the point is inside or outside the surface, by default np.random.rand(3). For a closed, manifold surface, the choice of ray shouldn&#39;t matter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inside : bool</span>
<span class="sd">        True if the point is inside the surface, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">root</span> <span class="o">=</span> <span class="n">OctreeInputProcessor</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">Octree</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ElemNormals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ElemNormals</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">CalcFaceNormal</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">)</span>
    <span class="n">intersections</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">RaySurfIntersection</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">ray</span><span class="p">,</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">,</span><span class="n">Octree</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>
    <span class="n">posDistances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">distances</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">]</span> <span class="c1">#np.array([d for d in distances if d &gt; eps])</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">)</span>
    
    <span class="c1"># Checking unique to not double count instances where ray intersects an edge</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">posDistances</span><span class="o">/</span><span class="n">eps</span><span class="p">)))</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zero</span><span class="p">:</span>
        <span class="c1"># No intersection</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">inside</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intersections</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">==</span><span class="n">dist</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span><span class="n">ElemNormals</span><span class="p">[</span><span class="n">closest</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">dot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Inside</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">inside</span></div>


<div class="viewcode-block" id="PointsInSurf">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointsInSurf.html#mymesh.rays.PointsInSurf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PointsInSurf</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">ElemNormals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Octree</span><span class="o">=</span><span class="s1">&#39;generate&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">rays</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to determine whether points are inside a surface mesh.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pts : array_like</span>
<span class="sd">        3D coordinates for the points shape=(n,3).</span>
<span class="sd">    NodeCoords : array_like</span>
<span class="sd">        List of node coordinates of the surface</span>
<span class="sd">    SurfConn : array_like</span>
<span class="sd">        Node connectivity of elements. This function is only valid for triangular surface meshes.</span>
<span class="sd">    ElemNormals : array_like, NoneType, optional</span>
<span class="sd">        Element normal vectors. If None are provided, they will be calculated.</span>
<span class="sd">    Octree : None, str, or tree.octreeNode, optional</span>
<span class="sd">        Determines whether to use/generate an octree data structure for acceleration of the intersection testing, by default None. </span>
<span class="sd">        &#39;generate&#39; - Will generate an octree structure of the surface</span>
<span class="sd">        None - Will not use an octree structure</span>
<span class="sd">        tree.octreeNode - Octree data structure precomputed using :func:`mymesh.tree.Surface2Octree`</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small parameter used to determine if a value is sufficiently close to 0, by default 1e-8</span>
<span class="sd">    rays : array_like, optional</span>
<span class="sd">        Rays that will be cast to determine whether the points are inside or outside the surface, by default np.random.rand(3). For a closed, manifold surface, the choice of ray shouldn&#39;t matter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inside : bool</span>
<span class="sd">        True if the point is inside the surface, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="k">if</span> <span class="n">rays</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">rays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">rays</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">SurfConn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">SurfConn</span><span class="p">]):</span>
            <span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">surf2tris</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">)</span>
    <span class="c1"># if ElemNormals is None:</span>
    <span class="c1">#     ElemNormals = utils.CalcFaceNormal(NodeCoords, SurfConn)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">OctreeInputProcessor</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">Octree</span><span class="p">)</span>
    <span class="n">intersections</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">RaysSurfIntersection</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">rays</span><span class="p">,</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">,</span><span class="n">Octree</span><span class="o">=</span><span class="n">root</span><span class="p">)</span> 
    <span class="n">Insides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intersections</span><span class="p">)):</span>
        <span class="n">posDistances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">]</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">posDistances</span><span class="o">/</span><span class="n">eps</span><span class="p">)))</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zero</span><span class="p">:</span>
            <span class="n">Insides</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="c1"># On surface</span>
                <span class="c1"># closest = intersections[i][np.abs(distances[i])==dist][0]</span>
                <span class="c1"># dot = np.dot(rays[i],ElemNormals[closest])</span>
                <span class="c1"># Insides[i] = dot</span>
                <span class="n">Insides</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Inside</span>
                <span class="n">Insides</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">Insides</span></div>


<div class="viewcode-block" id="PointInBox2D">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointInBox2D.html#mymesh.rays.PointInBox2D">[docs]</a>
<span class="nd">@try_njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">PointInBox2D</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test whether a point is inside a 2 dimensional box</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates of a point, shape=(3,)</span>
<span class="sd">    xlim : array_like</span>
<span class="sd">        Lower and upper x limits (e.g. [xmin, xmax])</span>
<span class="sd">    ylim : array_like</span>
<span class="sd">        Lower and upper y limits (e.g. [ymin, ymax])</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inside : bool</span>
<span class="sd">        True if the point is in the box.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">xlim</span><span class="p">,</span><span class="n">ylim</span><span class="p">]</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inclusive</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pt</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pt</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">inside</span></div>


<div class="viewcode-block" id="PointInBox">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointInBox.html#mymesh.rays.PointInBox">[docs]</a>
<span class="nd">@try_njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">PointInBox</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">zlim</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test whether a point is inside a box</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pt : array_like</span>
<span class="sd">        3D coordinates of a point, shape=(3,)</span>
<span class="sd">    xlim : array_like</span>
<span class="sd">        Lower and upper x limits (e.g. [xmin, xmax])</span>
<span class="sd">    ylim : array_like</span>
<span class="sd">        Lower and upper y limits (e.g. [ymin, ymax])</span>
<span class="sd">    zlim : array_like</span>
<span class="sd">        Lower and upper z limits (e.g. [zmin, zmax])</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inside : bool</span>
<span class="sd">        True if the point is in the box.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">xlim</span><span class="p">,</span><span class="n">ylim</span><span class="p">,</span><span class="n">zlim</span><span class="p">]</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inclusive</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pt</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pt</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lims</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">inside</span></div>


<div class="viewcode-block" id="PointsInVoxel">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointsInVoxel.html#mymesh.rays.PointsInVoxel">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PointsInVoxel</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">VoxelCoords</span><span class="p">,</span> <span class="n">VoxelConn</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to determine whether points are inside a voxel mesh</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pts : array_like</span>
<span class="sd">        3D coordinates of points, shape=(n,3)</span>
<span class="sd">    VoxelCoords : array_like</span>
<span class="sd">        Node coordinates of the voxel mesh</span>
<span class="sd">    VoxelConn : array_like</span>
<span class="sd">        Node connectivity of the hexahedral voxel mesh.</span>
<span class="sd">    inclusive : bool, optional</span>
<span class="sd">        Specifies whether points exactly on the boundary should be included, by</span>
<span class="sd">        default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inside : list</span>
<span class="sd">        List of bools specifying whether each point is inside the mesh.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">Root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Voxel2Octree</span><span class="p">(</span><span class="n">VoxelCoords</span><span class="p">,</span> <span class="n">VoxelConn</span><span class="p">)</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pts</span><span class="p">):</span>
        <span class="n">inside</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">isInsideOctree</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">Root</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="n">inclusive</span><span class="p">)</span>    
    
    <span class="k">return</span> <span class="n">inside</span></div>

        
<div class="viewcode-block" id="PointInTri">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointInTri.html#mymesh.rays.PointInTri">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PointInTri</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">Tri</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span><span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to determine whether a point is inside a triangle</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tri : array_like</span>
<span class="sd">        Coordinates of the three vertices of the triangle in the format</span>
<span class="sd">        ``np.array([[x0, y0, z0], [x1, y1, z1], [x2, y2, z2]])`` </span>
<span class="sd">    pt : array_like</span>
<span class="sd">        Coordinates of the point to test </span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter when points are on the edge of a triangle, by default 1e-12</span>
<span class="sd">    inclusive : bool, optional</span>
<span class="sd">        Specifies whether a point on the edge of the triangle should be considered </span>
<span class="sd">        inside, by default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    In : bool</span>
<span class="sd">        True if the point is inside the triangle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">Tri</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">Tri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">Tri</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
    <span class="n">AC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
    <span class="n">PA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
    <span class="n">PB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
    <span class="n">PC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>

    <span class="n">Area2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span><span class="n">AC</span><span class="p">))</span>
    
    <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">Area2</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">PB</span><span class="p">,</span><span class="n">PC</span><span class="p">))</span><span class="o">*</span><span class="n">denom</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">PC</span><span class="p">,</span><span class="n">PA</span><span class="p">))</span><span class="o">*</span><span class="n">denom</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">PA</span><span class="p">,</span><span class="n">PB</span><span class="p">))</span><span class="o">*</span><span class="n">denom</span>
    <span class="k">if</span> <span class="n">inclusive</span><span class="p">:</span>
        <span class="n">In</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="o">+</span><span class="n">gamma</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">eps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">In</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="o">+</span><span class="n">gamma</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">eps</span>
    <span class="k">return</span> <span class="n">In</span></div>


<div class="viewcode-block" id="PointsInTris">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointsInTris.html#mymesh.rays.PointsInTris">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">PointsInTris</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">Tris</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span><span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pairwise inclusion tests between an array of points and an array of triangles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tri : array_like</span>
<span class="sd">        Coordinates of the vertices of the triangles in the format</span>
<span class="sd">        ``np.array([[[x0, y0, z0], [x1, y1, z1], [x2, y2, z2]], ..., ])`` </span>
<span class="sd">    pt : array_like</span>
<span class="sd">        Coordinates of the points to test (shape=(n,3))</span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter when points are on the edge of a triangle, by default 1e-12</span>
<span class="sd">    inclusive : bool, optional</span>
<span class="sd">        Specifies whether a point on the edge of the triangle should be considered </span>
<span class="sd">        inside, by default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    In : np.ndarray</span>
<span class="sd">        True if the point is inside the triangle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Tris</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Tris</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">Tris</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
    <span class="n">AC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
    <span class="n">PA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
    <span class="n">PB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>
    <span class="n">PC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>

    <span class="n">Area2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span><span class="n">AC</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    
    <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">Area2</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">PB</span><span class="p">,</span><span class="n">PC</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">denom</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">PC</span><span class="p">,</span><span class="n">PA</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">denom</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">PA</span><span class="p">,</span><span class="n">PB</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">denom</span>
    <span class="c1"># print(alpha,beta,gamma)</span>
    <span class="k">if</span> <span class="n">inclusive</span><span class="p">:</span>
        <span class="n">In</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="o">+</span><span class="n">gamma</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">In</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">,</span><span class="n">beta</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">,</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="o">+</span><span class="n">gamma</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">In</span></div>


<div class="viewcode-block" id="PointInTet">
<a class="viewcode-back" href="../../generated/submodules/mymesh.rays.PointInTet.html#mymesh.rays.PointInTet">[docs]</a>
<span class="nd">@try_njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">PointInTet</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">Tet</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span><span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to determine whether a point is inside a tetrahedron</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tri : np.ndarray</span>
<span class="sd">        Coordinates of the three vertices of the triangle in the format</span>
<span class="sd">        ``np.array([[x0, y0, z0], [x1, y1, z1], [x2, y2, z2], [x3, y3, z3]],dtype=float)``</span>
<span class="sd">    pt : np.ndarray</span>
<span class="sd">        Coordinates of the point to test </span>
<span class="sd">    eps : float, optional</span>
<span class="sd">        Small tolerance parameter when points are on the face/edge of the tet, by default 1e-12</span>
<span class="sd">    inclusive : bool, optional</span>
<span class="sd">        Specifies whether a point on the edge/face of the tet should be considered </span>
<span class="sd">        inside, by default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    In : bool</span>
<span class="sd">        True if the point is inside the tetrahedron</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">delta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BaryTet</span><span class="p">(</span><span class="n">Tet</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inclusive</span><span class="p">:</span>
      <span class="n">In</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">beta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">delta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="o">+</span><span class="n">gamma</span><span class="o">+</span><span class="n">delta</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">eps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">In</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">beta</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">gamma</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">delta</span><span class="o">&gt;=</span><span class="n">eps</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="o">+</span><span class="n">gamma</span><span class="o">+</span><span class="n">delta</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">eps</span>

    <span class="k">return</span> <span class="n">In</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">OctreeInputProcessor</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span> <span class="n">SurfConn</span><span class="p">,</span> <span class="n">Octree</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">Octree</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="c1"># Won&#39;t use any octree structure to accelerate intersection tests</span>
        <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">Octree</span> <span class="o">==</span> <span class="s1">&#39;generate&#39;</span><span class="p">:</span>
        <span class="c1"># Create an octree structure based on the provided structure</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Surface2Octree</span><span class="p">(</span><span class="n">NodeCoords</span><span class="p">,</span><span class="n">SurfConn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">Octree</span><span class="p">)</span> <span class="o">==</span> <span class="n">tree</span><span class="o">.</span><span class="n">OctreeNode</span><span class="p">:</span>
        <span class="c1"># Using an already generated octree structure</span>
        <span class="c1"># If this is the case, it should conform to the same structure and labeling as one generated with octree.Surface2Octree</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">Octree</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid octree argument given: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Octree</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">root</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023, Timothy O. Josephson.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>